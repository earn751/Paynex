<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiGrip - official</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; color: #1f2937; touch-action: manipulation; }
        .header-bg { background-image: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); }
        .nav-link { transition: color 0.2s, transform 0.2s; }
        .card-shadow { box-shadow: 0 5px 15px -3px rgba(0, 0, 0, 0.1); }
        .bKash-color { background-color: #e2136e; }
        .Nagad-color { background-color: #f6941d; }
        .bKash-color-btn { background-color: #e2136e; }
        .Nagad-color-btn { background-color: #f6941d; }
        .redeem-offer-card {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="p" width="10" height="10" patternUnits="userSpaceOnUse"><circle cx="1" cy="1" r=".5" fill="rgba(255,255,255,0.2)"/></pattern></defs><rect width="100" height="100" fill="url(%23p)"/></svg>');
            background-size: 10px 10px;
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        function show_10087307() {
            return new Promise(resolve => {
                setTimeout(() => {
                    console.log("Monetag Ad Simulated: Success");
                    resolve();
                }, 5000);
            });
        }
    </script>
</head>
<body class="min-h-screen flex flex-col">

    <div id="app" class="flex flex-col flex-grow">
        <div id="loading" class="absolute inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
            <svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-white text-lg">ডাটা লোড হচ্ছে...</p>
        </div>

        <header id="header" class="header-bg text-white p-4 rounded-b-xl shadow-lg transition-all duration-300">
            <div class="flex items-center space-x-4">
                <img id="profile-pic" class="w-12 h-12 rounded-full border-2 border-yellow-400 object-cover" src="https://placehold.co/48x48/6b7280/ffffff?text=U" onerror="this.onerror=null; this.src='https://placehold.co/48x48/6b7280/ffffff?text=U';" alt="Profile">
                <div class="flex-grow">
                    <p class="text-lg font-bold truncate" id="user-name">ইউজার নাম</p>
                    <p class="text-xs text-gray-300 truncate" id="user-uid">UID: 123456789</p>
                </div>
            </div>
            <div class="mt-3 flex items-center justify-between">
                <div class="flex items-baseline space-x-1">
                    <span class="text-3xl font-extrabold text-yellow-300" id="user-coins">0</span>
                    <span class="text-sm font-medium">কয়েন</span>
                </div>
                <div id="tier-badge" class="px-3 py-1 text-sm font-semibold rounded-full bg-gray-500 text-white">Bronze Tier</div>
            </div>
        </header>

        <main class="p-4 flex-grow overflow-y-auto" id="main-content">
            <!-- Redeem Tab -->
            <div id="tab-redeem" class="tab-content" style="display:none;">
                <h2 class="text-xl font-bold mb-4 text-gray-800">কয়েন রিডিম</h2>
                <h3 class="text-lg font-bold text-gray-800 mb-3">bKash অফার</h3>
                <div class="space-y-4 mb-8" id="bKash-offers">
                    <div class="redeem-offer-card bKash-color p-0 rounded-xl card-shadow overflow-hidden">
                        <div class="text-center py-4 px-6"><p class="text-5xl font-extrabold text-white">৳100</p></div>
                        <div class="bg-white p-4 flex justify-between items-center text-gray-800">
                            <div class="flex flex-col">
                                <span class="text-xs font-semibold uppercase text-red-600">bKash</span>
                                <span class="text-sm font-bold">1,000 কয়েনে রিডিম</span>
                            </div>
                            <button data-type="bKash" data-coins="1000" data-amount="100" class="redeem-btn bKash-color-btn text-white font-bold py-2 px-4 rounded-lg transition duration-200">রিডিম</button>
                        </div>
                    </div>
                    <div class="redeem-offer-card bKash-color p-0 rounded-xl card-shadow overflow-hidden">
                        <div class="text-center py-4 px-6"><p class="text-5xl font-extrabold text-white">৳1500</p></div>
                        <div class="bg-white p-4 flex justify-between items-center text-gray-800">
                            <div class="flex flex-col">
                                <span class="text-xs font-semibold uppercase text-red-600">bKash</span>
                                <span class="text-sm font-bold">10,000 কয়েনে রিডিম</span>
                            </div>
                            <button data-type="bKash" data-coins="10000" data-amount="1500" class="redeem-btn bKash-color-btn text-white font-bold py-2 px-4 rounded-lg transition duration-200">রিডিম</button>
                        </div>
                    </div>
                    <div class="redeem-offer-card bKash-color p-0 rounded-xl card-shadow overflow-hidden">
                        <div class="text-center py-4 px-6"><p class="text-5xl font-extrabold text-white">৳3000</p></div>
                        <div class="bg-white p-4 flex justify-between items-center text-gray-800">
                            <div class="flex flex-col">
                                <span class="text-xs font-semibold uppercase text-red-600">bKash</span>
                                <span class="text-sm font-bold">20,000 কয়েনে রিডিম</span>
                            </div>
                            <button data-type="bKash" data-coins="20000" data-amount="3000" class="redeem-btn bKash-color-btn text-white font-bold py-2 px-4 rounded-lg transition duration-200">রিডিম</button>
                        </div>
                    </div>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-3 mt-6">Nagad অফার</h3>
                <div class="space-y-4" id="Nagad-offers">
                    <div class="redeem-offer-card Nagad-color p-0 rounded-xl card-shadow overflow-hidden">
                        <div class="text-center py-4 px-6"><p class="text-5xl font-extrabold text-white">৳100</p></div>
                        <div class="bg-white p-4 flex justify-between items-center text-gray-800">
                            <div class="flex flex-col">
                                <span class="text-xs font-semibold uppercase text-yellow-600">Nagad</span>
                                <span class="text-sm font-bold">1,000 কয়েনে রিডিম</span>
                            </div>
                            <button data-type="Nagad" data-coins="1000" data-amount="100" class="redeem-btn Nagad-color-btn text-white font-bold py-2 px-4 rounded-lg transition duration-200">রিডিম</button>
                        </div>
                    </div>
                    <div class="redeem-offer-card Nagad-color p-0 rounded-xl card-shadow overflow-hidden">
                        <div class="text-center py-4 px-6"><p class="text-5xl font-extrabold text-white">৳1500</p></div>
                        <div class="bg-white p-4 flex justify-between items-center text-gray-800">
                            <div class="flex flex-col">
                                <span class="text-xs font-semibold uppercase text-yellow-600">Nagad</span>
                                <span class="text-sm font-bold">10,000 কয়েনে রিডিম</span>
                            </div>
                            <button data-type="Nagad" data-coins="10000" data-amount="1500" class="redeem-btn Nagad-color-btn text-white font-bold py-2 px-4 rounded-lg transition duration-200">রিডিম</button>
                        </div>
                    </div>
                </div>
                <h3 class="text-lg font-semibold mt-8 mb-3 text-gray-800 border-b pb-1">রিডিম ইতিহাস</h3>
                <div id="redeem-history" class="space-y-2">
                    <p class="text-gray-500 text-sm">কোনো রিডিম রিকোয়েস্ট নেই।</p>
                </div>
            </div>

            <!-- Earn Tab -->
            <div id="tab-earn" class="tab-content" style="display:block;">
                <h2 class="text-xl font-bold mb-4 text-gray-800">কয়েন উপার্জন করুন</h2>
                <div class="bg-white p-5 rounded-xl card-shadow mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <p class="text-lg font-semibold text-gray-800">ভিডিও বিজ্ঞাপন দেখুন</p>
                        <span class="text-green-600 font-bold">+10 কয়েন</span>
                    </div>
                    <button id="ad-button" class="w-full py-3 rounded-lg text-white font-bold transition duration-300 disabled:opacity-50" style="background-color:#3b82f6;">বিজ্ঞাপন দেখুন</button>
                    <div id="ad-cooldown" class="mt-3 text-center text-sm text-gray-500" style="display:none;">
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1">
                            <div id="cooldown-progress" class="bg-red-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <span id="cooldown-timer">১ মিনিট কুলডাউন...</span>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl card-shadow">
                    <p class="text-lg font-semibold text-gray-800 mb-3">বন্ধুদের রেফার করুন</p>
                    <p class="text-sm text-gray-600 mb-4">আপনার লিঙ্কে জয়েন করলে এবং প্রথম অ্যাড দেখলে, আপনি ও আপনার বন্ধু দুজনেই পাবেন <span class="text-green-600 font-bold">+50 কয়েন</span>।</p>
                    <div class="flex items-center justify-between bg-gray-100 p-3 rounded-lg mb-4">
                        <p class="text-sm font-medium truncate" id="referral-code">ref_...</p>
                        <button id="copy-referral-btn" class="text-blue-600 text-sm font-semibold ml-3 active:text-blue-800">কপি</button>
                    </div>
                    <p class="text-sm font-medium text-gray-800">আপনার রেফার সংখ্যা: <span id="referral-count" class="font-bold text-blue-600">0</span></p>
                    <p id="redeem-lock-status" class="text-xs mt-1 text-red-500 font-medium hidden">রিডিম করতে আরও <span id="ref-needed">5</span> জনকে রেফার করুন।</p>
                </div>
            </div>

            <!-- Feed Tab -->
            <div id="tab-feed" class="tab-content" style="display:none;">
                <h2 class="text-xl font-bold mb-4 text-gray-800">লাইভ ফিড ও লিডারবোর্ড</h2>
                <div class="bg-white p-5 rounded-xl card-shadow mb-6">
                    <p class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">শীর্ষ উপার্জনকারী (টপ ৫)</p>
                    <div id="leaderboard-list" class="space-y-3">
                        <p class="text-gray-500 text-sm">লিডারবোর্ড লোড হচ্ছে...</p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl card-shadow">
                    <p class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">অ্যাডমিন আপডেট</p>
                    <p class="text-gray-500 text-sm">এখানে অ্যাডমিন থেকে আসা গুরুত্বপূর্ণ পোস্ট ও আপডেট দেখা যাবে।</p>
                </div>
            </div>
        </main>

        <!-- Redeem Modal -->
        <div id="redeem-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-40 transition-opacity duration-300">
            <div class="bg-white w-full max-w-md rounded-xl shadow-2xl transform scale-95 transition-transform duration-300">
                <div id="modal-header" class="p-4 rounded-t-xl text-white flex justify-between items-center bKash-color">
                    <h3 class="text-xl font-bold" id="modal-title">রিডিম ফর্ম</h3>
                    <button id="close-modal-btn" class="p-1 rounded-full hover:bg-white hover:bg-opacity-20 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="redeem-form" class="p-6">
                    <p class="text-sm font-medium mb-4 text-gray-600" id="redeem-type-info">আপনি bKash-এর মাধ্যমে <span class="font-bold text-lg text-green-600">৳100</span> রিডিম করছেন।</p>
                    <input type="hidden" id="modal-coins" value="0">
                    <input type="hidden" id="modal-amount" value="0">
                    <input type="hidden" id="modal-type" value="">
                    <label class="block text-sm font-medium text-gray-700 mb-2">আপনার মোবাইল নাম্বার</label>
                    <input type="text" id="target-number" required pattern="[0-9]{11}" placeholder="১১ ডিজিটের নাম্বার" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <button type="submit" id="final-redeem-btn" class="w-full py-3 rounded-lg text-white font-bold transition duration-300 disabled:opacity-50 bKash-color-btn">
                        রিডিম রিকোয়েস্ট পাঠান
                    </button>
                    <p id="redeem-error" class="text-sm text-red-500 mt-3 text-center hidden">ত্রুটি: আপনার পর্যাপ্ত কয়েন বা রেফার নেই।</p>
                </form>
            </div>
        </div>

        <nav class="bg-white border-t border-gray-200 sticky bottom-0 z-10 shadow-lg">
            <div class="flex justify-around py-2">
                <button data-tab="redeem" class="nav-link flex flex-col items-center p-2 text-gray-500 active:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-2.485 0-4 .933-4 2.5v.5H7a2 2 0 00-2 2v3a2 2 0 002 2h10a2 2 0 002-2v-3a2 2 0 00-2-2h-1v-.5c0-1.567-1.515-2.5-4-2.5z" />
                    </svg>
                    <span class="text-xs mt-1">রিডিম</span>
                </button>
                <button data-tab="earn" class="nav-link flex flex-col items-center p-2 text-blue-600 active:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                    </svg>
                    <span class="text-xs mt-1">উপার্জন</span>
                </button>
                <button data-tab="feed" class="nav-link flex flex-col items-center p-2 text-gray-500 active:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                    <span class="text-xs mt-1">ফিড</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
        const STATE = {
            user: {}, coins: 0, referral_count: 0, tier: 'Bronze', last_ad: 0, is_earning_cooldown: false,
            // তোমার আসল ব্যাকএন্ড URL এখানে দাও
            API_URL: 'https://your-real-backend.onrender.com/api' // এটি পরিবর্তন করো!
        };
        const tg = window.Telegram.WebApp;

        const showAlert = (msg) => tg?.showAlert ? tg.showAlert(msg) : alert(msg);

        const apiFetch = async (endpoint, method = 'GET', data = null) => {
            const url = `${STATE.API_URL}${endpoint}`;
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${tg?.initData || 'local-test'}`
                }
            };
            if (data) options.body = JSON.stringify(data);

            try {
                const response = await fetch(url, options);
                if (!response) throw new Error('নেটওয়ার্ক সমস্যা');
                if (!response.ok) {
                    let err = 'সার্ভার ত্রুটি';
                    try { const j = await response.json(); err = j.message || err; } catch {}
                    throw new Error(`${err} (${response.status})`);
                }
                return await response.json();
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showAlert("ইন্টারনেট নেই বা সার্ভার ডাউন।");
                } else {
                    showAlert(`ত্রুটি: ${error.message}`);
                }
                console.error("API Error:", error);
                throw error;
            }
        };

        const getTier = (c) => c >= 5000 ? 'Gold' : c >= 1000 ? 'Silver' : 'Bronze';

        const renderUI = () => {
            const { user, coins, referral_count, tier } = STATE;
            document.getElementById('profile-pic').src = user.photo_url || 'https://placehold.co/48x48/6b7280/ffffff?text=U';
            document.getElementById('user-name').textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'ইউজার';
            document.getElementById('user-uid').textContent = `UID: ${user.id || 'N/A'}`;
            document.getElementById('user-coins').textContent = coins.toLocaleString('en-US');
            const badge = document.getElementById('tier-badge');
            badge.textContent = `${tier} Tier`;
            badge.className = 'px-3 py-1 text-sm font-semibold rounded-full';
            badge.classList.add(tier === 'Gold' ? 'bg-yellow-500 text-gray-900' : tier === 'Silver' ? 'bg-gray-400 text-white' : 'bg-amber-800 text-white');
            document.getElementById('referral-code').textContent = `t.me/HiGriP_bot?start=ref_${user.id || ''}`;
            document.getElementById('referral-count').textContent = referral_count;
            const needed = 5 - referral_count;
            const lock = document.getElementById('redeem-lock-status');
            if (needed > 0) { lock.classList.remove('hidden'); document.getElementById('ref-needed').textContent = needed; }
            else lock.classList.add('hidden');
            document.querySelectorAll('.redeem-btn').forEach(btn => {
                const req = parseInt(btn.dataset.coins);
                if (referral_count < 5) { btn.disabled = true; btn.textContent = 'রেফার লক'; btn.classList.add('opacity-50'); }
                else if (coins < req) { btn.disabled = true; btn.textContent = 'কয়েন কম'; btn.classList.add('opacity-50'); }
                else { btn.disabled = false; btn.textContent = 'রিডিম'; btn.classList.remove('opacity-50'); }
            });
        };

        const initApp = async () => {
            tg.ready(); tg.expand();
            const user = tg.initDataUnsafe?.user;
            if (!user?.id) { document.getElementById('loading').innerHTML = '<p class="text-red-400">Telegram ইউজার লোড হয়নি!</p>'; return; }
            STATE.user = user;
            const params = new URLSearchParams(location.search);
            const ref = params.get('start')?.startsWith('ref_') ? params.get('start').substring(4) : null;

            try {
                const data = await apiFetch('/init', 'POST', { initData: tg.initData, referred_by: ref, user_info: { uid: user.id, username: user.username || '', first_name: user.first_name || '', last_name: user.last_name || '', photo_url: user.photo_url || '' } });
                STATE.coins = data.coins || 0; STATE.referral_count = data.referral_count || 0; STATE.last_ad = data.last_ad || 0; STATE.tier = getTier(STATE.coins);
                renderUI(); await fetchLeaderboard(); await fetchRedeemHistory(); checkAdCooldown();
            } catch { document.getElementById('loading').innerHTML = '<p class="text-red-400">সার্ভারের সাথে সংযোগ হচ্ছে না</p><p class="text-xs text-gray-300 mt-2">ইন্টারনেট চেক করুন</p>'; }
            finally { setTimeout(() => { const l = document.getElementById('loading'); l.style.opacity = '0'; setTimeout(() => l.style.display = 'none', 300); }, 1000); }
        };

        const AD_COOLDOWN_SECONDS = 60, AD_PROCESS_SECONDS = 30;
        let cooldownInterval;
        const checkAdCooldown = () => {
            const now = Date.now(), elapsed = (now - STATE.last_ad) / 1000, remaining = AD_COOLDOWN_SECONDS - elapsed;
            clearInterval(cooldownInterval);
            const btn = document.getElementById('ad-button'), cd = document.getElementById('ad-cooldown'), prog = document.getElementById('cooldown-progress'), timer = document.getElementById('cooldown-timer');
            if (remaining > 0) {
                STATE.is_earning_cooldown = true; btn.disabled = true; btn.textContent = 'কুলডাউনে...'; cd.style.display = 'block';
                const update = () => {
                    const cur = Math.max(0, AD_COOLDOWN_SECONDS - ((Date.now() - STATE.last_ad) / 1000));
                    if (cur <= 0) { clearInterval(cooldownInterval); STATE.is_earning_cooldown = false; btn.disabled = false; btn.textContent = 'বিজ্ঞাপন দেখুন'; cd.style.display = 'none'; return; }
                    timer.textContent = `${Math.ceil(cur)} সেকেন্ড বাকি`; prog.style.width = `${100 - (cur / AD_COOLDOWN_SECONDS * 100)}%`;
                };
                update(); cooldownInterval = setInterval(update, 1000);
            } else { STATE.is_earning_cooldown = false; btn.disabled = false; btn.textContent = 'বিজ্ঞাপন দেখুন'; cd.style.display = 'none'; }
        };

        const handleAdWatch = async () => {
            if (STATE.is_earning_cooldown) return;
            const btn = document.getElementById('ad-button'), cd = document.getElementById('ad-cooldown'), prog = document.getElementById('cooldown-progress'), timer = document.getElementById('cooldown-timer');
            btn.disabled = true; btn.textContent = 'লোড হচ্ছে...'; cd.style.display = 'block'; timer.textContent = 'বিজ্ঞাপন চলছে, ৩০ সেকেন্ড অপেক্ষা করুন...';
            const start = Date.now();
            const pi = setInterval(() => { const e = (Date.now() - start) / 1000; prog.style.width = `${Math.min(100, (e / AD_PROCESS_SECONDS) * 100)}%`; }, 100);
            try {
                await show_10087307(); clearInterval(pi); prog.style.width = '100%';
                const res = await apiFetch('/earn', 'POST', { uid: STATE.user.id, reward: 10 });
                STATE.coins = res.new_coins; STATE.referral_count = res.referral_count; STATE.last_ad = Date.now(); STATE.tier = getTier(STATE.coins);
                renderUI(); checkAdCooldown(); showAlert(`সফল! +${res.earned_coins} কয়েন`);
            } catch { btn.textContent = 'বিজ্ঞাপন দেখুন'; btn.disabled = false; cd.style.display = 'none'; }
        };

        const openRedeemModal = (type, coins, amount) => {
            if (STATE.referral_count < 5) return showAlert("কমপক্ষে ৫ জনকে রেফার করুন!");
            if (STATE.coins < coins) return showAlert(`পর্যাপ্ত কয়েন নেই! (${coins} প্রয়োজন)`);
            document.getElementById('modal-coins').value = coins; document.getElementById('modal-amount').value = amount; document.getElementById('modal-type').value = type;
            const header = document.getElementById('modal-header'), btn = document.getElementById('final-redeem-btn'), info = document.getElementById('redeem-type-info');
            const hc = type === 'bKash' ? 'bKash-color' : 'Nagad-color', bc = type === 'bKash' ? 'bKash-color-btn' : 'Nagad-color-btn';
            header.className = `p-4 rounded-t-xl text-white flex justify-between items-center ${hc}`;
            btn.className = `w-full py-3 rounded-lg text-white font-bold transition duration-300 disabled:opacity-50 ${bc}`;
            document.getElementById('modal-title').textContent = `${type} রিডিম রিকোয়েস্ট`;
            info.innerHTML = `আপনি ${type}-এর মাধ্যমে <span class="font-bold text-lg text-white p-1 rounded-md ${hc}">৳${amount}</span> রিডিম করছেন।`;
            document.getElementById('redeem-modal').classList.remove('hidden'); document.querySelector('#redeem-modal > div').classList.remove('scale-95');
        };

        const closeRedeemModal = () => { document.querySelector('#redeem-modal > div').classList.add('scale-95'); setTimeout(() => document.getElementById('redeem-modal').classList.add('hidden'), 300); };

        const handleRedeemRequest = async (e) => {
            e.preventDefault();
            const coins = document.getElementById('modal-coins').value, amount = document.getElementById('modal-amount').value, type = document.getElementById('modal-type').value, num = document.getElementById('target-number').value.trim();
            const btn = document.getElementById('final-redeem-btn'), err = document.getElementById('redeem-error');
            btn.disabled = true; btn.textContent = 'প্রসেসিং...'; err.classList.add('hidden');
            try {
                const res = await apiFetch('/redeem', 'POST', { uid: STATE.user.id, type, coins, amount, number: num });
                STATE.coins = res.new_coins; STATE.tier = getTier(STATE.coins); renderUI(); await fetchRedeemHistory();
                showAlert("রিডিম রিকোয়েস্ট জমা হয়েছে!"); closeRedeemModal();
            } catch (e) { err.textContent = `ত্রুটি: ${e.message}`; err.classList.remove('hidden'); }
            finally { btn.disabled = false; btn.textContent = 'রিডিম রিকোয়েস্ট পাঠান'; }
        };

        const fetchLeaderboard = async () => {
            try {
                const data = await apiFetch('/leaderboard');
                const list = document.getElementById('leaderboard-list'); list.innerHTML = '';
                if (!data.length) { list.innerHTML = '<p class="text-gray-500 text-sm">কোনো ডেটা নেই</p>'; return; }
                data.forEach((u, i) => {
                    const t = getTier(u.coins), tc = t === 'Gold' ? 'bg-yellow-500' : t === 'Silver' ? 'bg-gray-400' : 'bg-amber-800';
                    list.innerHTML += `<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3"><span class="font-bold text-lg text-gray-600 w-6 text-center">${i + 1}.</span><span class="font-semibold truncate">${u.name}</span></div>
                        <div class="flex items-center space-x-2"><span class="text-blue-600 font-bold">${u.coins.toLocaleString()}</span><span class="px-2 py-0.5 text-xs font-semibold rounded-full text-white ${tc}">${t}</span></div>
                    </div>`;
                });
            } catch { document.getElementById('leaderboard-list').innerHTML = '<p class="text-red-500 text-sm">লিডারবোর্ড লোড হয়নি</p>'; }
        };

        const fetchRedeemHistory = async () => {
            try {
                const res = await apiFetch(`/redeem-history?uid=${STATE.user.id}`);
                const hist = document.getElementById('redeem-history'); hist.innerHTML = '';
                if (!res.history?.length) { hist.innerHTML = '<p class="text-gray-500 text-sm">কোনো রিডিম নেই</p>'; return; }
                res.history.forEach(h => {
                    const sc = h.status === 'Pending' ? 'text-yellow-600' : 'text-green-600';
                    hist.innerHTML += `<div class="flex justify-between items-center p-3 bg-white rounded-lg border">
                        <div><p class="font-semibold">${h.type} - ৳${h.amount}</p><p class="text-xs text-gray-500">${new Date(h.date).toLocaleDateString('bn-BD')}</p></div>
                        <div class="text-sm font-medium ${sc}">${h.status}</div>
                    </div>`;
                });
            } catch { document.getElementById('redeem-history').innerHTML = '<p class="text-red-500 text-sm">ইতিহাস লোড হয়নি</p>'; }
        };

        const switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(l => { l.classList.remove('text-blue-600'); l.classList.add('text-gray-500'); });
            document.getElementById(`tab-${tab}`).style.display = 'block';
            document.querySelector(`[data-tab="${tab}"]`).classList.remove('text-gray-500'); document.querySelector(`[data-tab="${tab}"]`).classList.add('text-blue-600');
            if (tab === 'feed') fetchLeaderboard(); if (tab === 'redeem') { fetchRedeemHistory(); renderUI(); }
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.nav-link').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));
            document.getElementById('ad-button').addEventListener('click', handleAdWatch);
            document.querySelectorAll('.redeem-btn').forEach(b => b.addEventListener('click', () => openRedeemModal(b.dataset.type, b.dataset.coins, b.dataset.amount)));
            document.getElementById('close-modal-btn').addEventListener('click', closeRedeemModal);
            document.getElementById('redeem-form').addEventListener('submit', handleRedeemRequest);
            document.getElementById('copy-referral-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('referral-code').textContent).then(() => showAlert("কপি হয়েছে!")).catch(() => showAlert("কপি ফেল!"));
            });
            if (tg) initApp();
            else {
                STATE.user = { id: 123456789, first_name: 'টেস্ট' }; STATE.coins = 15000; STATE.referral_count = 7; STATE.tier = 'Gold';
                renderUI(); document.getElementById('loading').style.display = 'none';
            }
        });
    </script>
</body>
</html>
