<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PayNex - Paynex_Earnbot</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0088cc;
      --primary-dark: #006da3;
      --secondary: #121c36;
      --accent: #00c2ff;
      --success: #00d66c;
      --warning: #ff9500;
      --danger: #ff3b30;
      --text: #ffffff;
      --text-secondary: #b0b0b0;
      --card-bg: #1a243b;
      --input-bg: #23304d;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Arial, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--secondary) 0%, #0d1425 100%);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 80px;
    }

    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--secondary);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 1;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--primary);
      border-top: 5px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    header {
      padding: 15px 20px;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: bold;
      font-size: 20px;
    }

    .logo i { font-size: 24px; }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .notification-btn {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      position: relative;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
    }

    .content { padding: 20px; }

    .section-title {
      margin-bottom: 15px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i { color: var(--accent); }

    .card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .hero-section { text-align: center; padding: 20px 0; }

    .hero-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--accent);
    }

    .balance-amount {
      font-size: 32px;
      font-weight: bold;
      margin: 10px 0;
      color: var(--success);
    }

    .task-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .task-item {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .task-number {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255, 255, 255, 0.2);
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .task-icon { font-size: 30px; margin-bottom: 10px; }

    .task-title {
      font-size: 14px;
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .task-reward {
      font-size: 12px;
      color: var(--success);
      font-weight: bold;
    }

    .task-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .task-btn:hover { background: rgba(255, 255, 255, 0.3); }
    .task-btn.completed { background: var(--success); }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #23304d 0%, #1a243b 100%);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin: 5px 0;
      color: var(--accent);
    }

    .stat-label { font-size: 12px; color: var(--text-secondary); }

    .referral-link { display: flex; margin: 15px 0; }

    .referral-link input {
      flex: 1;
      padding: 12px 15px;
      border-radius: 8px 0 0 8px;
      border: none;
      background: var(--input-bg);
      color: var(--text);
    }

    .copy-btn {
      background: var(--primary);
      border: none;
      color: white;
      padding: 0 15px;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
    }

    .share-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }

    .share-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: var(--input-bg);
      border: none;
      border-radius: 10px;
      padding: 10px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.3s;
    }

    .share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .share-btn i { font-size: 24px; margin-bottom: 5px; }

    .share-btn.facebook i { color: #1877f2; }
    .share-btn.whatsapp i { color: #25d366; }
    .share-btn.messenger i { color: #006aff; }

    .profile-header { text-align: center; margin-bottom: 20px; }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary);
      margin: 0 auto 15px;
    }

    .profile-name { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
    .profile-username { color: var(--text-secondary); margin-bottom: 10px; }
    .profile-id { font-size: 14px; color: var(--text-secondary); margin-bottom: 15px; }
    .profile-tagline {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 8px 15px;
      border-radius: 20px;
      display: inline-block;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .withdraw-section { margin-top: 20px; }

    .withdraw-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      cursor: pointer;
    }

    .withdraw-content { display: none; }
    .withdraw-content.active { display: block; }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 14px; }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid var(--input-bg);
      background: var(--input-bg);
      color: var(--text);
    }

    .submit-btn {
      background: var(--primary);
      border: none;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      width: 100%;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .submit-btn:hover { background: var(--primary-dark); }
    .submit-btn:disabled { background: var(--text-secondary); cursor: not-allowed; }

    .min-withdraw-info {
      text-align: center;
      margin: 15px 0;
      font-size: 14px;
      color: var(--text-secondary);
    }

    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      background: var(--card-bg);
      padding: 12px 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    .nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .nav-btn i { font-size: 20px; margin-bottom: 5px; }
    .nav-btn.active { color: var(--primary); }

    .hidden { display: none; }

    .notification-panel {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100%;
      background: var(--card-bg);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
      transition: right 0.3s ease;
    }

    .notification-panel.active { right: 0; }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--input-bg);
    }

    .close-notifications {
      background: none;
      border: none;
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
    }

    .notification-item {
      padding: 15px;
      background: var(--input-bg);
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .notification-title { font-weight: bold; margin-bottom: 5px; color: var(--accent); }
    .notification-message { font-size: 14px; margin-bottom: 5px; color: var(--text); }
    .notification-time { font-size: 12px; color: var(--text-secondary); margin-top: 5px; }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--overlay);
      z-index: 999;
      display: none;
    }

    .overlay.active { display: block; }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--success);
      opacity: 0;
      z-index: 1000;
      pointer-events: none;
    }

    @keyframes confettiFall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(1000px) rotate(720deg); opacity: 0; }
    }

    .referral-stats {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
      padding: 10px;
      background: var(--input-bg);
      border-radius: 10px;
    }

    .referral-stats .stat { text-align: center; }
    .referral-stats .stat-value { font-size: 18px; font-weight: bold; color: var(--success); display: block; }
    .referral-stats .stat-label { font-size: 12px; color: var(--text-secondary); }

    @media (max-width: 480px) {
      .task-grid { grid-template-columns: 1fr; }
      .stats-container { grid-template-columns: 1fr; }
      .share-buttons { grid-template-columns: repeat(2, 1fr); }
      .notification-panel { width: 85%; right: -85%; }
    }
  </style>
</head>
<body>
  <!-- Spinner -->
  <div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner"></div>
  </div>

  <header>
    <div class="logo">
      <i class="fas fa-wallet"></i>
      <span>PayNex</span>
    </div>
    <div class="header-actions">
      <button class="notification-btn" onclick="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationBadge">0</span>
      </button>
      <img id="userAvatar" class="user-avatar" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User">
    </div>
  </header>

  <div class="content">
    <!-- Home Page -->
    <div id="homePage">
      <div class="card">
        <div class="hero-section">
          <h1 class="hero-title">আপনার আয় বৃদ্ধি করুন</h1>
          <div class="balance-amount">৳<span id="totalBalance">0</span></div>
          <div class="stats-container">
            <div class="stat-card">
              <div class="stat-label">টাস্ক ইনকাম</div>
              <div class="stat-value">৳<span id="taskIncome">0</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-label">রেফার ইনকাম</div>
              <div class="stat-value">৳<span id="refIncomeDetail">0</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-label">মোট উত্তোলন</div>
              <div class="stat-value">৳<span id="totalWithdraw">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="section-title">
          <i class="fas fa-tasks"></i>
          আজকের টাস্ক
        </h2>
        <div class="task-grid" id="taskGrid"></div>
      </div>
    </div>

    <!-- Refer Page -->
    <div id="referPage" class="hidden">
      <div class="card">
        <h2 class="section-title">
          <i class="fas fa-user-friends"></i>
          Referral System
        </h2>

        <div class="referral-stats">
          <div class="stat">
            <span class="stat-value" id="refCount">0</span>
            <span class="stat-label">মোট রেফার</span>
          </div>
          <div class="stat">
            <span class="stat-value">৳<span id="refIncome">0</span></span>
            <span class="stat-label">রেফার ইনকাম</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="refLevel">1</span>
            <span class="stat-label">লেভেল</span>
          </div>
        </div>

        <p style="text-align: center; margin: 15px 0; color: var(--success); font-weight: bold;">
          প্রতি রেফারেলে ৳25 পান! 🔥
        </p>

        <div class="referral-link">
          <input id="refLink" type="text" readonly placeholder="রেফারেল লিংক লোড হচ্ছে...">
          <button class="copy-btn" onclick="copyRef()">
            <i class="fas fa-copy"></i>
          </button>
        </div>

        <div class="share-buttons">
          <button class="share-btn facebook" onclick="shareOnFacebook()">
            <i class="fab fa-facebook"></i>
            <span>Facebook</span>
          </button>
          <button class="share-btn whatsapp" onclick="shareOnWhatsApp()">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
          </button>
          <button class="share-btn messenger" onclick="shareOnMessenger()">
            <i class="fab fa-facebook-messenger"></i>
            <span>Messenger</span>
          </button>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: var(--input-bg); border-radius: 10px; text-align: center;">
          <h4 style="color: var(--accent); margin-bottom: 10px;">📈 আপনার রেফারেল লেভেল</h4>
          <p style="color: var(--text-secondary); font-size: 14px;">
            <strong id="levelInfo">লেভেল 1:</strong> প্রতি রেফার ৳25
          </p>
        </div>
      </div>
    </div>

    <!-- Profile Page -->
    <div id="profilePage" class="hidden">
      <div class="profile-header">
        <img id="profileAvatar" class="profile-avatar" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Profile">
        <div class="profile-name" id="userName">User Name</div>
        <div class="profile-username" id="userUsername">@username</div>
        <div class="profile-id">ID: <span id="userId">12345</span></div>
        <div class="profile-tagline" id="userLevel">Level 1</div>
      </div>

      <div class="card">
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-label">মোট রেফার</div>
            <div class="stat-value" id="profileRef">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">মোট ইনকাম</div>
            <div class="stat-value">৳<span id="profileIncome">0</span></div>
          </div>
        </div>

        <div class="withdraw-section">
          <div class="withdraw-header" onclick="toggleWithdrawSection()">
            <h3 class="section-title">
              <i class="fas fa-money-bill-wave"></i>
              উত্তোলন
            </h3>
            <i class="fas fa-chevron-down" id="withdrawArrow"></i>
          </div>

          <div class="withdraw-content" id="withdrawContent">
            <p class="min-withdraw-info">ন্যূনতম উত্তোলন: ৳500 এবং 10 রেফার</p>

            <form id="withdrawForm">
              <div class="form-group">
                <label for="method">পদ্ধতি</label>
                <select id="method" class="form-control" required>
                  <option value="">নির্বাচন করুন</option>
                  <option value="bkash">বিকাশ</option>
                  <option value="nagad">নগদ</option>
                </select>
              </div>

              <div class="form-group">
                <label for="number">মোবাইল নাম্বার</label>
                <input type="number" id="number" class="form-control" placeholder="নাম্বার দিন" required>
              </div>

              <div class="form-group">
                <label for="amount">পরিমাণ</label>
                <input type="number" id="amount" class="form-control" placeholder="পরিমাণ টাকা" min="500" required>
              </div>

              <button type="submit" class="submit-btn" id="withdrawBtn">উত্তোলন রিকোয়েস্ট</button>
            </form>

            <p id="withdrawMsg" style="text-align: center; margin-top: 15px;"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <nav>
    <button class="nav-btn active" id="navHome" onclick="showPage('home')">
      <i class="fas fa-home"></i>
      <span>হোম</span>
    </button>
    <button class="nav-btn" id="navRefer" onclick="showPage('refer')">
      <i class="fas fa-user-friends"></i>
      <span>রেফার</span>
    </button>
    <button class="nav-btn" id="navProfile" onclick="showPage('profile')">
      <i class="fas fa-user"></i>
      <span>প্রোফাইল</span>
    </button>
  </nav>

  <!-- Notifications -->
  <div class="notification-panel" id="notificationPanel">
    <div class="notification-header">
      <h3>নোটিফিকেশন</h3>
      <button class="close-notifications" onclick="toggleNotifications()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="notificationsList"></div>
  </div>

  <div class="overlay" id="overlay" onclick="toggleNotifications()"></div>

  <script>
    // ========== FIXED CONFIGURATION ==========
    const BOT_CONFIG = {
      username: "Paynex_Earnbot",
      token: "8452148581:AAGkseZLOKWequ7ymuWIzlFct3joP-IwZbA",
      referralBonus: 25
    };

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCho5RtEIoXnNlNNrpBg65BmTpJY23Se7Y",
      authDomain: "maillbeex.firebaseapp.com",
      databaseURL: "https://maillbeex-default-rtdb.firebaseio.com",
      projectId: "maillbeex",
      storageBucket: "maillbeex.firebasestorage.app",
      messagingSenderId: "5938669413",
      appId: "1:5938669413:web:34b6bbbbb0e81628a2a38c"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Telegram WebApp
    let tg = window.Telegram.WebApp;
    tg.expand();

    // Global user data
    let userData = {
      uid: null,
      name: '',
      refCount: 0,
      taskIncome: 0,
      refIncome: 0,
      totalWithdraw: 0,
      completedTasks: [],
      dailyTaskCount: 0,
      lastTaskDate: null,
      level: 1,
      joinDate: null,
      referrerId: null
    };

    // ========== FIXED REFERRAL DETECTION ==========
    function detectReferral() {
      console.log("🔍 Starting referral detection...");
      
      // Method 1: Telegram initData
      let referralId = null;
      console.log("📡 Telegram initData:", tg.initDataUnsafe);
      
      // Check start_app parameter (Telegram Mini App)
      if (tg.initDataUnsafe.start_app) {
        console.log("📱 Found start_app:", tg.initDataUnsafe.start_app);
        if (tg.initDataUnsafe.start_app.startsWith('ref_')) {
          referralId = tg.initDataUnsafe.start_app.replace('ref_', '');
          console.log("🎉 REFERRAL FOUND via start_app:", referralId);
        }
      }
      
      // Method 2: URL parameters (fallback)
      if (!referralId) {
        const urlParams = new URLSearchParams(window.location.search);
        console.log("🌐 URL params:", window.location.search);
        
        const startAppParam = urlParams.get('startapp');
        if (startAppParam && startAppParam.startsWith('ref_')) {
          referralId = startAppParam.replace('ref_', '');
          console.log("🎉 REFERRAL FOUND via URL startapp:", referralId);
        }
        
        // Method 3: Check for 'start' parameter (legacy)
        const startParam = urlParams.get('start');
        if (startParam && startParam.startsWith('ref_')) {
          referralId = startParam.replace('ref_', '');
          console.log("🎉 REFERRAL FOUND via legacy start param:", referralId);
        }
      }
      
      // Method 4: Check initDataUnsafe.start_param (alternative)
      if (!referralId && tg.initDataUnsafe.start_param) {
        console.log("🔍 Checking start_param:", tg.initDataUnsafe.start_param);
        if (tg.initDataUnsafe.start_param.startsWith('ref_')) {
          referralId = tg.initDataUnsafe.start_param.replace('ref_', '');
          console.log("🎉 REFERRAL FOUND via start_param:", referralId);
        }
      }
      
      console.log("📊 Final referral result:", referralId || "No referral");
      return referralId;
    }

    // ========== REFERRAL PROCESSING ==========
    async function processReferral(referrerId) {
      if (!referrerId || referrerId === userData.uid) {
        console.log("⚠️ Invalid referral - same user or no referrer");
        return false;
      }
      
      console.log("🚀 Processing referral from:", referrerId, "to:", userData.uid);
      
      try {
        const referralRef = database.ref(`referrals/${referrerId}/${userData.uid}`);
        const snapshot = await referralRef.once('value');
        
        if (snapshot.exists()) {
          console.log("⚠️ Referral already exists");
          return false;
        }
        
        // Create new referral
        const referralData = {
          referredUserId: userData.uid,
          referrerId: referrerId,
          referredUserName: userData.name,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          bonusAmount: BOT_CONFIG.referralBonus,
          status: 'active'
        };
        
        await referralRef.set(referralData);
        console.log("💾 Referral saved to Firebase");
        
        // Update current user
        const userRef = database.ref(`users/${userData.uid}`);
        await userRef.update({
          referrerId: referrerId,
          joinDate: firebase.database.ServerValue.TIMESTAMP
        });
        
        // Update referrer (atomic transaction)
        const referrerRef = database.ref(`users/${referrerId}`);
        await referrerRef.transaction((referrer) => {
          if (referrer) {
            referrer.refCount = (referrer.refCount || 0) + 1;
            referrer.refIncome = (referrer.refIncome || 0) + BOT_CONFIG.referralBonus;
            
            // Update level
            const newLevel = Math.min(10, Math.floor((referrer.refCount || 0) / 5) + 1);
            if (newLevel > (referrer.level || 1)) {
              referrer.level = newLevel;
            }
            
            console.log("📊 Referrer updated:", referrer.refCount, "referrals, ৳", referrer.refIncome);
            return referrer;
          }
          return { refCount: 1, refIncome: BOT_CONFIG.referralBonus, level: 1 };
        });
        
        // Send notifications
        await sendTelegramMessage(userData.uid, `🎉 <b>স্বাগতম PayNex!</b>\n\nআপনি ${referrerId} এর রেফারেল লিংক দিয়ে জয়েন করেছেন!\n\n💰 প্রতি রেফারেলে ৳25 আয় করুন!`);
        
        // Show success
        showNotification(`🎉 সফলভাবে রেফার করা হয়েছে! আপনার রেফার ${BOT_CONFIG.referralBonus}৳ বোনাস পাবেন।`);
        
        console.log("✅ Referral processed successfully!");
        return true;
        
      } catch (error) {
        console.error("❌ Referral error:", error);
        showNotification("❌ রেফারেল প্রসেস করতে সমস্যা!");
        return false;
      }
    }

    // ========== TELEGRAM MESSAGES ==========
    async function sendTelegramMessage(chatId, text) {
      try {
        const url = `https://api.telegram.org/bot${BOT_CONFIG.token}/sendMessage`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: chatId,
            text: text,
            parse_mode: 'HTML'
          })
        });
        
        const result = await response.json();
        console.log("📱 Telegram message sent:", result.ok ? "Success" : result.description);
        return result.ok;
      } catch (error) {
        console.error("❌ Telegram error:", error);
        return false;
      }
    }

    // ========== UI UPDATES ==========
    function updateUI() {
      document.getElementById("totalBalance").innerText = Math.round(userData.taskIncome + userData.refIncome - userData.totalWithdraw);
      document.getElementById("taskIncome").innerText = userData.taskIncome || 0;
      document.getElementById("refIncomeDetail").innerText = userData.refIncome || 0;
      document.getElementById("totalWithdraw").innerText = userData.totalWithdraw || 0;
      document.getElementById("profileIncome").innerText = Math.round(userData.taskIncome + userData.refIncome - userData.totalWithdraw);
      document.getElementById("profileRef").innerText = userData.refCount || 0;
      document.getElementById("userLevel").innerText = `Level ${userData.level || 1}`;
      
      // Update referral page
      if (document.getElementById("refCount")) {
        document.getElementById("refCount").innerText = userData.refCount || 0;
        document.getElementById("refIncome").innerText = userData.refIncome || 0;
        document.getElementById("refLevel").innerText = userData.level || 1;
      }
    }

    // Generate referral link
    function generateReferralLink(userId) {
      return `https://t.me/${BOT_CONFIG.username}/app?startapp=ref_${userId}`;
    }

    // Copy referral link
    function copyRef() {
      const refInput = document.getElementById("refLink");
      const refLink = generateReferralLink(userData.uid);
      refInput.value = refLink;
      
      refInput.select();
      refInput.setSelectionRange(0, 99999);
      
      navigator.clipboard.writeText(refLink).then(() => {
        showNotification("📋 রেফারেল লিংক কপি হয়েছে!");
        console.log("📋 Copied:", refLink);
      }).catch(() => {
        document.execCommand("copy");
        showNotification("📋 রেফারেল লিংক কপি হয়েছে!");
      });
    }

    // Sharing functions
    function shareOnFacebook() {
      const refLink = generateReferralLink(userData.uid);
      const text = encodeURIComponent(`PayNex এ জয়েন করুন এবং টাকা আয় করুন!\n\nআমার রেফারেল: ${refLink}\n\nপ্রতি রেফারেলে ৳25! 💰`);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(refLink)}&quote=${text}`, '_blank');
      showNotification("📱 Facebook তে শেয়ার হচ্ছে...");
    }

    function shareOnWhatsApp() {
      const refLink = generateReferralLink(userData.uid);
      const text = encodeURIComponent(`PayNex এ জয়েন করুন এবং টাকা আয় করুন!\n\nআমার রেফারেল: ${refLink}\n\nপ্রতি রেফারেলে ৳25! 💰`);
      window.open(`https://wa.me/?text=${text}`, '_blank');
      showNotification("📱 WhatsApp তে শেয়ার হচ্ছে...");
    }

    function shareOnMessenger() {
      const refLink = generateReferralLink(userData.uid);
      window.open(`fb-messenger://share?link=${encodeURIComponent(refLink)}`, '_blank');
      showNotification("📱 Messenger তে শেয়ার হচ্ছে...");
    }

    // Task system
    function loadTasks() {
      const tasks = [
        { id: 1, title: "নতুন অ্যাকাউন্ট রেজিস্টার করুন", icon: "fa-user-plus", reward: 5 },
        { id: 2, title: "অ্যাপ ডাউনলোড করুন", icon: "fa-download", reward: 5 },
        { id: 3, title: "সার্ভে সম্পন্ন করুন", icon: "fa-poll", reward: 5 },
        { id: 4, title: "পোস্টে লাইক দিন", icon: "fa-thumbs-up", reward: 5 },
        { id: 5, title: "পোস্ট শেয়ার করুন", icon: "fa-share-alt", reward: 5 },
        { id: 6, title: "চ্যানেল সাবস্ক্রাইব করুন", icon: "fa-bell", reward: 5 }
      ];
      
      const taskGrid = document.getElementById("taskGrid");
      taskGrid.innerHTML = "";
      
      tasks.forEach(task => {
        const done = userData.completedTasks.includes(task.id);
        const div = document.createElement("div");
        div.className = "task-item";
        div.innerHTML = `
          <div class="task-number">${task.id}</div>
          <div class="task-icon"><i class="fas ${task.icon}"></i></div>
          <div class="task-title">${task.title}<span class="task-reward">৳${task.reward}</span></div>
          <button class="task-btn ${done ? 'completed' : ''}" onclick="completeTask(${task.id})" ${done ? 'disabled' : ''}>
            ${done ? 'সম্পন্ন ✅' : 'শুরু করুন'}
          </button>
        `;
        taskGrid.appendChild(div);
      });
    }

    function completeTask(taskId) {
      const today = new Date().toISOString().split('T')[0];
      if (userData.lastTaskDate !== today) {
        userData.dailyTaskCount = 0;
        userData.lastTaskDate = today;
      }
      
      if (userData.dailyTaskCount >= 6) {
        showNotification("⚠️ আজকের সব টাস্ক সম্পন্ন!");
        return;
      }
      
      if (userData.completedTasks.includes(taskId)) {
        showNotification("✅ এই টাস্ক আগে সম্পন্ন!");
        return;
      }
      
      userData.completedTasks.push(taskId);
      userData.taskIncome += 5;
      userData.dailyTaskCount += 1;
      
      // Save to Firebase
      const userRef = database.ref(`users/${userData.uid}`);
      userRef.update({
        taskIncome: userData.taskIncome,
        completedTasks: userData.completedTasks,
        dailyTaskCount: userData.dailyTaskCount,
        lastTaskDate: userData.lastTaskDate
      });
      
      updateUI();
      loadTasks();
      showNotification("🎉 টাস্ক সম্পন্ন! +৳5 যোগ হয়েছে!");
      
      // Confetti
      showConfetti();
    }

    // Withdraw system
    document.getElementById("withdrawForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      
      const method = document.getElementById("method").value;
      const number = document.getElementById("number").value;
      const amount = parseInt(document.getElementById("amount").value);
      const totalBalance = userData.taskIncome + userData.refIncome - userData.totalWithdraw;
      
      if (totalBalance < 500) {
        showNotification("❌ ন্যূনতম ৳500 প্রয়োজন!");
        return;
      }
      
      if (amount > totalBalance) {
        showNotification("❌ পর্যাপ্ত ব্যালেন্স নেই!");
        return;
      }
      
      const btn = document.getElementById("withdrawBtn");
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> প্রসেসিং...';
      
      try {
        userData.totalWithdraw += amount;
        await database.ref(`users/${userData.uid}/totalWithdraw`).set(userData.totalWithdraw);
        updateUI();
        
        showNotification(`✅ উত্তোলন রিকোয়েস্ট পাঠানো হয়েছে! ৳${amount}`);
        document.getElementById("withdrawForm").reset();
        
      } catch (error) {
        console.error("Withdraw error:", error);
        showNotification("❌ উত্তোলন প্রসেসে সমস্যা!");
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'উত্তোলন রিকোয়েস্ট';
      }
    });

    // Navigation
    function showPage(page) {
      document.querySelectorAll('.content > div').forEach(div => div.classList.add("hidden"));
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove("active"));
      
      if (page === "home") {
        document.getElementById("homePage").classList.remove("hidden");
        document.getElementById("navHome").classList.add("active");
        loadTasks();
      } else if (page === "refer") {
        document.getElementById("referPage").classList.remove("hidden");
        document.getElementById("navRefer").classList.add("active");
        document.getElementById("refLink").value = generateReferralLink(userData.uid);
      } else if (page === "profile") {
        document.getElementById("profilePage").classList.remove("hidden");
        document.getElementById("navProfile").classList.add("active");
      }
    }

    function toggleWithdrawSection() {
      const content = document.getElementById("withdrawContent");
      const arrow = document.getElementById("withdrawArrow");
      content.classList.toggle("active");
      arrow.classList.toggle("fa-chevron-down");
      arrow.classList.toggle("fa-chevron-up");
    }

    function toggleNotifications() {
      document.getElementById("notificationPanel").classList.toggle("active");
      document.getElementById("overlay").classList.toggle("active");
    }

    function showNotification(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: var(--card-bg); color: var(--text); padding: 12px 20px;
        border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000; opacity: 0; transition: opacity 0.3s;
        font-size: 14px; max-width: 90%; text-align: center;
      `;
      toast.innerText = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.style.opacity = '1', 10);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function showConfetti() {
      const colors = ['#0088cc', '#00c2ff', '#00d66c', '#ff9500', '#ff3b30'];
      for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.cssText = `
          left: ${Math.random() * 100}vw;
          background: ${colors[Math.floor(Math.random() * colors.length)]};
          animation: confettiFall ${Math.random() * 3 + 2}s linear forwards;
        `;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 5000);
      }
    }

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', async function() {
      console.log("🚀 Paynex_Earnbot Starting...");
      
      // Get user info
      const user = tg.initDataUnsafe.user;
      if (!user) {
        showNotification("❌ User data not found!");
        console.error("❌ No user data");
        return;
      }
      
      userData.uid = user.id.toString();
      userData.name = user.first_name + (user.last_name ? ' ' + user.last_name : '');
      
      console.log("👤 User:", userData.uid, userData.name);
      
      // Update UI with user info
      document.getElementById("userName").innerText = userData.name;
      document.getElementById("userUsername").innerText = user.username ? '@' + user.username : `@user_${userData.uid}`;
      document.getElementById("userId").innerText = userData.uid;
      document.getElementById("userAvatar").src = user.photo_url || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
      document.getElementById("profileAvatar").src = user.photo_url || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
      
      // Hide spinner
      document.getElementById("spinnerOverlay").style.display = 'none';
      
      // Detect and process referral
      const referralId = detectReferral();
      if (referralId) {
        await processReferral(referralId);
      } else {
        console.log("ℹ️ No referral detected");
      }
      
      // Load user data from Firebase
      const userRef = database.ref(`users/${userData.uid}`);
      userRef.once('value').then(snapshot => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          userData = { ...userData, ...data };
        }
        updateUI();
        loadTasks();
        console.log("✅ Initialization complete!");
      });
      
      // Real-time referral monitoring
      const referralsRef = database.ref(`referrals/${userData.uid}`);
      referralsRef.on('value', snapshot => {
        let count = 0;
        if (snapshot.exists()) {
          snapshot.forEach(() => count++);
        }
        userData.refCount = count;
        updateUI();
      });
    });

    // Set default navigation
    showPage('home');
  </script>
</body>
</html>
