<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grip Coin Mini App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for aesthetic UI -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Monetag Script -->
    <script type="text/javascript">
        (function() {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = '//monetag.com/some-path/loader.js';
            script.async = true;
            document.head.appendChild(script);
        })();
    </script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, serverTimestamp, runTransaction, getDoc, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ ---
        // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ Mini App ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
        const tg = window.Telegram?.WebApp;
        let appId = 'default-app-id';
        let firebaseConfig = {};
        let initialAuthToken = null;
        
        // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        const loadTelegramData = () => {
            if (tg) {
                // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá
                const user = tg.initDataUnsafe?.user;
                const queryId = tg.initDataUnsafe?.query_id;
                
                if (user) {
                    // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶è‡¶¨‡¶Ç ID ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                    state.userData.telegramUsername = user.username || `tg_user_${user.id}`;
                    state.userData.telegramId = user.id;
                    
                    // Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®)
                    firebaseConfig = {
                        apiKey: "your-api-key",
                        authDomain: "your-project.firebaseapp.com",
                        projectId: "your-project-id",
                        storageBucket: "your-project.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "your-app-id"
                    };
                    
                    // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ID ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
                    initialAuthToken = user.id.toString();
                    
                    appId = `telegram-${user.id}`;
                }
                
                // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶•‡¶ø‡¶Æ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü
                if (tg.colorScheme === 'dark') {
                    document.body.classList.add('bg-slate-950');
                } else {
                    document.body.classList.add('bg-gray-100');
                    document.body.classList.remove('bg-slate-950');
                }
            } else {
                console.warn("Telegram WebApp not detected, using default data");
                // ‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶°‡ßá‡¶ü‡¶æ
                firebaseConfig = {
                    apiKey: "dev-api-key",
                    authDomain: "dev-project.firebaseapp.com",
                    projectId: "dev-project-id",
                    storageBucket: "dev-project.appspot.com",
                    messagingSenderId: "987654321",
                    appId: "dev-app-id"
                };
                initialAuthToken = "dev-token-" + Date.now();
            }
        };
        
        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ UID ‡¶è‡¶¨‡¶Ç ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∞‡ßá‡¶ü
        const ADMIN_UID = "7243906826";
        const REFERRAL_COMMISSION = { 1: 0.05, 2: 0.02, 3: 0.01 };
        
        let app, db, auth;
        let unsubscribeListeners = []; 
        
        // --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ---
        let state = {
            userId: null,
            isAuthReady: false,
            currentPage: 'grip',
            userData: { 
                balance: 0, 
                telegramUsername: 'Loading...',
                telegramId: null
            },
            transactions: [],
            newsPosts: [],
            referrals: [],
            
            // Grip State
            isTapping: false,
            tapInterval: null,
            coinMultiplier: 1,
            coinsPerTick: 5,
            adRewardActive: false,
            adRewardDuration: 0,

            // Transfer/Status State
            transferRecipient: '',
            transferAmount: '',
            recipientData: null,
            statusMessage: null,
        };

        // --- ‡¶á‡¶â‡¶ü‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---

        const getCollectionRef = (type, uid = state.userId) => {
            if (!db) return null;
            switch (type) {
                case 'user_data_doc': 
                    return doc(db, 'artifacts', appId, 'users', uid, 'user_data');
                case 'transactions':
                    return collection(db, 'artifacts', appId, 'users', uid, 'transactions');
                case 'news':
                    return collection(db, 'artifacts', appId, 'public', 'news');
                case 'referrals':
                    return collection(db, 'artifacts', appId, 'public', 'referrals');
                default:
                    return null;
            }
        };

        const formatBalance = (num) => (num || 0).toLocaleString('en-US', { maximumFractionDigits: 2 });
        
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('bn-BD', {
                day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        };

        const updateStatusMessage = (message, isError = false) => {
            state.statusMessage = message;
            if (state.currentPage === 'transfer' || state.currentPage === 'news' || state.currentPage === 'grip') {
                renderApp();
            }
        };

        const replaceIcons = () => {
            lucide.createIcons();
        };

        // --- Monetag Integration ---
        
        /**
         * In-App Interstitial ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶Ø‡¶º (‡¶ï‡ßã‡¶° ‡ßß)
         */
        const showAutoInterstitialAd = () => {
            if (typeof show_10087307 === 'function') {
                try {
                    // In-App Interstitial ‡¶ï‡ßã‡¶° ‡ßß
                    show_10087307({
                        type: 'inApp',
                        inAppSettings: {
                            frequency: 2,
                            capping: 0.1,
                            interval: 30,
                            timeout: 5,
                            everyPage: false
                        }
                    });
                    console.log("Monetag Auto Interstitial fired.");
                } catch(e) {
                    console.error("Monetag Auto Interstitial failed to show:", e);
                }
            }
        };
        
        /**
         * Rewarded Interstitial ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶Ø‡¶º (‡¶ï‡ßã‡¶° ‡ß®)
         */
        const showMonetagRewardedAd = () => {
            if (state.adRewardActive) {
                updateStatusMessage('‡¶¨‡ßã‡¶®‡¶æ‡¶∏‡¶ü‡¶ø ‡¶è‡¶ñ‡¶®‡¶ì ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶Ü‡¶õ‡ßá‡•§', true);
                return;
            }
            
            if (typeof show_10087307 !== 'function') {
                updateStatusMessage('Monetag Ad Script ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§', true);
                return;
            }

            updateStatusMessage(`<i data-lucide="loader-2" class="animate-spin inline-block mr-2 h-4 w-4"></i> ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`);

            // Rewarded interstitial (‡¶ï‡ßã‡¶° ‡ß®)
            show_10087307().then(() => {
                // SUCCESS: ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡ßá‡¶õ‡ßá/‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡•§
                const duration = 5 * 60; // 5 ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞
                state.coinMultiplier = 5;
                state.adRewardActive = true;
                state.adRewardDuration = duration;
                
                // ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶ó‡ßã‡¶®‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ
                const timer = setInterval(() => {
                    state.adRewardDuration -= 1;
                    if (state.adRewardDuration <= 0) {
                        clearInterval(timer);
                        state.adRewardActive = false;
                        state.coinMultiplier = 1;
                        updateStatusMessage("‡¶ï‡ßü‡ßá‡¶® ‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡ßü‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑‡•§");
                    }
                    renderApp();
                }, 1000);
                
                updateStatusMessage("‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∏‡¶´‡¶≤! ‡¶ï‡¶Ø‡¶º‡ßá‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡ß´√ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
                renderApp();
            }).catch(e => {
                // FAILURE: Ad ‡¶≤‡ßã‡¶° ‡¶π‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                console.error("Monetag Ad Failed:", e);
                updateStatusMessage("‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶ï‡ßç‡¶∑‡¶£ ‡¶™‡¶∞ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", true);
                renderApp();
            });
        };

        /**
         * Rewarded Popup ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶Ø‡¶º (‡¶ï‡ßã‡¶° ‡ß©)
         */
        const showMonetagRewardedPopup = () => {
            if (typeof show_10087307 !== 'function') {
                updateStatusMessage('Monetag Ad Script ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§', true);
                return;
            }

            updateStatusMessage(`<i data-lucide="loader-2" class="animate-spin inline-block mr-2 h-4 w-4"></i> ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`);

            // Rewarded Popup (‡¶ï‡ßã‡¶° ‡ß©)
            show_10087307('pop').then(() => {
                // ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡ßÅ‡¶∞‡ßã ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá‡¶õ‡ßá
                const bonusAmount = 100; // 100 ‡¶ï‡¶Ø‡¶º‡ßá‡¶® ‡¶¨‡ßã‡¶®‡¶æ‡¶∏
                
                // ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                if (db && state.userId) {
                    runTransaction(db, async (transaction) => {
                        const userRef = getCollectionRef('user_data_doc');
                        const userSnap = await transaction.get(userRef);

                        if (!userSnap.exists()) {
                            throw "User does not exist!";
                        }

                        const newBalance = (userSnap.data().balance || 0) + bonusAmount;
                        
                        transaction.update(userRef, { balance: newBalance });

                        const transactionRef = getCollectionRef('transactions');
                        transaction.set(doc(transactionRef), {
                            type: 'AD_REWARD',
                            amount: bonusAmount,
                            timestamp: serverTimestamp(),
                        });
                    }).then(() => {
                        updateStatusMessage(`‡¶∏‡¶´‡¶≤! ${bonusAmount} ‡¶ï‡¶Ø‡¶º‡ßá‡¶® ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®!`);
                        renderApp();
                    }).catch(e => {
                        console.error("Bonus transaction failed: ", e);
                        updateStatusMessage("‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", true);
                    });
                }
            }).catch(e => {
                // ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßá‡¶õ‡ßá ‡¶¨‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                console.error("Monetag Popup Ad Failed:", e);
                updateStatusMessage("‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§", true);
                renderApp();
            });
        };

        // --- Firebase Auth ‡¶ì Init ---
        const setupUserDocument = async (uid) => {
            if (!db) return;
            const userRef = getCollectionRef('user_data_doc', uid);
            const userSnap = await getDoc(userRef);

            if (!userSnap.exists()) {
                const initialData = {
                    uid: uid,
                    telegramUsername: state.userData.telegramUsername,
                    telegramId: state.userData.telegramId,
                    balance: 0,
                    referralCode: uid,
                    referredBy: null,
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp(),
                };
                await setDoc(userRef, initialData);
            } else {
                await updateDoc(userRef, { 
                    lastActive: serverTimestamp(),
                    telegramUsername: state.userData.telegramUsername
                });
            }
        };

        const initFirebaseAndAuth = async () => {
            try {
                // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
                loadTelegramData();
                
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase configuration missing.");
                    state.isAuthReady = true;
                    renderApp();
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const signIn = async () => {
                    if (initialAuthToken) {
                        // ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ID ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                };

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        state.userId = user.uid;
                        await setupUserDocument(user.uid);
                        setupDataListeners();
                        showAutoInterstitialAd(); // AUTHENTICATED ‡¶π‡¶≤‡ßá Auto Ad ‡¶ö‡¶æ‡¶≤‡ßÅ
                    } else if (!state.userId) {
                        await signIn();
                    }
                    state.isAuthReady = true;
                    renderApp(); 
                });
            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                state.isAuthReady = true;
                renderApp();
            }
        };

        // --- ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞‡ßç‡¶∏ ---
        const setupDataListeners = () => {
            if (!db || !state.userId) return;

            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            const userRef = getCollectionRef('user_data_doc');
            const unsubUser = onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.userData = { ...state.userData, ...docSnap.data() };
                    renderApp();
                } else {
                    console.error("User document missing!");
                }
            });
            unsubscribeListeners.push(unsubUser);

            const transactionsCol = getCollectionRef('transactions');
            const unsubTransactions = onSnapshot(transactionsCol, (snapshot) => {
                const history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                history.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                state.transactions = history;
                if (state.currentPage === 'profile') renderApp();
            });
            unsubscribeListeners.push(unsubTransactions);

            const newsCol = getCollectionRef('news');
            const unsubNews = onSnapshot(newsCol, (snapshot) => {
                const posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                posts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                state.newsPosts = posts;
                if (state.currentPage === 'news') renderApp();
            });
            unsubscribeListeners.push(unsubNews);

            fetchReferralData();
        };
        
        const fetchReferralData = async () => {
             if (!db || !state.userId) return;
             const referralsCol = getCollectionRef('referrals');
             const qReferrals = query(referralsCol, where('referrerId', '==', state.userId));
             
             try {
                const referralSnap = await getDocs(qReferrals);
                state.referrals = referralSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentPage === 'profile') renderApp();
             } catch (e) {
                 console.error("Error fetching referrals:", e);
             }
        };

        // --- ‡¶ï‡ßã‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï: Grip/Tap ---
        const distributeReferralCommission = async (transaction, currentUserData, baseCoinAmount) => {
            let currentReferrerId = currentUserData.referredBy;
            let generation = 1;

            while (currentReferrerId && generation <= 3) {
                const commissionRate = REFERRAL_COMMISSION[generation];
                const commissionAmount = Math.floor(baseCoinAmount * commissionRate);

                if (commissionAmount > 0) {
                    const referrerRef = getCollectionRef('user_data_doc', currentReferrerId);
                    const referrerSnap = await transaction.get(referrerRef);

                    if (referrerSnap.exists()) {
                        const referrerData = referrerSnap.data();
                        const newReferrerBalance = (referrerData.balance || 0) + commissionAmount;
                        
                        transaction.update(referrerRef, { balance: newReferrerBalance });

                        const transactionRef = getCollectionRef('transactions', currentReferrerId);
                        transaction.set(doc(transactionRef), {
                            type: 'REFERRAL_COMMISSION',
                            amount: commissionAmount,
                            fromUser: state.userId,
                            generationLevel: generation,
                            timestamp: serverTimestamp(),
                        });
                        
                        currentReferrerId = referrerData.referredBy; 
                        generation++;
                    } else {
                        currentReferrerId = null; 
                    }
                } else {
                    currentReferrerId = null;
                }
            }
        };

        const collectCoins = async () => {
            if (!db || !state.userId) return;
            const finalAmount = state.coinsPerTick * state.coinMultiplier;

            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = getCollectionRef('user_data_doc');
                    const userSnap = await transaction.get(userRef);

                    if (!userSnap.exists()) {
                        throw "User does not exist!";
                    }

                    const newBalance = (userSnap.data().balance || 0) + finalAmount;
                    
                    transaction.update(userRef, { balance: newBalance });

                    const transactionRef = getCollectionRef('transactions');
                    transaction.set(doc(transactionRef), {
                        type: 'GRIP',
                        amount: finalAmount,
                        multiplier: state.coinMultiplier,
                        timestamp: serverTimestamp(),
                    });
                    
                    await distributeReferralCommission(transaction, userSnap.data(), finalAmount);
                });
            } catch (e) {
                console.error("Grip Transaction failed: ", e);
            }
        };

        let tapTimerRef;
        const handleTapStart = () => {
            if (state.isTapping || !state.userId) return;

            state.isTapping = true;
            
            state.tapInterval = setInterval(collectCoins, 1000);

            tapTimerRef = setInterval(() => {
                state.coinMultiplier = Math.min(5, state.coinMultiplier + 1);
                renderApp();
            }, 200); 

            renderApp();
        };

        const handleTapEnd = () => {
            if (!state.isTapping) return;

            state.isTapping = false;
            clearInterval(state.tapInterval);
            clearInterval(tapTimerRef);
            
            if (!state.adRewardActive) { 
                state.coinMultiplier = 1;
            }
            renderApp();
        };

        // --- ‡¶ï‡ßã‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï: Transfer & News ---
        
        const searchRecipient = async () => {
            const recipientName = document.getElementById('transferRecipient').value;
            state.transferRecipient = recipientName;
            if (!db || !recipientName) {
                updateStatusMessage('‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¶‡¶ø‡¶®‡•§', true);
                return;
            }
            state.recipientData = null;
            updateStatusMessage(`<i data-lucide="loader-2" class="animate-spin inline-block mr-2 h-4 w-4"></i> ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`);
            
            try {
                const usersCol = collection(db, 'artifacts', appId, 'users');
                const userQuerySnap = await getDocs(usersCol);
                
                const foundUser = userQuerySnap.docs
                    .map(doc => ({ uid: doc.id, ...doc.data() }))
                    .find(user => user.telegramUsername === recipientName && user.uid !== state.userId);

                if (foundUser) {
                    state.recipientData = foundUser;
                    updateStatusMessage(`‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá: ${foundUser.telegramUsername}`);
                } else {
                    updateStatusMessage('‡¶è‡¶á Telegram ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§', true);
                }

            } catch (e) {
                console.error("Recipient search failed:", e);
                updateStatusMessage('‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', true);
            }
            renderApp();
        };

        const confirmTransfer = async () => {
            const amount = parseFloat(document.getElementById('transferAmount').value);
            if (!state.recipientData || !amount || amount <= 0 || amount > state.userData.balance) {
                updateStatusMessage('‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¨‡¶æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§', true);
                return;
            }
            
            updateStatusMessage(`<i data-lucide="loader-2" class="animate-spin inline-block mr-2 h-4 w-4"></i> ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ö‡¶≤‡¶õ‡ßá...`);

            try {
                await runTransaction(db, async (transaction) => {
                    const senderRef = getCollectionRef('user_data_doc', state.userId);
                    const recipientRef = getCollectionRef('user_data_doc', state.recipientData.uid);
                    
                    const [senderSnap, recipientSnap] = await Promise.all([
                        transaction.get(senderRef),
                        transaction.get(recipientRef)
                    ]);

                    if (!senderSnap.exists() || !recipientSnap.exists()) {
                        throw "Sender or Recipient document missing!";
                    }

                    const senderBalance = senderSnap.data().balance || 0;
                    if (senderBalance < amount) {
                        throw "Insufficient balance!";
                    }

                    const newSenderBalance = senderBalance - amount;
                    const newRecipientBalance = (recipientSnap.data().balance || 0) + amount;
                    
                    transaction.update(senderRef, { balance: newSenderBalance });
                    transaction.update(recipientRef, { balance: newRecipientBalance });

                    const senderTxCol = getCollectionRef('transactions', state.userId);
                    await addDoc(senderTxCol, {
                        type: 'TRANSFER_SENT',
                        amount: -amount,
                        recipient: state.recipientData.uid,
                        timestamp: serverTimestamp(),
                    });
                    
                    const recipientTxCol = getCollectionRef('transactions', state.recipientData.uid);
                    await addDoc(recipientTxCol, {
                        type: 'TRANSFER_RECEIVED',
                        amount: amount,
                        sender: state.userId,
                        timestamp: serverTimestamp(),
                    });
                });
                
                updateStatusMessage(`‡¶∏‡¶´‡¶≤! ${amount} ‡¶ï‡¶Ø‡¶º‡ßá‡¶® ${state.recipientData.telegramUsername}-‡¶ï‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);
                state.transferAmount = '';
                state.recipientData = null;
                state.transferRecipient = '';
                document.getElementById('transferRecipient').value = '';
                document.getElementById('transferAmount').value = '';
                renderApp();

            } catch (e) {
                console.error("Transfer Transaction failed: ", e);
                updateStatusMessage(`‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${e.toString()}`, true);
                renderApp();
            }
        };

        const handlePostNews = async () => {
            const newPostTitle = document.getElementById('newPostTitle').value;
            const newPostCaption = document.getElementById('newPostCaption').value;
            const newPostLink = document.getElementById('newPostLink').value;

            if (!db || state.userId !== ADMIN_UID || !newPostTitle || !newPostCaption || !newPostLink) {
                updateStatusMessage('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶Ø‡¶º ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§', true);
                renderApp();
                return;
            }

            updateStatusMessage(`<i data-lucide="loader-2" class="animate-spin inline-block mr-2 h-4 w-4"></i> ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`);
            renderApp();

            try {
                const newsCol = getCollectionRef('news');
                await addDoc(newsCol, {
                    adminUid: state.userId,
                    title: newPostTitle,
                    caption: newPostCaption,
                    buttonLink: newPostLink,
                    timestamp: serverTimestamp(),
                });
                updateStatusMessage('‡¶®‡¶ø‡¶â‡¶ú ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                document.getElementById('newPostTitle').value = '';
                document.getElementById('newPostCaption').value = '';
                document.getElementById('newPostLink').value = '';
            } catch (e) {
                console.error("News post failed:", e);
                updateStatusMessage('‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', true);
            }
            renderApp();
        };


        // --- ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---

        const renderLoading = () => `
            <div class="flex items-center justify-center h-full text-white/70">
                <i data-lucide="loader-2" class="animate-spin h-8 w-8 mr-2"></i>
                <p>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
            </div>
        `;
        
        const renderGripPage = () => {
            const { userData, coinMultiplier, coinsPerTick, isTapping, adRewardActive, adRewardDuration, statusMessage } = state;
            
            const minutes = Math.floor(adRewardDuration / 60);
            const seconds = adRewardDuration % 60;
            const formattedTime = `${minutes}‡¶Æ‡¶ø ${seconds}‡¶∏‡ßá`;
            
            return `
                <div class="flex flex-col items-center p-4 h-full bg-slate-900 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-teal-400 mb-2 mt-4">‡¶ï‡ßü‡ßá‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                    <p class="text-sm text-gray-400 mb-6">
                        ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®! ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ${coinMultiplier}√ó ‡¶∏‡ßç‡¶™‡¶ø‡¶°‡•§ ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá ${coinsPerTick * coinMultiplier} ‡¶ï‡¶Ø‡¶º‡ßá‡¶®‡•§
                    </p>
                    
                    <!-- Ad Reward Status -->
                    <div class="w-full max-w-sm p-3 mb-6 rounded-lg shadow-lg ${adRewardActive ? 'bg-green-700/50 border border-green-500' : 'bg-slate-800/50 border border-slate-700'}">
                        <div class="flex justify-between items-center text-white">
                            <p class="text-sm font-semibold">
                                <i data-lucide="zap" class="inline-block h-4 w-4 mr-1 text-yellow-400"></i>
                                ${adRewardActive ? '‡ß´√ó ‡¶∏‡ßç‡¶™‡¶ø‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠!' : '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶®‡¶ø‡¶®'}
                            </p>
                            <span class="text-xs text-yellow-300">
                                ${adRewardActive ? `‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¨‡¶æ‡¶ï‡¶ø: ${formattedTime}` : '‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º'}
                            </span>
                        </div>
                        <button 
                            onclick="showMonetagRewardedAd()"
                            ${adRewardActive ? 'disabled' : ''}
                            class="w-full mt-2 py-2 text-sm font-bold rounded-md transition duration-200 
                                bg-teal-600 hover:bg-teal-700 disabled:bg-slate-700 disabled:text-gray-400"
                        >
                            ${adRewardActive ? '‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶ö‡¶≤‡¶õ‡ßá...' : 'Rewarded Ad ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (‡ß´√ó ‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡ßü‡¶æ‡¶∞)'}
                        </button>
                        <p class="text-xs text-center text-gray-400 mt-2">
                            ${statusMessage ? statusMessage : ''}
                        </p>
                    </div>

                    <!-- Bonus Coin Button -->
                    <div class="w-full max-w-sm p-3 mb-4 rounded-lg shadow-lg bg-purple-800/50 border border-purple-700">
                        <div class="flex justify-between items-center text-white">
                            <p class="text-sm font-semibold">
                                <i data-lucide="gift" class="inline-block h-4 w-4 mr-1 text-yellow-400"></i>
                                ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡¶æ ‡¶ï‡¶Ø‡¶º‡ßá‡¶® ‡¶¨‡ßã‡¶®‡¶æ‡¶∏
                            </p>
                        </div>
                        <button 
                            onclick="showMonetagRewardedPopup()"
                            class="w-full mt-2 py-2 text-sm font-bold rounded-md transition duration-200 
                                bg-purple-600 hover:bg-purple-700"
                        >
                            Rewarded Popup ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (‡ßß‡ß¶‡ß¶ ‡¶ï‡¶Ø‡¶º‡ßá‡¶® ‡¶¨‡ßã‡¶®‡¶æ‡¶∏)
                        </button>
                    </div>

                    <!-- Tapping Zone -->
                    <div 
                        id="tapZone"
                        ontouchstart="handleTapStart()"
                        ontouchend="handleTapEnd()"
                        onmousedown="handleTapStart()"
                        onmouseup="handleTapEnd()"
                        class="w-full max-w-xs aspect-square flex items-center justify-center rounded-full shadow-2xl transition-all duration-100 ease-out 
                            ${isTapping ? 'bg-teal-700/80 scale-105' : 'bg-slate-800/80 hover:bg-slate-700/80'} 
                            ${coinMultiplier > 1 ? 'border-4 border-yellow-400' : 'border border-slate-600'}"
                    >
                        <div class="text-center">
                            <p class="text-6xl" role="img" aria-label="Fist">üëä</p>
                            <p class="text-2xl font-extrabold mt-2 ${coinMultiplier > 1 ? 'text-yellow-400 animate-pulse' : 'text-white'}">
                                ${coinMultiplier}√ó
                            </p>
                            ${isTapping ? '<p class="text-sm text-gray-300 mt-1">‡¶ï‡¶Ø‡¶º‡ßá‡¶® ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ö‡¶≤‡¶õ‡ßá...</p>' : ''}
                        </div>
                    </div>

                    <p class="mt-4 text-white text-3xl font-bold">
                        ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ${formatBalance(userData?.balance)}
                    </p>
                    <p class="text-sm text-gray-500">‡¶á‡¶â‡¶ú‡¶æ‡¶∞: ${state.userData.telegramUsername || 'N/A'}</p>
                </div>
            `;
        };

        const renderTransferPage = () => {
            const { userData, transferRecipient, recipientData, statusMessage } = state;
            const recipientUsername = recipientData ? recipientData.telegramUsername : '';

            return `
                <div class="p-4 h-full bg-slate-900 overflow-y-auto text-white">
                    <h2 class="text-2xl font-bold text-teal-400 mb-6 mt-4">‡¶ï‡ßü‡ßá‡¶® ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞</h2>
                    <div class="space-y-4 max-w-md mx-auto">
                    
                        <!-- ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö -->
                        <div class="p-4 bg-slate-800 rounded-lg shadow-xl">
                            <label for="transferRecipient" class="block text-sm font-medium text-gray-300 mb-2">Telegram Username</label>
                            <div class="flex space-x-2">
                                <input
                                    type="text"
                                    id="transferRecipient"
                                    value="${state.transferRecipient}"
                                    oninput="state.transferRecipient = this.value"
                                    placeholder="@username_to_send"
                                    class="flex-grow p-2.5 rounded-md bg-slate-700 border border-slate-600 text-white placeholder-gray-500 focus:ring-teal-500 focus:border-teal-500"
                                />
                                <button
                                    onclick="searchRecipient()"
                                    class="px-4 py-2 bg-pink-600 rounded-md hover:bg-pink-700 transition duration-200 disabled:bg-slate-700"
                                    ${!state.transferRecipient ? 'disabled' : ''}
                                >
                                    ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö
                                </button>
                            </div>
                        </div>

                        <!-- ‡¶∞‡¶ø‡¶∏‡¶ø‡¶≠‡¶æ‡¶∞ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá -->
                        ${recipientData ? `
                            <div class="p-4 bg-slate-700 rounded-lg shadow-xl border border-teal-500/50">
                                <h3 class="text-lg font-semibold text-teal-300">‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï:</h3>
                                <p class="text-white mt-1">‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ: <span class="font-bold">${recipientUsername}</span></p>
                                <p class="text-xs text-gray-400">UID: ${recipientData.uid}</p>
                            </div>
                        ` : ''}
                        
                        <!-- ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶´‡¶∞‡ßç‡¶Æ -->
                        <div class="p-4 bg-slate-800 rounded-lg shadow-xl">
                            <label for="transferAmount" class="block text-sm font-medium text-gray-300 mb-2">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶ï‡ßü‡ßá‡¶®)</label>
                            <input
                                type="number"
                                id="transferAmount"
                                value="${state.transferAmount}"
                                oninput="state.transferAmount = this.value; renderApp()"
                                placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£"
                                class="w-full p-2.5 rounded-md bg-slate-700 border border-slate-600 text-white placeholder-gray-500 focus:ring-teal-500 focus:border-teal-500 mb-4"
                            />
                            
                            <p class="text-sm text-gray-400 mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ${formatBalance(userData?.balance)}</p>

                            <button
                                onclick="confirmTransfer()"
                                ${!recipientData || !state.transferAmount || parseFloat(state.transferAmount) <= 0 || parseFloat(state.transferAmount) > userData?.balance ? 'disabled' : ''}
                                class="w-full py-3 text-lg font-bold rounded-md transition duration-200 
                                    bg-teal-600 hover:bg-teal-700 disabled:bg-slate-700 disabled:text-gray-400"
                            >
                                ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ
                            </button>
                        </div>
                        
                        <!-- ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ -->
                        ${statusMessage ? `
                            <p class="text-center text-sm p-3 bg-slate-700/50 rounded-lg text-yellow-300">
                                ${statusMessage}
                            </p>
                        ` : ''}
                    </div>
                </div>
            `;
        };

        const renderNewsPage = () => {
            const isAdmin = state.userId === ADMIN_UID;
            const { newsPosts, statusMessage } = state;
            
            return `
                <div class="p-4 h-full bg-slate-900 overflow-y-auto text-white">
                    <h2 class="text-2xl font-bold text-teal-400 mb-6 mt-4">‡¶ñ‡¶¨‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</h2>
                    
                    <!-- Admin Posting Form -->
                    ${isAdmin ? `
                        <div class="mb-8 p-4 bg-red-900/40 border border-red-700 rounded-lg max-w-lg mx-auto">
                            <h3 class="text-xl font-semibold text-red-300 mb-3">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶´‡¶∞‡ßç‡¶Æ</h3>
                            <input
                                type="text"
                                id="newPostTitle"
                                placeholder="‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ"
                                class="w-full p-2 mb-2 rounded-md bg-slate-700 border border-slate-600 text-white"
                            />
                            <textarea
                                id="newPostCaption"
                                placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∂‡¶®..."
                                class="w-full p-2 mb-2 rounded-md bg-slate-700 border border-slate-600 text-white h-20"
                            ></textarea>
                            <input
                                type="url"
                                id="newPostLink"
                                placeholder="Join/Check ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï (https://...)"
                                class="w-full p-2 mb-3 rounded-md bg-slate-700 border border-slate-600 text-white"
                            />
                            <button
                                onclick="handlePostNews()"
                                class="w-full py-2 bg-red-600 rounded-md hover:bg-red-700 font-semibold"
                            >
                                ‡¶®‡¶ø‡¶â‡¶ú ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                            </button>
                            ${statusMessage ? `
                                <p class="text-center text-sm p-3 bg-slate-700/50 rounded-lg text-yellow-300 mt-3">
                                    ${statusMessage}
                                </p>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- News Feed -->
                    <div class="space-y-6 max-w-lg mx-auto">
                        ${newsPosts.length > 0 ? 
                            newsPosts.map(post => `
                                <div class="p-4 bg-slate-800 rounded-xl shadow-2xl border border-slate-700 transition hover:border-teal-500/50">
                                    <h3 class="text-xl font-bold text-teal-400 mb-2">${post.title}</h3>
                                    <p class="text-gray-300 mb-3 text-sm">${post.caption}</p>
                                    <div class="flex justify-between items-center">
                                        <a 
                                            href="${post.buttonLink}" 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            class="px-4 py-2 bg-pink-600 text-white text-sm font-semibold rounded-lg hover:bg-pink-700 transition"
                                        >
                                            Join/Check ‡¶ï‡¶∞‡ßÅ‡¶®
                                        </a>
                                        <p class="text-xs text-gray-500">${formatDate(post.timestamp)}</p>
                                    </div>
                                </div>
                            `).join('')
                        : `
                            <p class="text-center text-gray-500 p-8">‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶ø‡¶â‡¶ú ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>
                        `}
                    </div>
                </div>
            `;
        };

        const renderProfilePage = () => {
            const { userData, userId, transactions, referrals } = state;
            
            return `
                <div class="p-4 h-full bg-slate-900 overflow-y-auto text-white">
                    <h2 class="text-2xl font-bold text-teal-400 mb-6 mt-4">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</h2>
                    
                    <div class="max-w-xl mx-auto space-y-8">
                        <!-- ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ì ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° -->
                        <div class="p-6 bg-slate-800 rounded-xl shadow-2xl border border-teal-500/50">
                            <div class="flex items-center space-x-4 mb-4">
                                <i data-lucide="user" class="w-8 h-8 text-pink-400"></i>
                                <div>
                                    <p class="text-lg font-semibold text-gray-300">‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ:</p>
                                    <p class="text-2xl font-bold text-white">${userData?.telegramUsername || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="border-t border-slate-700 pt-4">
                                <p class="text-lg font-semibold text-gray-300">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏:</p>
                                <p class="text-4xl font-extrabold text-teal-400">${formatBalance(userData?.balance)}</p>
                                <p class="text-xs text-gray-500 mt-2 break-all">UID (‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶°): ${userId || 'N/A'}</p>
                            </div>
                        </div>

                        <!-- ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ -->
                        <div class="p-6 bg-slate-800 rounded-xl shadow-2xl border border-slate-700">
                            <h3 class="text-xl font-bold text-pink-400 mb-4">‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° (Gen 1)</h3>
                            <p class="text-sm text-gray-300 mb-4">
                                ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®: Gen 1 (${REFERRAL_COMMISSION[1]*100}%), Gen 2 (${REFERRAL_COMMISSION[2]*100}%), Gen 3 (${REFERRAL_COMMISSION[3]*100}%)
                            </p>
                            
                            <h4 class="font-semibold mt-4 text-gray-300">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ (${referrals.length} ‡¶ú‡¶®):</h4>
                            <div class="h-40 overflow-y-auto mt-2 bg-slate-700 p-2 rounded-lg">
                                ${referrals.length > 0 ? 
                                    referrals.map(r => `
                                        <p class="text-xs text-gray-300 border-b border-slate-600 py-1">
                                            ${r.referredId} (Gen ${r.generationLevel})
                                        </p>
                                    `).join('')
                                : `
                                    <p class="text-center text-gray-500 p-4 text-sm">‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡¶æ‡¶â‡¶ï‡ßá ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø‡•§</p>
                                `}
                            </div>
                        </div>
                        
                        <!-- ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø -->
                        <div class="p-6 bg-slate-800 rounded-xl shadow-2xl border border-slate-700">
                            <h3 class="text-xl font-bold text-teal-400 mb-4">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</h3>
                            
                            <div class="h-64 overflow-y-auto">
                                <table class="min-w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-slate-600 text-gray-400">
                                            <th class="py-2 text-left">‡¶ü‡¶æ‡¶á‡¶™</th>
                                            <th class="py-2 text-right">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                                            <th class="py-2 text-center">‡¶∏‡¶Æ‡¶Ø‡¶º</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${transactions.map(tx => `
                                            <tr class="border-b border-slate-700 last:border-b-0">
                                                <td class="py-2 text-left">
                                                    ${tx.type === 'GRIP' ? '‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π' :
                                                     tx.type === 'TRANSFER_SENT' ? '‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶£' :
                                                     tx.type === 'TRANSFER_RECEIVED' ? '‡¶ó‡ßç‡¶∞‡¶π‡¶£' :
                                                     tx.type === 'REFERRAL_COMMISSION' ? '‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤' : 
                                                     tx.type === 'AD_REWARD' ? '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¨‡ßã‡¶®‡¶æ‡¶∏' : '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø'}
                                                    <span class="text-xs block text-gray-500">
                                                        ${tx.type === 'TRANSFER_SENT' ? `‡¶ï‡ßá: ${tx.recipient.substring(0, 8)}...` :
                                                         tx.type === 'TRANSFER_RECEIVED' ? `‡¶•‡ßá‡¶ï‡ßá: ${tx.sender.substring(0, 8)}...` :
                                                         tx.type === 'REFERRAL_COMMISSION' ? `Gen ${tx.generationLevel} | From: ${tx.fromUser.substring(0, 8)}...` : ''}
                                                    </span>
                                                </td>
                                                <td class="py-2 text-right font-semibold ${tx.amount > 0 ? 'text-green-400' : 'text-red-400'}">
                                                    ${tx.amount > 0 ? `+${formatBalance(tx.amount)}` : formatBalance(tx.amount)}
                                                </td>
                                                <td class="py-2 text-center text-xs text-gray-400">${formatDate(tx.timestamp)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                ${transactions.length === 0 ? '<p class="text-center text-gray-500 p-4">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á‡•§</p>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderPage = (pageId) => {
            switch (pageId) {
                case 'grip': return renderGripPage();
                case 'transfer': return renderTransferPage();
                case 'news': return renderNewsPage();
                case 'profile': return renderProfilePage();
                default: return '<div>Page not found.</div>';
            }
        };

        const renderNavBar = () => {
            const navItems = [
                { id: 'grip', label: 'Grip', icon: 'home' },
                { id: 'transfer', label: 'Transfer', icon: 'send' },
                { id: 'news', label: 'News', icon: 'newspaper' },
                { id: 'profile', label: 'Profile', icon: 'user' },
            ];

            return `
                <nav class="fixed bottom-0 left-0 right-0 h-16 bg-slate-800 border-t border-slate-700 shadow-2xl z-50">
                    <div class="flex justify-around h-full max-w-lg mx-auto">
                        ${navItems.map(item => `
                            <button
                                onclick="state.currentPage = '${item.id}'; updateStatusMessage(null); renderApp();"
                                class="flex flex-col items-center justify-center p-2 text-xs transition-all duration-200 
                                    ${state.currentPage === item.id ? 'text-teal-400 scale-110' : 'text-gray-400 hover:text-teal-300'}"
                            >
                                <i data-lucide="${item.icon}" class="w-6 h-6 mb-0.5"></i>
                                <span class="font-medium">${item.label}</span>
                            </button>
                        `).join('')}
                    </div>
                </nav>
            `;
        };


        // --- ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
        const renderApp = () => {
            const appContainer = document.getElementById('app-container');
            const navContainer = document.getElementById('nav-container');

            if (!state.isAuthReady) {
                appContainer.innerHTML = renderLoading();
            } else {
                appContainer.innerHTML = renderPage(state.currentPage);
            }
            
            navContainer.innerHTML = renderNavBar();
            replaceIcons(); 
        };

        // --- ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ ---
        window.onload = () => {
            initFirebaseAndAuth();
            renderApp();
        };
        
        // ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
        window.showMonetagRewardedAd = showMonetagRewardedAd;
        window.showMonetagRewardedPopup = showMonetagRewardedPopup;
        window.handleTapStart = handleTapStart;
        window.handleTapEnd = handleTapEnd;
        window.searchRecipient = searchRecipient;
        window.confirmTransfer = confirmTransfer;
        window.handlePostNews = handlePostNews;
        window.state = state; 
        window.renderApp = renderApp; 
        window.updateStatusMessage = updateStatusMessage;
    </script>
</head>
<body class="bg-slate-950 font-sans min-h-screen text-white">
    <div id="app" class="flex flex-col h-screen">
        <!-- Main Content Area -->
        <div id="app-container" class="flex-grow overflow-hidden pb-16">
            <!-- Content will be rendered here -->
        </div>

        <!-- Navigation Bar Container -->
        <div id="nav-container">
            <!-- Navigation will be rendered here -->
        </div>
    </div>
</body>
</html>
