<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grip Coin Mini App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for aesthetic UI -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Monetag Script -->
    <script type="text/javascript">
        (function() {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = '//monetag.com/some-path/loader.js';
            script.async = true;
            document.head.appendChild(script);
        })();
    </script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, serverTimestamp, runTransaction, getDoc, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- গ্লোবাল ভেরিয়েবল ---
        // টেলিগ্রাম Mini App থেকে ডেটা পাওয়ার জন্য
        const tg = window.Telegram?.WebApp;
        let appId = 'default-app-id';
        let firebaseConfig = {};
        let initialAuthToken = null;
        
        // টেলিগ্রাম থেকে ডেটা লোড করার ফাংশন
        const loadTelegramData = () => {
            if (tg) {
                // টেলিগ্রাম থেকে ইউজার ডেটা পাওয়া যাচ্ছে
                const user = tg.initDataUnsafe?.user;
                const queryId = tg.initDataUnsafe?.query_id;
                
                if (user) {
                    // টেলিগ্রাম ইউজারনেম এবং ID সেট করা
                    state.userData.telegramUsername = user.username || `tg_user_${user.id}`;
                    state.userData.telegramId = user.id;
                    
                    // Firebase কনফিগারেশন সেট করা (আপনার নিজের কনফিগারেশন ব্যবহার করুন)
                    firebaseConfig = {
                        apiKey: "your-api-key",
                        authDomain: "your-project.firebaseapp.com",
                        projectId: "your-project-id",
                        storageBucket: "your-project.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "your-app-id"
                    };
                    
                    // টেলিগ্রাম ইউজার ID ব্যবহার করে অথেন্টিকেশন টোকেন তৈরি করা
                    initialAuthToken = user.id.toString();
                    
                    appId = `telegram-${user.id}`;
                }
                
                // টেলিগ্রাম থিম সাপোর্ট
                if (tg.colorScheme === 'dark') {
                    document.body.classList.add('bg-slate-950');
                } else {
                    document.body.classList.add('bg-gray-100');
                    document.body.classList.remove('bg-slate-950');
                }
            } else {
                console.warn("Telegram WebApp not detected, using default data");
                // ডেভেলপমেন্টের জন্য ডিফল্ট ডেটা
                firebaseConfig = {
                    apiKey: "dev-api-key",
                    authDomain: "dev-project.firebaseapp.com",
                    projectId: "dev-project-id",
                    storageBucket: "dev-project.appspot.com",
                    messagingSenderId: "987654321",
                    appId: "dev-app-id"
                };
                initialAuthToken = "dev-token-" + Date.now();
            }
        };
        
        // অ্যাডমিনের UID এবং কমিশন রেট
        const ADMIN_UID = "7243906826";
        const REFERRAL_COMMISSION = { 1: 0.05, 2: 0.02, 3: 0.01 };
        
        let app, db, auth;
        let unsubscribeListeners = []; 
        
        // --- অ্যাপ স্টেট ---
        let state = {
            userId: null,
            isAuthReady: false,
            currentPage: 'grip',
            userData: { 
                balance: 0, 
                telegramUsername: 'Loading...',
                telegramId: null
            },
            transactions: [],
            newsPosts: [],
            referrals: [],
            
            // Grip State
            isTapping: false,
            tapInterval: null,
            coinMultiplier: 1,
            coinsPerTick: 5,
            adRewardActive: false,
            adRewardDuration: 0,

            // Transfer/Status State
            transferRecipient: '',
            transferAmount: '',
            recipientData: null,
            statusMessage: null,
        };

        // --- ইউটিলিটি ফাংশন ---

        const getCollectionRef = (type, uid = state.userId) => {
            if (!db) return null;
            switch (type) {
                case 'user_data_doc': 
                    return doc(db, 'artifacts', appId, 'users', uid, 'user_data');
                case 'transactions':
                    return collection(db, 'artifacts', appId, 'users', uid, 'transactions');
                case 'news':
                    return collection(db, 'artifacts', appId, 'public', 'news');
                case 'referrals':
                    return collection(db, 'artifacts', appId, 'public', 'referrals');
                default:
                    return null;
            }
        };

        const formatBalance = (num) => (num || 0).toLocaleString('en-US', { maximumFractionDigits: 2 });
        
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('bn-BD', {
                day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        };

        const updateStatusMessage = (message, isError = false) => {
            state.statusMessage = message;
            if (state.currentPage === 'transfer' || state.currentPage === 'news' || state.currentPage === 'grip') {
                renderApp();
            }
        };

        const replaceIcons = () => {
            lucide.createIcons();
        };

        // --- Monetag Integration ---
        
        /**
         * In-App Interstitial বিজ্ঞাপন দেখায় (কোড ১)
         */
        const showAutoInterstitialAd = () => {
            if (typeof show_10087307 === 'function') {
                try {
                    // In-App Interstitial কোড ১
                    show_10087307({
                        type: 'inApp',
                        inAppSettings: {
                            frequency: 2,
                            capping: 0.1,
                            interval: 30,
                            timeout: 5,
                            everyPage: false
                        }
                    });
                    console.log("Monetag Auto Interstitial fired.");
                } catch(e) {
                    console.error("Monetag Auto Interstitial failed to show:", e);
                }
            }
        };
        
        /**
         * Rewarded Interstitial বিজ্ঞাপন দেখায় (কোড ২)
         */
        const showMonetagRewardedAd = () => {
            if (state.adRewardActive) {
                updateStatusMessage('বোনাসটি এখনও সক্রিয় আছে।', true);
                return;
            }
            
            if (typeof show_10087307 !== 'function') {
                updateStatusMessage('Monetag Ad Script লোড হয়নি।', true);
                return;
            }

            updateStatusMessage(`<i data-lucide="loader-2" class="animate-spin inline-block mr-2 h-4 w-4"></i> বিজ্ঞাপন লোড হচ্ছে...`);

            // Rewarded interstitial (কোড ২)
            show_10087307().then(() => {
                // SUCCESS: ব্যবহারকারী বিজ্ঞাপনটি দেখেছে/বন্ধ করেছে।
                const duration = 5 * 60; // 5 মিনিটের জন্য পুরস্কার
                state.coinMultiplier = 5;
                state.adRewardActive = true;
                state.adRewardDuration = duration;
                
                // পুরস্কারের সময় গোনা শুরু
                const timer = setInterval(() => {
                    state.adRewardDuration -= 1;
                    if (state.adRewardDuration <= 0) {
                        clearInterval(timer);
                        state.adRewardActive = false;
                        state.coinMultiplier = 1;
                        updateStatusMessage("কয়েন মাল্টিপ্লায়ার শেষ।");
                    }
                    renderApp();
                }, 1000);
                
                updateStatusMessage("বিজ্ঞাপন সফল! কয়েন সংগ্রহ ৫× হয়েছে!");
                renderApp();
            }).catch(e => {
                // FAILURE: Ad লোড হতে ব্যর্থ হয়েছে
                console.error("Monetag Ad Failed:", e);
                updateStatusMessage("বিজ্ঞাপন লোড হতে ব্যর্থ। কিছুক্ষণ পর আবার চেষ্টা করুন।", true);
                renderApp();
            });
        };

        /**
         * Rewarded Popup বিজ্ঞাপন দেখায় (কোড ৩)
         */
        const showMonetagRewardedPopup = () => {
            if (typeof show_10087307 !== 'function') {
                updateStatusMessage('Monetag Ad Script লোড হয়নি।', true);
                return;
            }

            updateStatusMessage(`<i data-lucide="loader-2" class="animate-spin inline-block mr-2 h-4 w-4"></i> বিজ্ঞাপন লোড হচ্ছে...`);

            // Rewarded Popup (কোড ৩)
            show_10087307('pop').then(() => {
                // ব্যবহারকারী পুরো বিজ্ঞাপন দেখেছে
                const bonusAmount = 100; // 100 কয়েন বোনাস
                
                // বোনাস যোগ করা
                if (db && state.userId) {
                    runTransaction(db, async (transaction) => {
                        const userRef = getCollectionRef('user_data_doc');
                        const userSnap = await transaction.get(userRef);

                        if (!userSnap.exists()) {
                            throw "User does not exist!";
                        }

                        const newBalance = (userSnap.data().balance || 0) + bonusAmount;
                        
                        transaction.update(userRef, { balance: newBalance });

                        const transactionRef = getCollectionRef('transactions');
                        transaction.set(doc(transactionRef), {
                            type: 'AD_REWARD',
                            amount: bonusAmount,
                            timestamp: serverTimestamp(),
                        });
                    }).then(() => {
                        updateStatusMessage(`সফল! ${bonusAmount} কয়েন বোনাস পেয়েছেন!`);
                        renderApp();
                    }).catch(e => {
                        console.error("Bonus transaction failed: ", e);
                        updateStatusMessage("বোনাস যোগ করতে সমস্যা হয়েছে।", true);
                    });
                }
            }).catch(e => {
                // ব্যবহারকারী বিজ্ঞাপন বন্ধ করেছে বা ত্রুটি হয়েছে
                console.error("Monetag Popup Ad Failed:", e);
                updateStatusMessage("বিজ্ঞাপন সম্পূর্ণ হয়নি।", true);
                renderApp();
            });
        };

        // --- Firebase Auth ও Init ---
        const setupUserDocument = async (uid) => {
            if (!db) return;
            const userRef = getCollectionRef('user_data_doc', uid);
            const userSnap = await getDoc(userRef);

            if (!userSnap.exists()) {
                const initialData = {
                    uid: uid,
                    telegramUsername: state.userData.telegramUsername,
                    telegramId: state.userData.telegramId,
                    balance: 0,
                    referralCode: uid,
                    referredBy: null,
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp(),
                };
                await setDoc(userRef, initialData);
            } else {
                await updateDoc(userRef, { 
                    lastActive: serverTimestamp(),
                    telegramUsername: state.userData.telegramUsername
                });
            }
        };

        const initFirebaseAndAuth = async () => {
            try {
                // প্রথমে টেলিগ্রাম ডেটা লোড করা
                loadTelegramData();
                
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase configuration missing.");
                    state.isAuthReady = true;
                    renderApp();
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const signIn = async () => {
                    if (initialAuthToken) {
                        // টেলিগ্রাম ইউজার ID ব্যবহার করে কাস্টম টোকেন তৈরি করা
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                };

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        state.userId = user.uid;
                        await setupUserDocument(user.uid);
                        setupDataListeners();
                        showAutoInterstitialAd(); // AUTHENTICATED হলে Auto Ad চালু
                    } else if (!state.userId) {
                        await signIn();
                    }
                    state.isAuthReady = true;
                    renderApp(); 
                });
            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                state.isAuthReady = true;
                renderApp();
            }
        };

        // --- ডেটা লিসেনার্স ---
        const setupDataListeners = () => {
            if (!db || !state.userId) return;

            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            const userRef = getCollectionRef('user_data_doc');
            const unsubUser = onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.userData = { ...state.userData, ...docSnap.data() };
                    renderApp();
                } else {
                    console.error("User document missing!");
                }
            });
            unsubscribeListeners.push(unsubUser);

            const transactionsCol = getCollectionRef('transactions');
            const unsubTransactions = onSnapshot(transactionsCol, (snapshot) => {
                const history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                history.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                state.transactions = history;
                if (state.currentPage === 'profile') renderApp();
            });
            unsubscribeListeners.push(unsubTransactions);

            const newsCol = getCollectionRef('news');
            const unsubNews = onSnapshot(newsCol, (snapshot) => {
                const posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                posts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                state.newsPosts = posts;
                if (state.currentPage === 'news') renderApp();
            });
            unsubscribeListeners.push(unsubNews);

            fetchReferralData();
        };
        
        const fetchReferralData = async () => {
             if (!db || !state.userId) return;
             const referralsCol = getCollectionRef('referrals');
             const qReferrals = query(referralsCol, where('referrerId', '==', state.userId));
             
             try {
                const referralSnap = await getDocs(qReferrals);
                state.referrals = referralSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentPage === 'profile') renderApp();
             } catch (e) {
                 console.error("Error fetching referrals:", e);
             }
        };

        // --- কোর লজিক: Grip/Tap ---
        const distributeReferralCommission = async (transaction, currentUserData, baseCoinAmount) => {
            let currentReferrerId = currentUserData.referredBy;
            let generation = 1;

            while (currentReferrerId && generation <= 3) {
                const commissionRate = REFERRAL_COMMISSION[generation];
                const commissionAmount = Math.floor(baseCoinAmount * commissionRate);

                if (commissionAmount > 0) {
                    const referrerRef = getCollectionRef('user_data_doc', currentReferrerId);
                    const referrerSnap = await transaction.get(referrerRef);

                    if (referrerSnap.exists()) {
                        const referrerData = referrerSnap.data();
                        const newReferrerBalance = (referrerData.balance || 0) + commissionAmount;
                        
                        transaction.update(referrerRef, { balance: newReferrerBalance });

                        const transactionRef = getCollectionRef('transactions', currentReferrerId);
                        transaction.set(doc(transactionRef), {
                            type: 'REFERRAL_COMMISSION',
                            amount: commissionAmount,
                            fromUser: state.userId,
                            generationLevel: generation,
                            timestamp: serverTimestamp(),
                        });
                        
                        currentReferrerId = referrerData.referredBy; 
                        generation++;
                    } else {
                        currentReferrerId = null; 
                    }
                } else {
                    currentReferrerId = null;
                }
            }
        };

        const collectCoins = async () => {
            if (!db || !state.userId) return;
            const finalAmount = state.coinsPerTick * state.coinMultiplier;

            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = getCollectionRef('user_data_doc');
                    const userSnap = await transaction.get(userRef);

                    if (!userSnap.exists()) {
                        throw "User does not exist!";
                    }

                    const newBalance = (userSnap.data().balance || 0) + finalAmount;
                    
                    transaction.update(userRef, { balance: newBalance });

                    const transactionRef = getCollectionRef('transactions');
                    transaction.set(doc(transactionRef), {
                        type: 'GRIP',
                        amount: finalAmount,
                        multiplier: state.coinMultiplier,
                        timestamp: serverTimestamp(),
                    });
                    
                    await distributeReferralCommission(transaction, userSnap.data(), finalAmount);
                });
            } catch (e) {
                console.error("Grip Transaction failed: ", e);
            }
        };

        let tapTimerRef;
        const handleTapStart = () => {
            if (state.isTapping || !state.userId) return;

            state.isTapping = true;
            
            state.tapInterval = setInterval(collectCoins, 1000);

            tapTimerRef = setInterval(() => {
                state.coinMultiplier = Math.min(5, state.coinMultiplier + 1);
                renderApp();
            }, 200); 

            renderApp();
        };

        const handleTapEnd = () => {
            if (!state.isTapping) return;

            state.isTapping = false;
            clearInterval(state.tapInterval);
            clearInterval(tapTimerRef);
            
            if (!state.adRewardActive) { 
                state.coinMultiplier = 1;
            }
            renderApp();
        };

        // --- কোর লজিক: Transfer & News ---
        
        const searchRecipient = async () => {
            const recipientName = document.getElementById('transferRecipient').value;
            state.transferRecipient = recipientName;
            if (!db || !recipientName) {
                updateStatusMessage('ইউজারনেম দিন।', true);
                return;
            }
            state.recipientData = null;
            updateStatusMessage(`<i data-lucide="loader-2" class="animate-spin inline-block mr-2 h-4 w-4"></i> ইউজার সার্চ করা হচ্ছে...`);
            
            try {
                const usersCol = collection(db, 'artifacts', appId, 'users');
                const userQuerySnap = await getDocs(usersCol);
                
                const foundUser = userQuerySnap.docs
                    .map(doc => ({ uid: doc.id, ...doc.data() }))
                    .find(user => user.telegramUsername === recipientName && user.uid !== state.userId);

                if (foundUser) {
                    state.recipientData = foundUser;
                    updateStatusMessage(`ইউজার পাওয়া গেছে: ${foundUser.telegramUsername}`);
                } else {
                    updateStatusMessage('এই Telegram ইউজারনেম খুঁজে পাওয়া যায়নি।', true);
                }

            } catch (e) {
                console.error("Recipient search failed:", e);
                updateStatusMessage('সার্চ করতে সমস্যা হয়েছে।', true);
            }
            renderApp();
        };

        const confirmTransfer = async () => {
            const amount = parseFloat(document.getElementById('transferAmount').value);
            if (!state.recipientData || !amount || amount <= 0 || amount > state.userData.balance) {
                updateStatusMessage('টাকা বা ইউজারনেম সঠিক নয়।', true);
                return;
            }
            
            updateStatusMessage(`<i data-lucide="loader-2" class="animate-spin inline-block mr-2 h-4 w-4"></i> ট্রান্সফার প্রক্রিয়া চলছে...`);

            try {
                await runTransaction(db, async (transaction) => {
                    const senderRef = getCollectionRef('user_data_doc', state.userId);
                    const recipientRef = getCollectionRef('user_data_doc', state.recipientData.uid);
                    
                    const [senderSnap, recipientSnap] = await Promise.all([
                        transaction.get(senderRef),
                        transaction.get(recipientRef)
                    ]);

                    if (!senderSnap.exists() || !recipientSnap.exists()) {
                        throw "Sender or Recipient document missing!";
                    }

                    const senderBalance = senderSnap.data().balance || 0;
                    if (senderBalance < amount) {
                        throw "Insufficient balance!";
                    }

                    const newSenderBalance = senderBalance - amount;
                    const newRecipientBalance = (recipientSnap.data().balance || 0) + amount;
                    
                    transaction.update(senderRef, { balance: newSenderBalance });
                    transaction.update(recipientRef, { balance: newRecipientBalance });

                    const senderTxCol = getCollectionRef('transactions', state.userId);
                    await addDoc(senderTxCol, {
                        type: 'TRANSFER_SENT',
                        amount: -amount,
                        recipient: state.recipientData.uid,
                        timestamp: serverTimestamp(),
                    });
                    
                    const recipientTxCol = getCollectionRef('transactions', state.recipientData.uid);
                    await addDoc(recipientTxCol, {
                        type: 'TRANSFER_RECEIVED',
                        amount: amount,
                        sender: state.userId,
                        timestamp: serverTimestamp(),
                    });
                });
                
                updateStatusMessage(`সফল! ${amount} কয়েন ${state.recipientData.telegramUsername}-কে পাঠানো হয়েছে।`);
                state.transferAmount = '';
                state.recipientData = null;
                state.transferRecipient = '';
                document.getElementById('transferRecipient').value = '';
                document.getElementById('transferAmount').value = '';
                renderApp();

            } catch (e) {
                console.error("Transfer Transaction failed: ", e);
                updateStatusMessage(`ট্রান্সফার ব্যর্থ: ${e.toString()}`, true);
                renderApp();
            }
        };

        const handlePostNews = async () => {
            const newPostTitle = document.getElementById('newPostTitle').value;
            const newPostCaption = document.getElementById('newPostCaption').value;
            const newPostLink = document.getElementById('newPostLink').value;

            if (!db || state.userId !== ADMIN_UID || !newPostTitle || !newPostCaption || !newPostLink) {
                updateStatusMessage('অ্যাডমিন নয় অথবা সব ফিল্ড পূরণ করা হয়নি।', true);
                renderApp();
                return;
            }

            updateStatusMessage(`<i data-lucide="loader-2" class="animate-spin inline-block mr-2 h-4 w-4"></i> পোস্ট করা হচ্ছে...`);
            renderApp();

            try {
                const newsCol = getCollectionRef('news');
                await addDoc(newsCol, {
                    adminUid: state.userId,
                    title: newPostTitle,
                    caption: newPostCaption,
                    buttonLink: newPostLink,
                    timestamp: serverTimestamp(),
                });
                updateStatusMessage('নিউজ পোস্ট সফলভাবে হয়েছে!');
                document.getElementById('newPostTitle').value = '';
                document.getElementById('newPostCaption').value = '';
                document.getElementById('newPostLink').value = '';
            } catch (e) {
                console.error("News post failed:", e);
                updateStatusMessage('পোস্ট করতে সমস্যা হয়েছে।', true);
            }
            renderApp();
        };


        // --- রেন্ডারিং ফাংশন ---

        const renderLoading = () => `
            <div class="flex items-center justify-center h-full text-white/70">
                <i data-lucide="loader-2" class="animate-spin h-8 w-8 mr-2"></i>
                <p>অ্যাপ লোড হচ্ছে...</p>
            </div>
        `;
        
        const renderGripPage = () => {
            const { userData, coinMultiplier, coinsPerTick, isTapping, adRewardActive, adRewardDuration, statusMessage } = state;
            
            const minutes = Math.floor(adRewardDuration / 60);
            const seconds = adRewardDuration % 60;
            const formattedTime = `${minutes}মি ${seconds}সে`;
            
            return `
                <div class="flex flex-col items-center p-4 h-full bg-slate-900 overflow-y-auto">
                    <h2 class="text-2xl font-bold text-teal-400 mb-2 mt-4">কয়েন সংগ্রহ করুন</h2>
                    <p class="text-sm text-gray-400 mb-6">
                        দ্রুত ট্যাপ করুন! সর্বোচ্চ ${coinMultiplier}× স্পিড। প্রতি সেকেন্ডে ${coinsPerTick * coinMultiplier} কয়েন।
                    </p>
                    
                    <!-- Ad Reward Status -->
                    <div class="w-full max-w-sm p-3 mb-6 rounded-lg shadow-lg ${adRewardActive ? 'bg-green-700/50 border border-green-500' : 'bg-slate-800/50 border border-slate-700'}">
                        <div class="flex justify-between items-center text-white">
                            <p class="text-sm font-semibold">
                                <i data-lucide="zap" class="inline-block h-4 w-4 mr-1 text-yellow-400"></i>
                                ${adRewardActive ? '৫× স্পিড অ্যাক্টিভ!' : 'বিজ্ঞাপন দেখে বোনাস নিন'}
                            </p>
                            <span class="text-xs text-yellow-300">
                                ${adRewardActive ? `সময় বাকি: ${formattedTime}` : 'নিষ্ক্রিয়'}
                            </span>
                        </div>
                        <button 
                            onclick="showMonetagRewardedAd()"
                            ${adRewardActive ? 'disabled' : ''}
                            class="w-full mt-2 py-2 text-sm font-bold rounded-md transition duration-200 
                                bg-teal-600 hover:bg-teal-700 disabled:bg-slate-700 disabled:text-gray-400"
                        >
                            ${adRewardActive ? 'বোনাস চলছে...' : 'Rewarded Ad দেখুন (৫× মাল্টিপ্লায়ার)'}
                        </button>
                        <p class="text-xs text-center text-gray-400 mt-2">
                            ${statusMessage ? statusMessage : ''}
                        </p>
                    </div>

                    <!-- Bonus Coin Button -->
                    <div class="w-full max-w-sm p-3 mb-4 rounded-lg shadow-lg bg-purple-800/50 border border-purple-700">
                        <div class="flex justify-between items-center text-white">
                            <p class="text-sm font-semibold">
                                <i data-lucide="gift" class="inline-block h-4 w-4 mr-1 text-yellow-400"></i>
                                এক্সট্রা কয়েন বোনাস
                            </p>
                        </div>
                        <button 
                            onclick="showMonetagRewardedPopup()"
                            class="w-full mt-2 py-2 text-sm font-bold rounded-md transition duration-200 
                                bg-purple-600 hover:bg-purple-700"
                        >
                            Rewarded Popup দেখুন (১০০ কয়েন বোনাস)
                        </button>
                    </div>

                    <!-- Tapping Zone -->
                    <div 
                        id="tapZone"
                        ontouchstart="handleTapStart()"
                        ontouchend="handleTapEnd()"
                        onmousedown="handleTapStart()"
                        onmouseup="handleTapEnd()"
                        class="w-full max-w-xs aspect-square flex items-center justify-center rounded-full shadow-2xl transition-all duration-100 ease-out 
                            ${isTapping ? 'bg-teal-700/80 scale-105' : 'bg-slate-800/80 hover:bg-slate-700/80'} 
                            ${coinMultiplier > 1 ? 'border-4 border-yellow-400' : 'border border-slate-600'}"
                    >
                        <div class="text-center">
                            <p class="text-6xl" role="img" aria-label="Fist">👊</p>
                            <p class="text-2xl font-extrabold mt-2 ${coinMultiplier > 1 ? 'text-yellow-400 animate-pulse' : 'text-white'}">
                                ${coinMultiplier}×
                            </p>
                            ${isTapping ? '<p class="text-sm text-gray-300 mt-1">কয়েন সংগ্রহ চলছে...</p>' : ''}
                        </div>
                    </div>

                    <p class="mt-4 text-white text-3xl font-bold">
                        ব্যালেন্স: ${formatBalance(userData?.balance)}
                    </p>
                    <p class="text-sm text-gray-500">ইউজার: ${state.userData.telegramUsername || 'N/A'}</p>
                </div>
            `;
        };

        const renderTransferPage = () => {
            const { userData, transferRecipient, recipientData, statusMessage } = state;
            const recipientUsername = recipientData ? recipientData.telegramUsername : '';

            return `
                <div class="p-4 h-full bg-slate-900 overflow-y-auto text-white">
                    <h2 class="text-2xl font-bold text-teal-400 mb-6 mt-4">কয়েন ট্রান্সফার</h2>
                    <div class="space-y-4 max-w-md mx-auto">
                    
                        <!-- ইউজার সার্চ -->
                        <div class="p-4 bg-slate-800 rounded-lg shadow-xl">
                            <label for="transferRecipient" class="block text-sm font-medium text-gray-300 mb-2">Telegram Username</label>
                            <div class="flex space-x-2">
                                <input
                                    type="text"
                                    id="transferRecipient"
                                    value="${state.transferRecipient}"
                                    oninput="state.transferRecipient = this.value"
                                    placeholder="@username_to_send"
                                    class="flex-grow p-2.5 rounded-md bg-slate-700 border border-slate-600 text-white placeholder-gray-500 focus:ring-teal-500 focus:border-teal-500"
                                />
                                <button
                                    onclick="searchRecipient()"
                                    class="px-4 py-2 bg-pink-600 rounded-md hover:bg-pink-700 transition duration-200 disabled:bg-slate-700"
                                    ${!state.transferRecipient ? 'disabled' : ''}
                                >
                                    সার্চ
                                </button>
                            </div>
                        </div>

                        <!-- রিসিভার ডিসপ্লে -->
                        ${recipientData ? `
                            <div class="p-4 bg-slate-700 rounded-lg shadow-xl border border-teal-500/50">
                                <h3 class="text-lg font-semibold text-teal-300">ট্রান্সফার প্রাপক:</h3>
                                <p class="text-white mt-1">ইউজারনেম: <span class="font-bold">${recipientUsername}</span></p>
                                <p class="text-xs text-gray-400">UID: ${recipientData.uid}</p>
                            </div>
                        ` : ''}
                        
                        <!-- ট্রান্সফার ফর্ম -->
                        <div class="p-4 bg-slate-800 rounded-lg shadow-xl">
                            <label for="transferAmount" class="block text-sm font-medium text-gray-300 mb-2">পরিমাণ (কয়েন)</label>
                            <input
                                type="number"
                                id="transferAmount"
                                value="${state.transferAmount}"
                                oninput="state.transferAmount = this.value; renderApp()"
                                placeholder="পরিমাণ"
                                class="w-full p-2.5 rounded-md bg-slate-700 border border-slate-600 text-white placeholder-gray-500 focus:ring-teal-500 focus:border-teal-500 mb-4"
                            />
                            
                            <p class="text-sm text-gray-400 mb-4">আপনার ব্যালেন্স: ${formatBalance(userData?.balance)}</p>

                            <button
                                onclick="confirmTransfer()"
                                ${!recipientData || !state.transferAmount || parseFloat(state.transferAmount) <= 0 || parseFloat(state.transferAmount) > userData?.balance ? 'disabled' : ''}
                                class="w-full py-3 text-lg font-bold rounded-md transition duration-200 
                                    bg-teal-600 hover:bg-teal-700 disabled:bg-slate-700 disabled:text-gray-400"
                            >
                                ট্রান্সফার কনফার্ম
                            </button>
                        </div>
                        
                        <!-- স্ট্যাটাস -->
                        ${statusMessage ? `
                            <p class="text-center text-sm p-3 bg-slate-700/50 rounded-lg text-yellow-300">
                                ${statusMessage}
                            </p>
                        ` : ''}
                    </div>
                </div>
            `;
        };

        const renderNewsPage = () => {
            const isAdmin = state.userId === ADMIN_UID;
            const { newsPosts, statusMessage } = state;
            
            return `
                <div class="p-4 h-full bg-slate-900 overflow-y-auto text-white">
                    <h2 class="text-2xl font-bold text-teal-400 mb-6 mt-4">খবর এবং আপডেট</h2>
                    
                    <!-- Admin Posting Form -->
                    ${isAdmin ? `
                        <div class="mb-8 p-4 bg-red-900/40 border border-red-700 rounded-lg max-w-lg mx-auto">
                            <h3 class="text-xl font-semibold text-red-300 mb-3">অ্যাডমিন পোস্ট ফর্ম</h3>
                            <input
                                type="text"
                                id="newPostTitle"
                                placeholder="পোস্টের শিরোনাম"
                                class="w-full p-2 mb-2 rounded-md bg-slate-700 border border-slate-600 text-white"
                            />
                            <textarea
                                id="newPostCaption"
                                placeholder="বিস্তারিত ক্যাপশন..."
                                class="w-full p-2 mb-2 rounded-md bg-slate-700 border border-slate-600 text-white h-20"
                            ></textarea>
                            <input
                                type="url"
                                id="newPostLink"
                                placeholder="Join/Check বাটন লিঙ্ক (https://...)"
                                class="w-full p-2 mb-3 rounded-md bg-slate-700 border border-slate-600 text-white"
                            />
                            <button
                                onclick="handlePostNews()"
                                class="w-full py-2 bg-red-600 rounded-md hover:bg-red-700 font-semibold"
                            >
                                নিউজ পোস্ট করুন
                            </button>
                            ${statusMessage ? `
                                <p class="text-center text-sm p-3 bg-slate-700/50 rounded-lg text-yellow-300 mt-3">
                                    ${statusMessage}
                                </p>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- News Feed -->
                    <div class="space-y-6 max-w-lg mx-auto">
                        ${newsPosts.length > 0 ? 
                            newsPosts.map(post => `
                                <div class="p-4 bg-slate-800 rounded-xl shadow-2xl border border-slate-700 transition hover:border-teal-500/50">
                                    <h3 class="text-xl font-bold text-teal-400 mb-2">${post.title}</h3>
                                    <p class="text-gray-300 mb-3 text-sm">${post.caption}</p>
                                    <div class="flex justify-between items-center">
                                        <a 
                                            href="${post.buttonLink}" 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            class="px-4 py-2 bg-pink-600 text-white text-sm font-semibold rounded-lg hover:bg-pink-700 transition"
                                        >
                                            Join/Check করুন
                                        </a>
                                        <p class="text-xs text-gray-500">${formatDate(post.timestamp)}</p>
                                    </div>
                                </div>
                            `).join('')
                        : `
                            <p class="text-center text-gray-500 p-8">এখনও কোনো নিউজ পোস্ট হয়নি।</p>
                        `}
                    </div>
                </div>
            `;
        };

        const renderProfilePage = () => {
            const { userData, userId, transactions, referrals } = state;
            
            return `
                <div class="p-4 h-full bg-slate-900 overflow-y-auto text-white">
                    <h2 class="text-2xl font-bold text-teal-400 mb-6 mt-4">প্রোফাইল এবং হিস্টোরি</h2>
                    
                    <div class="max-w-xl mx-auto space-y-8">
                        <!-- ইউজার ও ব্যালেন্স কার্ড -->
                        <div class="p-6 bg-slate-800 rounded-xl shadow-2xl border border-teal-500/50">
                            <div class="flex items-center space-x-4 mb-4">
                                <i data-lucide="user" class="w-8 h-8 text-pink-400"></i>
                                <div>
                                    <p class="text-lg font-semibold text-gray-300">ইউজারনেম:</p>
                                    <p class="text-2xl font-bold text-white">${userData?.telegramUsername || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="border-t border-slate-700 pt-4">
                                <p class="text-lg font-semibold text-gray-300">বর্তমান ব্যালেন্স:</p>
                                <p class="text-4xl font-extrabold text-teal-400">${formatBalance(userData?.balance)}</p>
                                <p class="text-xs text-gray-500 mt-2 break-all">UID (রেফারেল কোড): ${userId || 'N/A'}</p>
                            </div>
                        </div>

                        <!-- রেফারেল সিস্টেম -->
                        <div class="p-6 bg-slate-800 rounded-xl shadow-2xl border border-slate-700">
                            <h3 class="text-xl font-bold text-pink-400 mb-4">রেফারেল ড্যাশবোর্ড (Gen 1)</h3>
                            <p class="text-sm text-gray-300 mb-4">
                                কমিশন: Gen 1 (${REFERRAL_COMMISSION[1]*100}%), Gen 2 (${REFERRAL_COMMISSION[2]*100}%), Gen 3 (${REFERRAL_COMMISSION[3]*100}%)
                            </p>
                            
                            <h4 class="font-semibold mt-4 text-gray-300">আপনার সরাসরি রেফারেল (${referrals.length} জন):</h4>
                            <div class="h-40 overflow-y-auto mt-2 bg-slate-700 p-2 rounded-lg">
                                ${referrals.length > 0 ? 
                                    referrals.map(r => `
                                        <p class="text-xs text-gray-300 border-b border-slate-600 py-1">
                                            ${r.referredId} (Gen ${r.generationLevel})
                                        </p>
                                    `).join('')
                                : `
                                    <p class="text-center text-gray-500 p-4 text-sm">আপনি এখনও কাউকে রেফার করেননি।</p>
                                `}
                            </div>
                        </div>
                        
                        <!-- লেনদেন হিস্টোরি -->
                        <div class="p-6 bg-slate-800 rounded-xl shadow-2xl border border-slate-700">
                            <h3 class="text-xl font-bold text-teal-400 mb-4">লেনদেন হিস্টোরি</h3>
                            
                            <div class="h-64 overflow-y-auto">
                                <table class="min-w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-slate-600 text-gray-400">
                                            <th class="py-2 text-left">টাইপ</th>
                                            <th class="py-2 text-right">পরিমাণ</th>
                                            <th class="py-2 text-center">সময়</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${transactions.map(tx => `
                                            <tr class="border-b border-slate-700 last:border-b-0">
                                                <td class="py-2 text-left">
                                                    ${tx.type === 'GRIP' ? 'সংগ্রহ' :
                                                     tx.type === 'TRANSFER_SENT' ? 'প্রেরণ' :
                                                     tx.type === 'TRANSFER_RECEIVED' ? 'গ্রহণ' :
                                                     tx.type === 'REFERRAL_COMMISSION' ? 'রেফারেল' : 
                                                     tx.type === 'AD_REWARD' ? 'বিজ্ঞাপন বোনাস' : 'অন্যান্য'}
                                                    <span class="text-xs block text-gray-500">
                                                        ${tx.type === 'TRANSFER_SENT' ? `কে: ${tx.recipient.substring(0, 8)}...` :
                                                         tx.type === 'TRANSFER_RECEIVED' ? `থেকে: ${tx.sender.substring(0, 8)}...` :
                                                         tx.type === 'REFERRAL_COMMISSION' ? `Gen ${tx.generationLevel} | From: ${tx.fromUser.substring(0, 8)}...` : ''}
                                                    </span>
                                                </td>
                                                <td class="py-2 text-right font-semibold ${tx.amount > 0 ? 'text-green-400' : 'text-red-400'}">
                                                    ${tx.amount > 0 ? `+${formatBalance(tx.amount)}` : formatBalance(tx.amount)}
                                                </td>
                                                <td class="py-2 text-center text-xs text-gray-400">${formatDate(tx.timestamp)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                ${transactions.length === 0 ? '<p class="text-center text-gray-500 p-4">কোনো লেনদেন রেকর্ড নেই।</p>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderPage = (pageId) => {
            switch (pageId) {
                case 'grip': return renderGripPage();
                case 'transfer': return renderTransferPage();
                case 'news': return renderNewsPage();
                case 'profile': return renderProfilePage();
                default: return '<div>Page not found.</div>';
            }
        };

        const renderNavBar = () => {
            const navItems = [
                { id: 'grip', label: 'Grip', icon: 'home' },
                { id: 'transfer', label: 'Transfer', icon: 'send' },
                { id: 'news', label: 'News', icon: 'newspaper' },
                { id: 'profile', label: 'Profile', icon: 'user' },
            ];

            return `
                <nav class="fixed bottom-0 left-0 right-0 h-16 bg-slate-800 border-t border-slate-700 shadow-2xl z-50">
                    <div class="flex justify-around h-full max-w-lg mx-auto">
                        ${navItems.map(item => `
                            <button
                                onclick="state.currentPage = '${item.id}'; updateStatusMessage(null); renderApp();"
                                class="flex flex-col items-center justify-center p-2 text-xs transition-all duration-200 
                                    ${state.currentPage === item.id ? 'text-teal-400 scale-110' : 'text-gray-400 hover:text-teal-300'}"
                            >
                                <i data-lucide="${item.icon}" class="w-6 h-6 mb-0.5"></i>
                                <span class="font-medium">${item.label}</span>
                            </button>
                        `).join('')}
                    </div>
                </nav>
            `;
        };


        // --- প্রধান রেন্ডারিং ফাংশন ---
        const renderApp = () => {
            const appContainer = document.getElementById('app-container');
            const navContainer = document.getElementById('nav-container');

            if (!state.isAuthReady) {
                appContainer.innerHTML = renderLoading();
            } else {
                appContainer.innerHTML = renderPage(state.currentPage);
            }
            
            navContainer.innerHTML = renderNavBar();
            replaceIcons(); 
        };

        // --- উইন্ডো লোড হলে অ্যাপ শুরু করা ---
        window.onload = () => {
            initFirebaseAndAuth();
            renderApp();
        };
        
        // গ্লোবাল অ্যাক্সেসের জন্য ফাংশনগুলি উইন্ডো অবজেক্টে যোগ করা
        window.showMonetagRewardedAd = showMonetagRewardedAd;
        window.showMonetagRewardedPopup = showMonetagRewardedPopup;
        window.handleTapStart = handleTapStart;
        window.handleTapEnd = handleTapEnd;
        window.searchRecipient = searchRecipient;
        window.confirmTransfer = confirmTransfer;
        window.handlePostNews = handlePostNews;
        window.state = state; 
        window.renderApp = renderApp; 
        window.updateStatusMessage = updateStatusMessage;
    </script>
</head>
<body class="bg-slate-950 font-sans min-h-screen text-white">
    <div id="app" class="flex flex-col h-screen">
        <!-- Main Content Area -->
        <div id="app-container" class="flex-grow overflow-hidden pb-16">
            <!-- Content will be rendered here -->
        </div>

        <!-- Navigation Bar Container -->
        <div id="nav-container">
            <!-- Navigation will be rendered here -->
        </div>
    </div>
</body>
</html>
