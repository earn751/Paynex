<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HiGriP üëä - Promotion Bot</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* HiGriP Promotion Bot üëä | Admin: 7243906826 | 2025 */
:root {
    --bg: linear-gradient(135deg, #0f0f1a 0%, #1a0033 100%);
    --neon-purple: #9d4edd;
    --neon-cyan: #00f2ff;
    --neon-pink: #ff2a6d;
    --card: rgba(30, 15, 60, 0.7);
    --text: #e0e0ff;
    --success: #00ff9d;
    --warning: #ffcc00;
    --error: #ff3860;
}
* { 
    margin:0; 
    padding:0; 
    box-sizing:border-box; 
}
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    padding-bottom: 80px;
    line-height: 1.5;
}
.container { 
    padding: 15px; 
    max-width: 500px; 
    margin: 0 auto; 
}
header {
    text-align: center;
    padding: 20px 0;
    background: rgba(0,0,0,0.4);
    border-radius: 20px;
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(157,78,221,0.2);
    position: relative;
    overflow: hidden;
}
header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--neon-purple), transparent);
}
h1 { 
    font-size: 2.5em; 
    background: linear-gradient(90deg, var(--neon-purple), var(--neon-cyan)); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    margin-bottom: 10px;
}
.balance {
    font-size: 2em;
    margin: 15px 0;
    font-weight: bold;
    text-shadow: 0 0 20px var(--neon-purple);
}
.level { 
    font-size: 1.2em; 
    color: var(--neon-cyan); 
    margin-bottom: 5px;
}
.streak { 
    font-size: 1.8em; 
    color: #ff6b6b; 
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.card {
    background: var(--card);
    border-radius: 20px;
    padding: 20px;
    margin: 15px 0;
    border: 1px solid rgba(157,78,221,0.3);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    transition: transform 0.3s, box-shadow 0.3s;
}
.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(157,78,221,0.3);
}
.btn {
    background: linear-gradient(45deg, var(--neon-purple), var(--neon-cyan));
    color: white;
    border: none;
    padding: 15px;
    border-radius: 15px;
    font-size: 1.1em;
    font-weight: bold;
    width: 100%;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 5px 15px rgba(157,78,221,0.4);
    position: relative;
    overflow: hidden;
}
.btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}
.btn:hover::after {
    left: 100%;
}
.btn:active { 
    transform: scale(0.95); 
}
.btn:disabled {
    background: #555;
    cursor: not-allowed;
    transform: none;
}
.btn-success {
    background: linear-gradient(45deg, var(--success), #00cc7e);
}
.btn-warning {
    background: linear-gradient(45deg, var(--warning), #ffaa00);
}
.btn-danger {
    background: linear-gradient(45deg, var(--error), #ff1e56);
}
.fist { 
    font-size: 2.5em; 
    display: inline-block; 
    animation: punch 1s infinite; 
}
@keyframes punch { 
    0%,100%{transform:rotate(0)} 
    50%{transform:rotate(-20deg) translateX(-10px)} 
}
.progress { 
    height: 12px; 
    background: #333; 
    border-radius: 6px; 
    overflow: hidden; 
    margin: 10px 0; 
    position: relative;
}
.progress-bar { 
    height: 100%; 
    background: linear-gradient(90deg, #9d4edd, #00f2ff); 
    width: 0%; 
    transition: width 1s; 
    border-radius: 6px;
    position: relative;
}
.progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}
@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
.tabs { 
    display: flex; 
    background: rgba(0,0,0,0.5); 
    border-radius: 15px; 
    overflow: hidden; 
    margin: 15px 0; 
    border: 1px solid rgba(157,78,221,0.2);
}
.tab { 
    flex: 1; 
    padding: 15px; 
    text-align: center; 
    cursor: pointer; 
    transition: 0.3s; 
    font-weight: bold;
}
.tab.active { 
    background: var(--neon-purple); 
    box-shadow: 0 0 10px rgba(157,78,221,0.5);
}
.task {
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    padding: 15px;
    margin: 12px 0;
    border-left: 5px solid var(--neon-cyan);
    transition: all 0.3s;
}
.task:hover {
    background: rgba(255,255,255,0.08);
    transform: translateX(5px);
}
.modal {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.95);
    display: none; 
    align-items: center; 
    justify-content: center; 
    z-index: 9999;
    backdrop-filter: blur(5px);
}
.modal-content {
    background: #1a0033; 
    padding: 30px; 
    border-radius: 25px; 
    text-align: center;
    border: 2px solid var(--neon-purple); 
    max-width: 90%;
    animation: popup 0.5s;
    box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    position: relative;
}
.modal-content::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, var(--neon-purple), var(--neon-cyan), var(--neon-pink), var(--neon-purple));
    border-radius: 27px;
    z-index: -1;
    background-size: 400% 400%;
    animation: gradient 3s ease infinite;
}
@keyframes gradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
@keyframes popup { 
    from {transform: scale(0.5)} 
    to {transform: scale(1)} 
}
#floating-btn {
    position: fixed; 
    bottom: 20px; 
    right: 20px; 
    width: 70px; 
    height: 70px;
    background: linear-gradient(45deg, #9d4edd, #00f2ff);
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    font-size: 2.5em; 
    box-shadow: 0 10px 30px rgba(157,78,221,0.6); 
    z-index: 999;
    animation: float 3s infinite;
    cursor: pointer;
    border: 2px solid rgba(255,255,255,0.2);
    transition: all 0.3s;
}
#floating-btn:active {
    transform: scale(0.9);
}
@keyframes float { 
    0%,100%{transform:translateY(0)} 
    50%{transform:translateY(-15px)} 
}
.hidden { 
    display: none !important; 
}
.leaderboard { 
    max-height: 400px; 
    overflow-y: auto; 
    padding: 10px;
    border-radius: 15px;
    background: rgba(0,0,0,0.3);
}
.leaderboard-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 15px;
    margin: 8px 0;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    transition: all 0.3s;
}
.leaderboard-item:hover {
    background: rgba(255,255,255,0.1);
    transform: translateX(5px);
}
.leaderboard-item:nth-child(1) {
    background: linear-gradient(90deg, rgba(255,215,0,0.2), transparent);
    border-left: 3px solid gold;
}
.leaderboard-item:nth-child(2) {
    background: linear-gradient(90deg, rgba(192,192,192,0.2), transparent);
    border-left: 3px solid silver;
}
.leaderboard-item:nth-child(3) {
    background: linear-gradient(90deg, rgba(205,127,50,0.2), transparent);
    border-left: 3px solid #cd7f32;
}
.confetti { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    pointer-events: none; 
    z-index: 99999; 
}
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card);
    padding: 15px 20px;
    border-radius: 10px;
    border-left: 5px solid var(--neon-cyan);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    z-index: 10000;
    transform: translateX(150%);
    transition: transform 0.5s;
    max-width: 300px;
}
.notification.show {
    transform: translateX(0);
}
.notification.success {
    border-left-color: var(--success);
}
.notification.error {
    border-left-color: var(--error);
}
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin: 15px 0;
}
.stat-card {
    background: rgba(0,0,0,0.3);
    border-radius: 15px;
    padding: 15px;
    text-align: center;
    border: 1px solid rgba(157,78,221,0.2);
}
.stat-value {
    font-size: 1.5em;
    font-weight: bold;
    color: var(--neon-cyan);
    margin-bottom: 5px;
}
.stat-label {
    font-size: 0.9em;
    opacity: 0.8;
}
.ref-link {
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    padding: 10px 15px;
    margin: 10px 0;
    word-break: break-all;
    border: 1px dashed var(--neon-purple);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.copy-btn {
    background: var(--neon-purple);
    border: none;
    border-radius: 5px;
    padding: 5px 10px;
    color: white;
    cursor: pointer;
    font-size: 0.8em;
}
</style>
</head>
<body>
<div class="container">
    <header>
        <h1>HiGriP <span class="fist">üëä</span></h1>
        <div class="balance" id="balance">0 GRIP üëä</div>
        <div class="level">Level <span id="level">1</span> ‚Ä¢ <span id="multiplier">1.1</span>x Multiplier</div>
        <div class="streak">üî• Streak: <span id="streak">0</span> days</div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalEarned">0</div>
                <div class="stat-label">Total Earned</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="referrals">0</div>
                <div class="stat-label">Referrals</div>
            </div>
        </div>
    </header>

    <div class="card">
        <div class="progress">
            <div class="progress-bar" id="dailyProgress"></div>
        </div>
        <small>Grip Strength: <span id="gripStrength">0</span>%</small>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="openTab('earn')">EARN üëä</div>
        <div class="tab" onclick="openTab('promote')">PROMOTE</div>
        <div class="tab" onclick="openTab('leaderboard')">LEADERBOARD</div>
    </div>

    <div id="earn" class="tab-content">
        <div id="dailyClaim" class="card task">
            <h3>üî• Daily Grip Bonus</h3>
            <p>Day <span id="streakDay">1</span>: <b id="dailyReward">200</b> GRIP üëä</p>
            <button class="btn" id="dailyClaimBtn" onclick="claimDaily()">Claim Daily Bonus</button>
        </div>
        <div id="tasksList"></div>
    </div>

    <div id="promote" class="tab-content hidden">
        <button class="btn" onclick="showCreateTask()">+ Create New Promotion</button>
        <div id="myPromotions"></div>
    </div>

    <div id="leaderboard" class="tab-content hidden">
        <h2>üèÜ Top Earners</h2>
        <div id="topEarners" class="leaderboard"></div>
        <h2 style="margin-top: 20px;">üëë Top Referrers</h2>
        <div id="topReferrers" class="leaderboard"></div>
    </div>

    <div class="card">
        <button class="btn" onclick="shareReferral()">Invite Friends (+800 GRIP each)</button>
        <p style="text-align:center; margin-top:10px;">Your referral link:</p>
        <div class="ref-link">
            <span id="refLink">loading...</span>
            <button class="copy-btn" onclick="copyRefLink()">Copy</button>
        </div>
    </div>

    <div class="card hidden" id="adminPanel">
        <h2 style="color:#ff6b6b;">Admin Panel üëë</h2>
        <div id="pendingProofs"></div>
    </div>
</div>

<div id="floating-btn" onclick="quickEarn()">üëä</div>

<!-- Pre-Join Rules Modal -->
<div class="modal" id="rulesModal">
    <div class="modal-content">
        <h1>HiGripGo Promotion Bot <span class="fist">üëä</span></h1>
        <p style="margin:20px 0; line-height:1.6;">
            ‚úÖ Earn GRIP by joining channels/groups<br>
            ‚úÖ Promote your own channel & earn<br>
            ‚úÖ Payment via screenshot proof<br>
            <span style="color:#ff6b6b;">üö´ Fake SS / spam = permanent ban</span>
        </p>
        <button class="btn" style="font-size:1.3em;" onclick="acceptRules()">‚úÖ I Accept Rules & Join</button>
        <button class="btn btn-warning" style="margin-top:10px;" onclick="cancelJoin()">Cancel</button>
    </div>
</div>

<!-- Create Promotion Modal -->
<div class="modal" id="createPromoModal">
    <div class="modal-content">
        <h2>Create Promotion</h2>
        <div style="text-align: left; margin: 20px 0;">
            <label style="display: block; margin-bottom: 8px;">Promotion Title</label>
            <input type="text" id="promoTitle" placeholder="Enter title" style="width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--neon-purple); color: white; margin-bottom: 15px;">
            
            <label style="display: block; margin-bottom: 8px;">Channel/Group Link</label>
            <input type="text" id="promoLink" placeholder="https://t.me/..." style="width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--neon-purple); color: white; margin-bottom: 15px;">
            
            <label style="display: block; margin-bottom: 8px;">Reward per Joiner (GRIP)</label>
            <input type="number" id="promoReward" placeholder="500" min="100" max="5000" style="width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--neon-purple); color: white; margin-bottom: 15px;">
            
            <label style="display: block; margin-bottom: 8px;">Budget (Total GRIP to spend)</label>
            <input type="number" id="promoBudget" placeholder="10000" min="1000" style="width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--neon-purple); color: white; margin-bottom: 15px;">
        </div>
        <button class="btn" onclick="createPromotion()">Create Promotion</button>
        <button class="btn btn-warning" style="margin-top:10px;" onclick="closeCreatePromo()">Cancel</button>
    </div>
</div>

<div class="notification" id="notification"></div>
<canvas id="confettiCanvas" class="confetti"></canvas>

<script>
// HiGriP Promotion Bot üëä | Admin: 7243906826 | 2025
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const ADMIN_ID = 7243906826;
let user = tg.initDataUnsafe.user || {id: Date.now(), first_name: "Guest", username: "guest"};
let currentTaskLink = "";
let db = {
    users: {},
    tasks: [],
    promotions: [],
    proofs: []
};

function load() {
    const saved = localStorage.getItem("higrip_db");
    if (saved) {
        try {
            db = JSON.parse(saved);
        } catch (e) {
            console.error("Error loading data:", e);
            db = { users: {}, tasks: [], promotions: [], proofs: [] };
        }
    }
    
    if (!db.users[user.id]) {
        initUser();
    } else {
        Object.assign(user, db.users[user.id]);
    }

    updateUI();
    checkAdmin();
    checkDaily();
    renderTasks();
    renderPromotions();
    renderLeaderboard();
    document.getElementById("refLink").innerText = `https://t.me/HiGriP_bot?start=ref${user.id}`;
    
    // Show welcome message
    showNotification(`Welcome${user.username ? " back, @"+user.username : ""}! Ready to Grip? üëä`, 'success');
}

function save() { 
    localStorage.setItem("higrip_db", JSON.stringify(db)); 
}

function initUser() {
    const urlParams = new URLSearchParams(window.location.search);
    const ref = urlParams.get('start')?.replace("ref","");
    
    user = {
        id: user.id,
        first_name: user.first_name || "User",
        username: user.username || "user" + user.id,
        balance: ref && db.users[ref] ? 1300 : 500,
        total_earned: 0,
        streak: 0,
        lastDaily: 0,
        referrals: 0,
        dailyTasks: 0,
        joinedDate: Date.now(),
        completedTasks: []
    };
    
    if (ref && db.users[ref]) {
        db.users[ref].balance += 800;
        db.users[ref].referrals = (db.users[ref].referrals || 0) + 1;
        showNotification("Welcome! You and your referrer got 800 GRIP üëä", 'success');
    }
    
    db.users[user.id] = user;
    save();
}

function updateUI() {
    document.getElementById("balance").innerText = user.balance.toLocaleString() + " GRIP üëä";
    const lvl = Math.floor(user.total_earned / 10000) + 1;
    document.getElementById("level").innerText = lvl;
    document.getElementById("multiplier").innerText = (lvl * 1.1).toFixed(1);
    document.getElementById("streak").innerText = user.streak || 0;
    document.getElementById("totalEarned").innerText = user.total_earned.toLocaleString();
    document.getElementById("referrals").innerText = user.referrals || 0;
    
    const strength = Math.min(100, (user.dailyTasks || 0) * 20);
    document.getElementById("dailyProgress").style.width = strength + "%";
    document.getElementById("gripStrength").innerText = strength;
}

function checkDaily() {
    const today = new Date().toDateString();
    if (user.lastDaily !== today) {
        const day = ((user.streak || 0) % 7) + 1;
        document.getElementById("streakDay").innerText = day;
        document.getElementById("dailyReward").innerText = day * 200 + 600;
        document.getElementById("dailyClaimBtn").disabled = false;
        document.getElementById("dailyClaimBtn").innerText = "Claim Daily Bonus";
    } else {
        document.getElementById("dailyClaimBtn").disabled = true;
        document.getElementById("dailyClaimBtn").innerText = "‚úÖ Already Claimed Today";
    }
}

function claimDaily() {
    const today = new Date().toDateString();
    if (user.lastDaily === today) {
        showNotification("You've already claimed your daily bonus today!", 'error');
        return;
    }
    
    user.streak = (user.streak || 0) + 1;
    const day = (user.streak % 7) || 7;
    const reward = day <= 7 ? day * 200 + 600 : 2000;
    
    user.balance += reward;
    user.total_earned += reward;
    user.lastDaily = today;
    db.users[user.id] = user;
    save();
    
    confettiBurst();
    updateUI();
    checkDaily();
    tg.HapticFeedback.notificationOccurred("success");
    showNotification(`Daily bonus claimed! +${reward} GRIP üëä`, 'success');
}

function renderTasks() {
    const list = document.getElementById("tasksList");
    list.innerHTML = "";
    
    const sampleTasks = [
        {id:1, title:"Join Official Channel", type:"channel", link:"https://t.me/higripgo", reward:1200, budget:500000, done:0},
        {id:2, title:"Join Earning Group BD", type:"group", link:"https://t.me/bdearning24", reward:1500, budget:300000, done:0},
        {id:3, title:"Start @AirdropBot", type:"bot", link:"https://t.me/Airdrop", reward:800, budget:999999, done:0}
    ];
    
    sampleTasks.forEach(t => {
        const isCompleted = user.completedTasks && user.completedTasks.includes(t.id);
        const div = document.createElement("div");
        div.className = "task";
        div.innerHTML = `
            <h3>${t.title}</h3>
            <p>Reward: <b>${t.reward} GRIP üëä</b></p>
            <button class="btn ${isCompleted ? 'btn-success' : ''}" onclick="startTask('${t.type}','${t.link}', ${t.id})" ${isCompleted ? 'disabled' : ''}>
                ${isCompleted ? '‚úÖ Completed' : 'Join & Earn'}
            </button>
        `;
        list.appendChild(div);
    });
}

function startTask(type, link, taskId) {
    if (type === "channel" || type === "group") {
        currentTaskLink = link;
        currentTaskId = taskId;
        document.getElementById("rulesModal").style.display = "flex";
    } else {
        window.open(link, "_blank");
        setTimeout(() => {
            completeTask(taskId);
        }, 3000);
    }
}

function acceptRules() {
    document.getElementById("rulesModal").style.display = "none";
    tg.openLink(currentTaskLink);
    setTimeout(() => {
        showNotification("After joining, send screenshot here to earn GRIP üëä");
    }, 2000);
    
    // Simulate task completion after delay
    setTimeout(() => {
        if (currentTaskId) {
            completeTask(currentTaskId);
        }
    }, 5000);
}

function completeTask(taskId) {
    if (!user.completedTasks) user.completedTasks = [];
    if (user.completedTasks.includes(taskId)) return;
    
    const task = getTaskById(taskId);
    if (!task) return;
    
    user.completedTasks.push(taskId);
    user.balance += task.reward;
    user.total_earned += task.reward;
    user.dailyTasks = (user.dailyTasks || 0) + 1;
    db.users[user.id] = user;
    save();
    
    updateUI();
    renderTasks();
    tg.HapticFeedback.notificationOccurred("success");
    showNotification(`Task completed! +${task.reward} GRIP üëä`, 'success');
}

function getTaskById(taskId) {
    const sampleTasks = [
        {id:1, title:"Join Official Channel", type:"channel", link:"https://t.me/higripgo", reward:1200, budget:500000, done:0},
        {id:2, title:"Join Earning Group BD", type:"group", link:"https://t.me/bdearning24", reward:1500, budget:300000, done:0},
        {id:3, title:"Start @AirdropBot", type:"bot", link:"https://t.me/Airdrop", reward:800, budget:999999, done:0}
    ];
    return sampleTasks.find(t => t.id === taskId);
}

function cancelJoin() {
    document.getElementById("rulesModal").style.display = "none";
}

function shareReferral() {
    const link = `https://t.me/HiGriP_bot?start=ref${user.id}`;
    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link + "\n\nJoin HiGriP & get 500 GRIP free üëä")}`);
}

function copyRefLink() {
    const link = `https://t.me/HiGriP_bot?start=ref${user.id}`;
    navigator.clipboard.writeText(link).then(() => {
        showNotification("Referral link copied to clipboard!", 'success');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        showNotification("Failed to copy link", 'error');
    });
}

function checkAdmin() {
    if (user.id == ADMIN_ID) {
        document.getElementById("adminPanel").classList.remove("hidden");
        // Add admin tab if not exists
        if (!document.querySelector('.tab[onclick="openTab(\'admin\')"]')) {
            document.querySelector(".tabs").insertAdjacentHTML('beforeend', '<div class="tab" onclick="openTab(\'admin\')">ADMIN</div>');
        }
    }
}

function openTab(tab) {
    document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(tab).classList.remove("hidden");
    document.querySelector(`.tab[onclick="openTab('${tab}')"]`).classList.add("active");
    
    // Refresh content if needed
    if (tab === 'leaderboard') {
        renderLeaderboard();
    } else if (tab === 'promote') {
        renderPromotions();
    }
}

function quickEarn() {
    openTab('earn');
    document.getElementById("floating-btn").style.transform = "scale(1.5)";
    setTimeout(() => document.getElementById("floating-btn").style.transform = "", 300);
}

function renderLeaderboard() {
    const earners = Object.values(db.users).sort((a,b) => b.total_earned - a.total_earned).slice(0,10);
    const refs = Object.values(db.users).sort((a,b) => (b.referrals||0) - (a.referrals||0)).slice(0,10);
    
    const earnersHTML = earners.map((u,i) => 
        `<div class="leaderboard-item">
            <span>${i+1}. @${u.username}</span>
            <span>${u.total_earned.toLocaleString()} GRIP</span>
        </div>`
    ).join("");
    
    const refsHTML = refs.map((u,i) => 
        `<div class="leaderboard-item">
            <span>${i+1}. @${u.username}</span>
            <span>${u.referrals||0} referrals</span>
        </div>`
    ).join("");
    
    document.getElementById("topEarners").innerHTML = earnersHTML;
    document.getElementById("topReferrers").innerHTML = refsHTML;
}

function showCreateTask() {
    document.getElementById("createPromoModal").style.display = "flex";
}

function closeCreatePromo() {
    document.getElementById("createPromoModal").style.display = "none";
}

function createPromotion() {
    const title = document.getElementById("promoTitle").value;
    const link = document.getElementById("promoLink").value;
    const reward = parseInt(document.getElementById("promoReward").value);
    const budget = parseInt(document.getElementById("promoBudget").value);
    
    if (!title || !link || !reward || !budget) {
        showNotification("Please fill all fields", 'error');
        return;
    }
    
    if (user.balance < budget) {
        showNotification("Not enough GRIP for this budget", 'error');
        return;
    }
    
    // Deduct budget from user balance
    user.balance -= budget;
    db.users[user.id] = user;
    
    // Create promotion
    const promo = {
        id: Date.now(),
        userId: user.id,
        title,
        link,
        reward,
        budget,
        spent: 0,
        createdAt: Date.now(),
        status: 'active'
    };
    
    if (!db.promotions) db.promotions = [];
    db.promotions.push(promo);
    save();
    
    closeCreatePromo();
    renderPromotions();
    updateUI();
    showNotification("Promotion created successfully!", 'success');
}

function renderPromotions() {
    const container = document.getElementById("myPromotions");
    container.innerHTML = "";
    
    if (!db.promotions || db.promotions.length === 0) {
        container.innerHTML = '<div class="task"><p>No promotions created yet</p></div>';
        return;
    }
    
    const myPromos = db.promotions.filter(p => p.userId === user.id);
    
    if (myPromos.length === 0) {
        container.innerHTML = '<div class="task"><p>No promotions created yet</p></div>';
        return;
    }
    
    myPromos.forEach(promo => {
        const div = document.createElement("div");
        div.className = "task";
        div.innerHTML = `
            <h3>${promo.title}</h3>
            <p>Reward: ${promo.reward} GRIP per joiner</p>
            <p>Budget: ${promo.budget.toLocaleString()} GRIP</p>
            <p>Spent: ${promo.spent.toLocaleString()} GRIP</p>
            <p>Status: <span style="color: ${promo.status === 'active' ? 'var(--success)' : '#ff6b6b'}">${promo.status}</span></p>
            <button class="btn" onclick="sharePromotion(${promo.id})">Share Promotion</button>
        `;
        container.appendChild(div);
    });
}

function sharePromotion(promoId) {
    const promo = db.promotions.find(p => p.id === promoId);
    if (!promo) return;
    
    const message = `Join ${promo.title} and earn ${promo.reward} GRIP! ${promo.link}`;
    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(message)}`);
}

function confettiBurst() {
    const canvas = document.getElementById("confettiCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const confetti = [];
    const confettiCount = 300;
    const gravity = 0.5;
    const terminalVelocity = 5;
    const drag = 0.075;
    const colors = [
        { front: '#9d4edd', back: '#7b2cbf' },
        { front: '#00f2ff', back: '#00b4c8' },
        { front: '#ff2a6d', back: '#d10047' },
        { front: '#00ff9d', back: '#00cc7e' },
        { front: '#ffcc00', back: '#e6b800' }
    ];

    // Initialize confetti particles
    for (let i = 0; i < confettiCount; i++) {
        confetti.push({
            color: colors[Math.floor(Math.random() * colors.length)],
            dimensions: {
                x: Math.random() * 10 + 10,
                y: Math.random() * 10 + 10
            },
            position: {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height
            },
            rotation: Math.random() * 2 * Math.PI,
            scale: {
                x: 1,
                y: 1
            },
            velocity: {
                x: Math.random() * 50 - 25,
                y: Math.random() * 50 + 50
            },
            wobble: Math.random() * 10
        });
    }

    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (let i = 0; i < confetti.length; i++) {
            const particle = confetti[i];
            
            // Apply forces
            particle.velocity.x -= particle.velocity.x * drag;
            particle.velocity.y = Math.min(particle.velocity.y + gravity, terminalVelocity);
            particle.velocity.x += Math.random() > 0.5 ? Math.random() : -Math.random();
            
            // Update position
            particle.position.x += particle.velocity.x;
            particle.position.y += particle.velocity.y;
            
            // Apply wobble
            particle.rotation += particle.wobble * 0.01;
            
            // Draw particle
            ctx.save();
            ctx.translate(particle.position.x, particle.position.y);
            ctx.rotate(particle.rotation);
            ctx.scale(particle.scale.x, particle.scale.y);
            
            ctx.fillStyle = particle.color.front;
            ctx.fillRect(
                -particle.dimensions.x / 2,
                -particle.dimensions.y / 2,
                particle.dimensions.x,
                particle.dimensions.y
            );
            
            ctx.restore();
            
            // Remove particles that are out of view
            if (particle.position.y >= canvas.height) {
                confetti.splice(i, 1);
                i--;
            }
        }

        if (confetti.length > 0) {
            requestAnimationFrame(update);
        }
    }

    update();
}

function showNotification(message, type = '') {
    const notification = document.getElementById("notification");
    notification.textContent = message;
    notification.className = "notification";
    if (type) notification.classList.add(type);
    notification.classList.add("show");
    
    setTimeout(() => {
        notification.classList.remove("show");
    }, 3000);
}

// Auto init
load();
</script>
</body>
</html>
