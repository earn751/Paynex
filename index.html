<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HiGriP üëä - Advanced Promotion Bot</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<!-- Firebase Database -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<!-- Firebase Analytics -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
<style>
/* HiGriP Advanced Promotion Bot üëä | 2025 */
:root {
    --bg: linear-gradient(135deg, #0f0f1a 0%, #1a0033 100%);
    --neon-purple: #9d4edd;
    --neon-cyan: #00f2ff;
    --neon-pink: #ff2a6d;
    --neon-green: #00ff9d;
    --card: rgba(30, 15, 60, 0.8);
    --text: #e0e0ff;
    --success: #00ff9d;
    --warning: #ffcc00;
    --error: #ff3860;
    --glass: rgba(255, 255, 255, 0.1);
}
* { 
    margin:0; 
    padding:0; 
    box-sizing:border-box; 
}
body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    padding-bottom: 80px;
    line-height: 1.6;
}
.container { 
    padding: 15px; 
    max-width: 500px; 
    margin: 0 auto; 
}
header {
    text-align: center;
    padding: 20px 0;
    background: rgba(0,0,0,0.4);
    border-radius: 20px;
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(157,78,221,0.2);
    position: relative;
    overflow: hidden;
}
header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--neon-purple), var(--neon-cyan), transparent);
}
.user-profile {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 15px;
}
.avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 2px solid var(--neon-cyan);
    background: var(--card);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5em;
    overflow: hidden;
}
.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.user-info {
    text-align: left;
}
.user-name {
    font-size: 1.2em;
    font-weight: bold;
    margin-bottom: 5px;
}
.user-username {
    color: var(--neon-cyan);
    opacity: 0.8;
}
h1 { 
    font-size: 2.2em; 
    background: linear-gradient(90deg, var(--neon-purple), var(--neon-cyan)); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent; 
    margin-bottom: 10px;
}
.balance {
    font-size: 2em;
    margin: 15px 0;
    font-weight: bold;
    text-shadow: 0 0 20px var(--neon-purple);
}
.level { 
    font-size: 1.1em; 
    color: var(--neon-cyan); 
    margin-bottom: 5px;
}
.streak { 
    font-size: 1.6em; 
    color: #ff6b6b; 
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.card {
    background: var(--card);
    border-radius: 20px;
    padding: 20px;
    margin: 15px 0;
    border: 1px solid rgba(157,78,221,0.3);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    transition: transform 0.3s, box-shadow 0.3s;
}
.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(157,78,221,0.3);
}
.btn {
    background: linear-gradient(45deg, var(--neon-purple), var(--neon-cyan));
    color: white;
    border: none;
    padding: 15px;
    border-radius: 15px;
    font-size: 1.1em;
    font-weight: bold;
    width: 100%;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 5px 15px rgba(157,78,221,0.4);
    position: relative;
    overflow: hidden;
}
.btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}
.btn:hover::after {
    left: 100%;
}
.btn:active { 
    transform: scale(0.95); 
}
.btn:disabled {
    background: #555;
    cursor: not-allowed;
    transform: none;
}
.btn-success {
    background: linear-gradient(45deg, var(--success), #00cc7e);
}
.btn-warning {
    background: linear-gradient(45deg, var(--warning), #ffaa00);
}
.btn-danger {
    background: linear-gradient(45deg, var(--error), #ff1e56);
}
.btn-vip {
    background: linear-gradient(45deg, #ffd700, #ff6b00);
}
.fist { 
    font-size: 2.5em; 
    display: inline-block; 
    animation: punch 1s infinite; 
}
@keyframes punch { 
    0%,100%{transform:rotate(0)} 
    50%{transform:rotate(-20deg) translateX(-10px)} 
}
.progress { 
    height: 12px; 
    background: #333; 
    border-radius: 6px; 
    overflow: hidden; 
    margin: 10px 0; 
    position: relative;
}
.progress-bar { 
    height: 100%; 
    background: linear-gradient(90deg, #9d4edd, #00f2ff); 
    width: 0%; 
    transition: width 1s; 
    border-radius: 6px;
    position: relative;
}
.progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}
@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
.tabs { 
    display: flex; 
    background: rgba(0,0,0,0.5); 
    border-radius: 15px; 
    overflow: hidden; 
    margin: 15px 0; 
    border: 1px solid rgba(157,78,221,0.2);
}
.tab { 
    flex: 1; 
    padding: 15px; 
    text-align: center; 
    cursor: pointer; 
    transition: 0.3s; 
    font-weight: bold;
    font-size: 0.9em;
}
.tab.active { 
    background: var(--neon-purple); 
    box-shadow: 0 0 10px rgba(157,78,221,0.5);
}
.task {
    background: rgba(255,255,255,0.05);
    border-radius: 15px;
    padding: 15px;
    margin: 12px 0;
    border-left: 5px solid var(--neon-cyan);
    transition: all 0.3s;
}
.task:hover {
    background: rgba(255,255,255,0.08);
    transform: translateX(5px);
}
.task.completed {
    border-left-color: var(--success);
    background: rgba(0,255,157,0.05);
}
.modal {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.95);
    display: none; 
    align-items: center; 
    justify-content: center; 
    z-index: 9999;
    backdrop-filter: blur(5px);
}
.modal-content {
    background: #1a0033; 
    padding: 30px; 
    border-radius: 25px; 
    text-align: center;
    border: 2px solid var(--neon-purple); 
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: popup 0.5s;
    box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    position: relative;
}
.modal-content::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, var(--neon-purple), var(--neon-cyan), var(--neon-pink), var(--neon-purple));
    border-radius: 27px;
    z-index: -1;
    background-size: 400% 400%;
    animation: gradient 3s ease infinite;
}
@keyframes gradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
@keyframes popup { 
    from {transform: scale(0.5)} 
    to {transform: scale(1)} 
}
#floating-btn {
    position: fixed; 
    bottom: 20px; 
    right: 20px; 
    width: 70px; 
    height: 70px;
    background: linear-gradient(45deg, #9d4edd, #00f2ff);
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    font-size: 2.5em; 
    box-shadow: 0 10px 30px rgba(157,78,221,0.6); 
    z-index: 999;
    animation: float 3s infinite;
    cursor: pointer;
    border: 2px solid rgba(255,255,255,0.2);
    transition: all 0.3s;
}
#floating-btn:active {
    transform: scale(0.9);
}
@keyframes float { 
    0%,100%{transform:translateY(0)} 
    50%{transform:translateY(-15px)} 
}
.hidden { 
    display: none !important; 
}
.leaderboard { 
    max-height: 400px; 
    overflow-y: auto; 
    padding: 10px;
    border-radius: 15px;
    background: rgba(0,0,0,0.3);
}
.leaderboard-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 15px;
    margin: 8px 0;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    transition: all 0.3s;
}
.leaderboard-item:hover {
    background: rgba(255,255,255,0.1);
    transform: translateX(5px);
}
.leaderboard-item:nth-child(1) {
    background: linear-gradient(90deg, rgba(255,215,0,0.2), transparent);
    border-left: 3px solid gold;
}
.leaderboard-item:nth-child(2) {
    background: linear-gradient(90deg, rgba(192,192,192,0.2), transparent);
    border-left: 3px solid silver;
}
.leaderboard-item:nth-child(3) {
    background: linear-gradient(90deg, rgba(205,127,50,0.2), transparent);
    border-left: 3px solid #cd7f32;
}
.confetti { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    pointer-events: none; 
    z-index: 99999; 
}
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card);
    padding: 15px 20px;
    border-radius: 10px;
    border-left: 5px solid var(--neon-cyan);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    z-index: 10000;
    transform: translateX(150%);
    transition: transform 0.5s;
    max-width: 300px;
}
.notification.show {
    transform: translateX(0);
}
.notification.success {
    border-left-color: var(--success);
}
.notification.error {
    border-left-color: var(--error);
}
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin: 15px 0;
}
.stat-card {
    background: rgba(0,0,0,0.3);
    border-radius: 15px;
    padding: 15px;
    text-align: center;
    border: 1px solid rgba(157,78,221,0.2);
}
.stat-value {
    font-size: 1.5em;
    font-weight: bold;
    color: var(--neon-cyan);
    margin-bottom: 5px;
}
.stat-label {
    font-size: 0.9em;
    opacity: 0.8;
}
.ref-link {
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    padding: 10px 15px;
    margin: 10px 0;
    word-break: break-all;
    border: 1px dashed var(--neon-purple);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.copy-btn {
    background: var(--neon-purple);
    border: none;
    border-radius: 5px;
    padding: 5px 10px;
    color: white;
    cursor: pointer;
    font-size: 0.8em;
}
.badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 0.7em;
    font-weight: bold;
    margin-left: 5px;
}
.badge-vip {
    background: linear-gradient(45deg, #ffd700, #ff6b00);
    color: black;
}
.badge-premium {
    background: linear-gradient(45deg, #9d4edd, #00f2ff);
    color: white;
}
.badge-new {
    background: var(--neon-green);
    color: black;
}
.verification-badge {
    color: var(--success);
    font-size: 0.8em;
    margin-left: 5px;
}
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: var(--neon-cyan);
    animation: spin 1s ease-in-out infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.admin-panel {
    border: 2px solid #ff6b6b;
    background: rgba(255,107,107,0.1);
}
.admin-section {
    margin: 15px 0;
    padding: 15px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
}
.admin-controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin: 10px 0;
}
.admin-user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin: 5px 0;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
}
</style>
</head>
<body>
<div class="container">
    <header>
        <div class="user-profile">
            <div class="avatar" id="userAvatar">
                <!-- Avatar will be loaded by JavaScript -->
            </div>
            <div class="user-info">
                <div class="user-name" id="userName">Loading...</div>
                <div class="user-username" id="userUsername">@username</div>
            </div>
        </div>
        
        <h1>HiGriP <span class="fist">üëä</span></h1>
        <div class="balance" id="balance">0 GRIP üëä</div>
        <div class="level">Level <span id="level">1</span> ‚Ä¢ <span id="multiplier">1.1</span>x Multiplier</div>
        <div class="streak">üî• Streak: <span id="streak">0</span> days</div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalEarned">0</div>
                <div class="stat-label">Total Earned</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="referrals">0</div>
                <div class="stat-label">Referrals</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="tasksCompleted">0</div>
                <div class="stat-label">Tasks Done</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="userRank">#-</div>
                <div class="stat-label">Rank</div>
            </div>
        </div>
    </header>

    <div class="card">
        <div class="progress">
            <div class="progress-bar" id="dailyProgress"></div>
        </div>
        <small>Grip Strength: <span id="gripStrength">0</span>% ‚Ä¢ Next Level: <span id="nextLevel">10000</span> GRIP</small>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="openTab('earn')">EARN üëä</div>
        <div class="tab" onclick="openTab('promote')">PROMOTE</div>
        <div class="tab" onclick="openTab('leaderboard')">TOP</div>
        <div class="tab" onclick="openTab('referral')">TEAM</div>
    </div>

    <div id="earn" class="tab-content">
        <div id="dailyClaim" class="card task">
            <h3>üî• Daily Grip Bonus</h3>
            <p>Day <span id="streakDay">1</span>: <b id="dailyReward">200</b> GRIP üëä</p>
            <button class="btn" id="dailyClaimBtn" onclick="claimDaily()">Claim Daily Bonus</button>
        </div>
        
        <div class="card">
            <h3>üéØ Available Tasks <span class="badge badge-new" id="tasksCount">3</span></h3>
            <div id="tasksList"></div>
        </div>
        
        <div class="card">
            <h3>üéÆ Quick Games</h3>
            <button class="btn btn-success" onclick="playMiniGame()">Tap Game (+50 GRIP)</button>
            <button class="btn btn-warning" onclick="startLuckyDraw()">Lucky Draw (+100-500 GRIP)</button>
        </div>
    </div>

    <div id="promote" class="tab-content hidden">
        <div class="card">
            <h3>üì¢ Create Promotion</h3>
            <button class="btn" onclick="showCreateTask()">+ Create New Promotion</button>
            <p style="text-align: center; margin-top: 10px; opacity: 0.8;">Promote your channel and earn GRIP</p>
        </div>
        <div id="myPromotions"></div>
    </div>

    <div id="leaderboard" class="tab-content hidden">
        <div class="card">
            <h2>üèÜ Top Earners</h2>
            <div id="topEarners" class="leaderboard"></div>
        </div>
        
        <div class="card">
            <h2>üëë Top Referrers</h2>
            <div id="topReferrers" class="leaderboard"></div>
        </div>
        
        <div class="card">
            <h2>‚ö° Most Active</h2>
            <div id="mostActive" class="leaderboard"></div>
        </div>
    </div>

    <div id="referral" class="tab-content hidden">
        <div class="card">
            <h3>üë• Multi-Level Referral</h3>
            <button class="btn" onclick="shareReferral()">Invite Friends</button>
            
            <div class="ref-link">
                <span id="refLink">loading...</span>
                <button class="copy-btn" onclick="copyRefLink()">Copy</button>
            </div>
            
            <div class="stats-grid" style="margin-top: 15px;">
                <div class="stat-card">
                    <div class="stat-value" id="level1Ref">0</div>
                    <div class="stat-label">Direct</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="level2Ref">0</div>
                    <div class="stat-label">Level 2</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="level3Ref">0</div>
                    <div class="stat-label">Level 3</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRefEarned">0</div>
                    <div class="stat-label">Earned</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>ü§ù Your Team</h3>
            <div id="teamList" class="leaderboard"></div>
        </div>
    </div>

    <div class="card admin-panel hidden" id="adminPanel">
        <h2 style="color:#ff6b6b;">Admin Panel üëë</h2>
        
        <div class="admin-section">
            <h3>User Management</h3>
            <div class="admin-controls">
                <button class="btn btn-warning" onclick="showUserManagement()">Manage Users</button>
                <button class="btn btn-danger" onclick="showTaskManagement()">Manage Tasks</button>
            </div>
            <div id="userManagementList"></div>
            <div id="taskManagementList"></div>
        </div>
        
        <div class="admin-section">
            <h3>System Controls</h3>
            <div class="admin-controls">
                <button class="btn" onclick="generateDemoUsers()">Generate Demo Users</button>
                <button class="btn btn-success" onclick="updateLeaderboard()">Update Leaderboard</button>
            </div>
        </div>
        
        <div id="pendingProofs"></div>
    </div>
</div>

<div id="floating-btn" onclick="quickEarn()">üëä</div>

<!-- Pre-Join Rules Modal -->
<div class="modal" id="rulesModal">
    <div class="modal-content">
        <h1>HiGripGo Promotion Bot <span class="fist">üëä</span></h1>
        <p style="margin:20px 0; line-height:1.6;">
            ‚úÖ Earn GRIP by joining channels/groups<br>
            ‚úÖ Promote your own channel & earn<br>
            ‚úÖ Auto-verification system<br>
            ‚úÖ Multi-level referral program<br>
            <span style="color:#ff6b6b;">üö´ Fake SS / spam = permanent ban</span>
        </p>
        <button class="btn" style="font-size:1.3em;" onclick="acceptRules()">‚úÖ I Accept Rules & Join</button>
        <button class="btn btn-warning" style="margin-top:10px;" onclick="cancelJoin()">Cancel</button>
    </div>
</div>

<!-- Create Promotion Modal -->
<div class="modal" id="createPromoModal">
    <div class="modal-content">
        <h2>Create Promotion</h2>
        <div style="text-align: left; margin: 20px 0;">
            <label style="display: block; margin-bottom: 8px;">Promotion Title</label>
            <input type="text" id="promoTitle" placeholder="Enter title" style="width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--neon-purple); color: white; margin-bottom: 15px;">
            
            <label style="display: block; margin-bottom: 8px;">Channel/Group Link</label>
            <input type="text" id="promoLink" placeholder="https://t.me/..." style="width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--neon-purple); color: white; margin-bottom: 15px;">
            
            <label style="display: block; margin-bottom: 8px;">Reward per Joiner (GRIP)</label>
            <input type="number" id="promoReward" placeholder="500" min="100" max="5000" style="width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--neon-purple); color: white; margin-bottom: 15px;">
            
            <label style="display: block; margin-bottom: 8px;">Budget (Total GRIP to spend)</label>
            <input type="number" id="promoBudget" placeholder="10000" min="1000" style="width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--neon-purple); color: white; margin-bottom: 15px;">
        </div>
        <button class="btn" onclick="createPromotion()">Create Promotion</button>
        <button class="btn btn-warning" style="margin-top:10px;" onclick="closeCreatePromo()">Cancel</button>
    </div>
</div>

<!-- Game Modal -->
<div class="modal" id="gameModal">
    <div class="modal-content">
        <h2 id="gameTitle">Quick Tap Game</h2>
        <div id="gameContent" style="margin: 20px 0; min-height: 100px; display: flex; align-items: center; justify-content: center;">
            <!-- Game content will be loaded here -->
        </div>
        <button class="btn" id="gameActionBtn" onclick="handleGameAction()">Start Game</button>
        <button class="btn btn-warning" style="margin-top:10px;" onclick="closeGame()">Close</button>
    </div>
</div>

<!-- Admin User Management Modal -->
<div class="modal" id="adminUserModal">
    <div class="modal-content">
        <h2>User Management</h2>
        <div id="adminUserList" style="max-height: 400px; overflow-y: auto; margin: 20px 0;"></div>
        <button class="btn btn-warning" onclick="closeAdminUserModal()">Close</button>
    </div>
</div>

<!-- Admin Task Management Modal -->
<div class="modal" id="adminTaskModal">
    <div class="modal-content">
        <h2>Task Management</h2>
        <div id="adminTaskList" style="max-height: 400px; overflow-y: auto; margin: 20px 0;"></div>
        <button class="btn" onclick="addNewTask()">Add New Task</button>
        <button class="btn btn-warning" style="margin-top:10px;" onclick="closeAdminTaskModal()">Close</button>
    </div>
</div>

<div class="notification" id="notification"></div>
<canvas id="confettiCanvas" class="confetti"></canvas>

<script>
// HiGriP Advanced Promotion Bot üëä | 2025
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyCho5RtEIoXnNlNNrpBg65BmTpJY23Se7Y",
    authDomain: "maillbeex.firebaseapp.com",
    databaseURL: "https://maillbeex-default-rtdb.firebaseio.com",
    projectId: "maillbeex",
    storageBucket: "maillbeex.firebasestorage.app",
    messagingSenderId: "5938669413",
    appId: "1:5938669413:web:34b6bbbbb0e81628a2a38c",
    measurementId: "G-F6YNLNQSK7"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// Bot Configuration
const BOT_TOKEN = "8524488850:AAFEMnAhznZaCoGAkKNQviWmZVlQLB1DANE";
const ADMIN_ID = 7243906826;

let user = tg.initDataUnsafe.user || {id: Date.now(), first_name: "Guest", username: "guest"};
let currentTaskLink = "";
let currentTaskId = null;
let currentGame = null;
let gameScore = 0;

// Initialize the application
async function load() {
    showNotification("üîÑ Connecting to HiGriP Network...", "success");
    
    try {
        // Sign in anonymously to Firebase
        await auth.signInAnonymously();
        
        // Load user data from Firebase
        const userSnapshot = await database.ref('users/' + user.id).once('value');
        
        if (userSnapshot.exists()) {
            // User exists in Firebase
            const firebaseUser = userSnapshot.val();
            Object.assign(user, firebaseUser);
            showNotification(`Welcome back, ${user.first_name}! üëä`, "success");
        } else {
            // New user - initialize in Firebase
            await initUser();
            showNotification(`Welcome to HiGriP, ${user.first_name}! üéâ`, "success");
        }
        
        // Update UI with loaded data
        updateUI();
        checkAdmin();
        checkDaily();
        renderTasks();
        renderPromotions();
        renderLeaderboard();
        renderTeamStats();
        
        // Set up real-time listeners
        setupRealtimeListeners();
        
    } catch (error) {
        console.error("Error loading data:", error);
        showNotification("‚ö†Ô∏è Using offline mode. Some features limited.", "error");
        loadFromLocalStorage();
    }
}

function loadFromLocalStorage() {
    const saved = localStorage.getItem("higrip_db");
    if (saved) {
        try {
            const db = JSON.parse(saved);
            if (db.users && db.users[user.id]) {
                Object.assign(user, db.users[user.id]);
            }
        } catch (e) {
            console.error("Error loading from localStorage:", e);
        }
    }
    updateUI();
    checkDaily();
    renderTasks();
}

async function initUser() {
    const urlParams = new URLSearchParams(window.location.search);
    const refParam = urlParams.get('start');
    let referrerId = null;
    
    if (refParam && refParam.startsWith('ref')) {
        referrerId = refParam.replace('ref', '');
    }
    
    const newUser = {
        id: user.id,
        first_name: user.first_name || "User",
        username: user.username || "user" + user.id,
        balance: 500,
        total_earned: 0,
        streak: 0,
        lastDaily: 0,
        referrals: 0,
        level1_refs: [],
        level2_refs: [],
        level3_refs: [],
        dailyTasks: 0,
        tasksCompleted: 0,
        joinedDate: Date.now(),
        completedTasks: [],
        is_verified: false,
        avatar_url: user.photo_url || null
    };
    
    // Handle referral
    if (referrerId) {
        try {
            const referrerSnapshot = await database.ref('users/' + referrerId).once('value');
            if (referrerSnapshot.exists()) {
                newUser.balance = 1300;
                newUser.referred_by = referrerId;
                
                // Update referrer's data
                await database.ref('users/' + referrerId).transaction((referrer) => {
                    if (referrer) {
                        referrer.balance += 800;
                        referrer.referrals = (referrer.referrals || 0) + 1;
                        referrer.level1_refs = referrer.level1_refs || [];
                        if (!referrer.level1_refs.includes(user.id)) {
                            referrer.level1_refs.push(user.id);
                        }
                    }
                    return referrer;
                });
                
                // Update level 2 and 3 referrals
                await updateMultiLevelReferrals(referrerId, user.id);
            }
        } catch (error) {
            console.error("Error handling referral:", error);
        }
    }
    
    // Save user to Firebase
    await database.ref('users/' + user.id).set(newUser);
    Object.assign(user, newUser);
}

async function updateMultiLevelReferrals(referrerId, newUserId) {
    try {
        // Level 2 (referrer of referrer)
        const referrerSnapshot = await database.ref('users/' + referrerId).once('value');
        if (referrerSnapshot.exists()) {
            const referrer = referrerSnapshot.val();
            if (referrer.referred_by) {
                await database.ref('users/' + referrer.referred_by).transaction((level2User) => {
                    if (level2User) {
                        level2User.level2_refs = level2User.level2_refs || [];
                        if (!level2User.level2_refs.includes(newUserId)) {
                            level2User.level2_refs.push(newUserId);
                        }
                    }
                    return level2User;
                });
                
                // Level 3 (referrer of referrer of referrer)
                const level2Snapshot = await database.ref('users/' + referrer.referred_by).once('value');
                if (level2Snapshot.exists()) {
                    const level2User = level2Snapshot.val();
                    if (level2User.referred_by) {
                        await database.ref('users/' + level2User.referred_by).transaction((level3User) => {
                            if (level3User) {
                                level3User.level3_refs = level3User.level3_refs || [];
                                if (!level3User.level3_refs.includes(newUserId)) {
                                    level3User.level3_refs.push(newUserId);
                                }
                            }
                            return level3User;
                        });
                    }
                }
            }
        }
    } catch (error) {
        console.error("Error updating multi-level referrals:", error);
    }
}

function updateUI() {
    // Update user profile
    document.getElementById("userName").textContent = user.first_name;
    document.getElementById("userUsername").textContent = user.username ? "@" + user.username : "No username";
    
    // Update avatar
    const avatarElement = document.getElementById("userAvatar");
    if (user.avatar_url) {
        avatarElement.innerHTML = `<img src="${user.avatar_url}" alt="Avatar" onerror="this.style.display='none'">`;
    } else {
        avatarElement.textContent = user.first_name ? user.first_name.charAt(0).toUpperCase() : "U";
    }
    
    // Update balance and stats
    document.getElementById("balance").innerText = user.balance.toLocaleString() + " GRIP üëä";
    const lvl = Math.floor(user.total_earned / 10000) + 1;
    document.getElementById("level").innerText = lvl;
    document.getElementById("multiplier").innerText = (lvl * 1.1).toFixed(1);
    document.getElementById("streak").innerText = user.streak || 0;
    document.getElementById("totalEarned").innerText = user.total_earned.toLocaleString();
    document.getElementById("referrals").innerText = user.referrals || 0;
    document.getElementById("tasksCompleted").innerText = user.tasksCompleted || 0;
    document.getElementById("nextLevel").innerText = (lvl * 10000).toLocaleString();
    
    const strength = Math.min(100, (user.dailyTasks || 0) * 20);
    document.getElementById("dailyProgress").style.width = strength + "%";
    document.getElementById("gripStrength").innerText = strength;
}

function checkDaily() {
    const today = new Date().toDateString();
    if (user.lastDaily !== today) {
        const day = ((user.streak || 0) % 7) + 1;
        document.getElementById("streakDay").innerText = day;
        document.getElementById("dailyReward").innerText = day * 200 + 600;
        document.getElementById("dailyClaimBtn").disabled = false;
        document.getElementById("dailyClaimBtn").innerText = "Claim Daily Bonus";
    } else {
        document.getElementById("dailyClaimBtn").disabled = true;
        document.getElementById("dailyClaimBtn").innerText = "‚úÖ Already Claimed Today";
    }
}

async function claimDaily() {
    const today = new Date().toDateString();
    if (user.lastDaily === today) {
        showNotification("You've already claimed your daily bonus today!", "error");
        return;
    }
    
    user.streak = (user.streak || 0) + 1;
    const day = (user.streak % 7) || 7;
    const reward = day <= 7 ? day * 200 + 600 : 2000;
    
    user.balance += reward;
    user.total_earned += reward;
    user.lastDaily = today;
    
    try {
        await database.ref('users/' + user.id).update({
            balance: user.balance,
            total_earned: user.total_earned,
            streak: user.streak,
            lastDaily: user.lastDaily
        });
    } catch (error) {
        console.error("Error updating daily claim:", error);
        saveToLocalStorage();
    }
    
    confettiBurst();
    updateUI();
    checkDaily();
    tg.HapticFeedback.notificationOccurred("success");
    showNotification(`Daily bonus claimed! +${reward} GRIP üëä`, "success");
}

function renderTasks() {
    const list = document.getElementById("tasksList");
    list.innerHTML = "";
    
    const sampleTasks = [
        {id:1, title:"Join Official Channel", type:"channel", link:"https://t.me/higripgo", reward:1200, budget:500000, done:0},
        {id:2, title:"Join Earning Group BD", type:"group", link:"https://t.me/bdearning24", reward:1500, budget:300000, done:0},
        {id:3, title:"Start @AirdropBot", type:"bot", link:"https://t.me/Airdrop", reward:800, budget:999999, done:0},
        {id:4, title:"Follow on Twitter", type:"social", link:"https://twitter.com/higrip", reward:600, budget:200000, done:0},
        {id:5, title:"Subscribe YouTube", type:"social", link:"https://youtube.com/higrip", reward:1000, budget:150000, done:0}
    ];
    
    document.getElementById("tasksCount").textContent = sampleTasks.length;
    
    sampleTasks.forEach(t => {
        const isCompleted = user.completedTasks && user.completedTasks.includes(t.id);
        const div = document.createElement("div");
        div.className = `task ${isCompleted ? 'completed' : ''}`;
        div.innerHTML = `
            <h3>${t.title} ${isCompleted ? '‚úÖ' : ''}</h3>
            <p>Reward: <b>${t.reward} GRIP üëä</b></p>
            <button class="btn ${isCompleted ? 'btn-success' : ''}" onclick="startTask('${t.type}','${t.link}', ${t.id})" ${isCompleted ? 'disabled' : ''}>
                ${isCompleted ? '‚úÖ Completed' : 'Join & Earn'}
            </button>
        `;
        list.appendChild(div);
    });
}

async function startTask(type, link, taskId) {
    if (type === "channel" || type === "group") {
        currentTaskLink = link;
        currentTaskId = taskId;
        document.getElementById("rulesModal").style.display = "flex";
    } else {
        window.open(link, "_blank");
        setTimeout(() => {
            completeTask(taskId);
        }, 3000);
    }
}

async function acceptRules() {
    document.getElementById("rulesModal").style.display = "none";
    tg.openLink(currentTaskLink);
    
    // Auto-verification using Telegram Bot API
    if (currentTaskId) {
        showNotification("üîÑ Verifying your join...", "success");
        
        setTimeout(async () => {
            try {
                const isMember = await verifyChannelMembership(currentTaskLink);
                if (isMember) {
                    await completeTask(currentTaskId);
                } else {
                    showNotification("Please join the channel first, then try again.", "error");
                }
            } catch (error) {
                console.error("Verification error:", error);
                showNotification("Manual verification required. Please send screenshot.", "warning");
            }
        }, 5000);
    }
}

async function verifyChannelMembership(channelLink) {
    try {
        // Extract channel username from link
        const channelMatch = channelLink.match(/t\.me\/([a-zA-Z0-9_]+)/);
        if (!channelMatch) return false;
        
        const channelUsername = channelMatch[1];
        
        // In a real implementation, you would call your backend API
        // that uses the Telegram Bot API to check membership
        const response = await fetch('/api/verify-membership', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                userId: user.id,
                channel: channelUsername,
                botToken: BOT_TOKEN
            })
        });
        
        const result = await response.json();
        return result.isMember;
        
    } catch (error) {
        console.error("Verification failed:", error);
        return false;
    }
}

async function completeTask(taskId) {
    if (!user.completedTasks) user.completedTasks = [];
    if (user.completedTasks.includes(taskId)) return;
    
    const task = getTaskById(taskId);
    if (!task) return;
    
    user.completedTasks.push(taskId);
    user.balance += task.reward;
    user.total_earned += task.reward;
    user.dailyTasks = (user.dailyTasks || 0) + 1;
    user.tasksCompleted = (user.tasksCompleted || 0) + 1;
    
    try {
        await database.ref('users/' + user.id).update({
            completedTasks: user.completedTasks,
            balance: user.balance,
            total_earned: user.total_earned,
            dailyTasks: user.dailyTasks,
            tasksCompleted: user.tasksCompleted
        });
    } catch (error) {
        console.error("Error updating task completion:", error);
        saveToLocalStorage();
    }
    
    updateUI();
    renderTasks();
    tg.HapticFeedback.notificationOccurred("success");
    showNotification(`Task completed! +${task.reward} GRIP üëä`, "success");
}

function getTaskById(taskId) {
    const sampleTasks = [
        {id:1, title:"Join Official Channel", type:"channel", link:"https://t.me/higripgo", reward:1200, budget:500000, done:0},
        {id:2, title:"Join Earning Group BD", type:"group", link:"https://t.me/bdearning24", reward:1500, budget:300000, done:0},
        {id:3, title:"Start @AirdropBot", type:"bot", link:"https://t.me/Airdrop", reward:800, budget:999999, done:0},
        {id:4, title:"Follow on Twitter", type:"social", link:"https://twitter.com/higrip", reward:600, budget:200000, done:0},
        {id:5, title:"Subscribe YouTube", type:"social", link:"https://youtube.com/higrip", reward:1000, budget:150000, done:0}
    ];
    return sampleTasks.find(t => t.id === taskId);
}

function cancelJoin() {
    document.getElementById("rulesModal").style.display = "none";
}

function shareReferral() {
    const link = `https://t.me/HiGriP_bot?start=ref${user.id}`;
    const message = `Join HiGriP and earn free GRIP! Use my referral link: ${link}`;
    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(message)}`);
}

function copyRefLink() {
    const link = `https://t.me/HiGriP_bot?start=ref${user.id}`;
    navigator.clipboard.writeText(link).then(() => {
        showNotification("Referral link copied to clipboard!", "success");
    }).catch(err => {
        console.error('Failed to copy: ', err);
        showNotification("Failed to copy link", "error");
    });
}

function checkAdmin() {
    if (user.id == ADMIN_ID) {
        document.getElementById("adminPanel").classList.remove("hidden");
        if (!document.querySelector('.tab[onclick="openTab(\'admin\')"]')) {
            document.querySelector(".tabs").insertAdjacentHTML('beforeend', '<div class="tab" onclick="openTab(\'admin\')">ADMIN</div>');
        }
        // Auto generate demo users for admin
        setTimeout(generateDemoUsers, 2000);
    }
}

function openTab(tab) {
    document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(tab).classList.remove("hidden");
    document.querySelector(`.tab[onclick="openTab('${tab}')"]`).classList.add("active");
    
    if (tab === 'leaderboard') {
        renderLeaderboard();
    } else if (tab === 'promote') {
        renderPromotions();
    } else if (tab === 'referral') {
        renderTeamStats();
    } else if (tab === 'admin') {
        showUserManagement();
    }
}

function quickEarn() {
    openTab('earn');
    document.getElementById("floating-btn").style.transform = "scale(1.5)";
    setTimeout(() => document.getElementById("floating-btn").style.transform = "", 300);
}

async function renderLeaderboard() {
    try {
        const usersSnapshot = await database.ref('users').once('value');
        const users = usersSnapshot.val() || {};
        
        const userArray = Object.values(users).filter(u => 
            u.total_earned > 0 && 
            u.tasksCompleted > 0 &&
            u.joinedDate > (Date.now() - 30*24*60*60*1000)
        );
        
        // Top Earners
        const earners = userArray.sort((a,b) => b.total_earned - a.total_earned).slice(0,10);
        const earnersHTML = earners.map((u,i) => 
            `<div class="leaderboard-item">
                <span>${i+1}. ${u.first_name} ${u.username ? '(@'+u.username+')' : ''}</span>
                <span>${u.total_earned.toLocaleString()} GRIP</span>
            </div>`
        ).join("");
        
        // Top Referrers
        const refs = userArray.sort((a,b) => (b.referrals||0) - (a.referrals||0)).slice(0,10);
        const refsHTML = refs.map((u,i) => 
            `<div class="leaderboard-item">
                <span>${i+1}. ${u.first_name} ${u.username ? '(@'+u.username+')' : ''}</span>
                <span>${u.referrals||0} referrals</span>
            </div>`
        ).join("");
        
        // Most Active
        const active = userArray.sort((a,b) => (b.tasksCompleted||0) - (a.tasksCompleted||0)).slice(0,10);
        const activeHTML = active.map((u,i) => 
            `<div class="leaderboard-item">
                <span>${i+1}. ${u.first_name} ${u.username ? '(@'+u.username+')' : ''}</span>
                <span>${u.tasksCompleted||0} tasks</span>
            </div>`
        ).join("");
        
        document.getElementById("topEarners").innerHTML = earnersHTML;
        document.getElementById("topReferrers").innerHTML = refsHTML;
        document.getElementById("mostActive").innerHTML = activeHTML;
        
        // Update user rank
        const userRank = earners.findIndex(u => u.id === user.id) + 1;
        document.getElementById("userRank").textContent = userRank ? "#" + userRank : "#-";
        
    } catch (error) {
        console.error("Error rendering leaderboard:", error);
        document.getElementById("topEarners").innerHTML = "<p>Error loading leaderboard</p>";
        document.getElementById("topReferrers").innerHTML = "<p>Error loading leaderboard</p>";
        document.getElementById("mostActive").innerHTML = "<p>Error loading leaderboard</p>";
    }
}

async function renderTeamStats() {
    try {
        document.getElementById("level1Ref").textContent = user.level1_refs ? user.level1_refs.length : 0;
        document.getElementById("level2Ref").textContent = user.level2_refs ? user.level2_refs.length : 0;
        document.getElementById("level3Ref").textContent = user.level3_refs ? user.level3_refs.length : 0;
        
        // Calculate total referral earnings (800 per direct referral)
        const totalRefEarned = (user.level1_refs ? user.level1_refs.length * 800 : 0);
        document.getElementById("totalRefEarned").textContent = totalRefEarned.toLocaleString();
        
        // Render team list
        const teamList = document.getElementById("teamList");
        if (user.level1_refs && user.level1_refs.length > 0) {
            let teamHTML = "";
            for (const refId of user.level1_refs.slice(0, 10)) {
                try {
                    const refSnapshot = await database.ref('users/' + refId).once('value');
                    if (refSnapshot.exists()) {
                        const refUser = refSnapshot.val();
                        teamHTML += `
                            <div class="leaderboard-item">
                                <span>${refUser.first_name} ${refUser.username ? '(@'+refUser.username+')' : ''}</span>
                                <span>${refUser.total_earned ? refUser.total_earned.toLocaleString() : '0'} GRIP</span>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error("Error loading team member:", error);
                }
            }
            teamList.innerHTML = teamHTML;
        } else {
            teamList.innerHTML = '<p style="text-align: center; opacity: 0.7;">No team members yet</p>';
        }
        
    } catch (error) {
        console.error("Error rendering team stats:", error);
    }
}

function showCreateTask() {
    document.getElementById("createPromoModal").style.display = "flex";
}

function closeCreatePromo() {
    document.getElementById("createPromoModal").style.display = "none";
}

async function createPromotion() {
    const title = document.getElementById("promoTitle").value;
    const link = document.getElementById("promoLink").value;
    const reward = parseInt(document.getElementById("promoReward").value);
    const budget = parseInt(document.getElementById("promoBudget").value);
    
    if (!title || !link || !reward || !budget) {
        showNotification("Please fill all fields", "error");
        return;
    }
    
    if (user.balance < budget) {
        showNotification("Not enough GRIP for this budget", "error");
        return;
    }
    
    // Deduct budget from user balance
    user.balance -= budget;
    
    // Create promotion
    const promo = {
        id: Date.now(),
        userId: user.id,
        title,
        link,
        reward,
        budget,
        spent: 0,
        createdAt: Date.now(),
        status: 'active',
        completions: 0
    };
    
    try {
        await database.ref('users/' + user.id).update({
            balance: user.balance
        });
        
        await database.ref('promotions/' + promo.id).set(promo);
    } catch (error) {
        console.error("Error creating promotion:", error);
        saveToLocalStorage();
    }
    
    closeCreatePromo();
    renderPromotions();
    updateUI();
    showNotification("Promotion created successfully!", "success");
}

async function renderPromotions() {
    const container = document.getElementById("myPromotions");
    container.innerHTML = "";
    
    try {
        const promotionsSnapshot = await database.ref('promotions').orderByChild('userId').equalTo(user.id).once('value');
        const promotions = promotionsSnapshot.val() || {};
        
        if (Object.keys(promotions).length === 0) {
            container.innerHTML = '<div class="task"><p>No promotions created yet</p></div>';
            return;
        }
        
        Object.values(promotions).forEach(promo => {
            const div = document.createElement("div");
            div.className = "task";
            div.innerHTML = `
                <h3>${promo.title}</h3>
                <p>Reward: ${promo.reward} GRIP per joiner</p>
                <p>Budget: ${promo.budget.toLocaleString()} GRIP ‚Ä¢ Spent: ${promo.spent.toLocaleString()} GRIP</p>
                <p>Completions: ${promo.completions || 0} ‚Ä¢ Status: <span style="color: ${promo.status === 'active' ? 'var(--success)' : '#ff6b6b'}">${promo.status}</span></p>
                <button class="btn" onclick="sharePromotion(${promo.id})">Share Promotion</button>
            `;
            container.appendChild(div);
    });
    } catch (error) {
        console.error("Error rendering promotions:", error);
        container.innerHTML = '<div class="task"><p>Error loading promotions</p></div>';
    }
}

function sharePromotion(promoId) {
    // This would typically fetch the promotion from database
    const message = `Join this promotion and earn GRIP! Check it out in the HiGriP app.`;
    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(message)}`);
}

// Mini Games
function playMiniGame() {
    currentGame = 'tap';
    gameScore = 0;
    document.getElementById("gameTitle").textContent = "Tap Game üéØ";
    document.getElementById("gameContent").innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 3em; margin-bottom: 20px;">üëä</div>
            <div style="font-size: 1.5em; margin-bottom: 10px;">Taps: <span id="tapCount">0</span>/20</div>
            <div style="font-size: 1.2em;">Reward: 50 GRIP</div>
        </div>
    `;
    document.getElementById("gameActionBtn").textContent = "Tap to Start!";
    document.getElementById("gameModal").style.display = "flex";
}

function startLuckyDraw() {
    currentGame = 'lucky';
    document.getElementById("gameTitle").textContent = "Lucky Draw üé∞";
    document.getElementById("gameContent").innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 3em; margin-bottom: 20px;">üéÅ</div>
            <div style="font-size: 1.2em; margin-bottom: 10px;">Spin to win 100-500 GRIP!</div>
            <div id="luckyResult" style="font-size: 1.5em; color: var(--neon-cyan);"></div>
        </div>
    `;
    document.getElementById("gameActionBtn").textContent = "Spin Now!";
    document.getElementById("gameModal").style.display = "flex";
}

function handleGameAction() {
    if (currentGame === 'tap') {
        gameScore++;
        document.getElementById("tapCount").textContent = gameScore;
        
        if (gameScore >= 20) {
            completeMiniGame(50);
        }
    } else if (currentGame === 'lucky') {
        const rewards = [100, 150, 200, 250, 300, 350, 400, 450, 500];
        const reward = rewards[Math.floor(Math.random() * rewards.length)];
        document.getElementById("luckyResult").textContent = `You won ${reward} GRIP!`;
        document.getElementById("gameActionBtn").textContent = "Claim Reward";
        document.getElementById("gameActionBtn").onclick = function() {
            completeMiniGame(reward);
        };
    }
}

async function completeMiniGame(reward) {
    user.balance += reward;
    user.total_earned += reward;
    
    try {
        await database.ref('users/' + user.id).update({
            balance: user.balance,
            total_earned: user.total_earned
        });
    } catch (error) {
        console.error("Error updating game reward:", error);
        saveToLocalStorage();
    }
    
    updateUI();
    closeGame();
    tg.HapticFeedback.notificationOccurred("success");
    showNotification(`Game completed! +${reward} GRIP üëä`, "success");
    confettiBurst();
}

function closeGame() {
    document.getElementById("gameModal").style.display = "none";
    currentGame = null;
}

// Admin Functions
async function showUserManagement() {
    try {
        const usersSnapshot = await database.ref('users').once('value');
        const users = usersSnapshot.val() || {};
        
        let userListHTML = '';
        Object.values(users).forEach(u => {
            userListHTML += `
                <div class="admin-user-item">
                    <div>
                        <strong>${u.first_name}</strong> 
                        ${u.username ? '(@'+u.username+')' : ''}
                        <br>
                        <small>ID: ${u.id} | Balance: ${u.balance} | Tasks: ${u.tasksCompleted || 0}</small>
                    </div>
                    <div>
                        <button class="btn btn-warning" style="padding:5px; font-size:0.8em;" onclick="editUser(${u.id})">Edit</button>
                        <button class="btn btn-danger" style="padding:5px; font-size:0.8em;" onclick="banUser(${u.id})">Ban</button>
                    </div>
                </div>
            `;
        });
        
        document.getElementById("userManagementList").innerHTML = userListHTML;
    } catch (error) {
        console.error("Error loading users:", error);
    }
}

async function showTaskManagement() {
    try {
        const tasks = [
            {id:1, title:"Join Official Channel", reward:1200, active:true},
            {id:2, title:"Join Earning Group BD", reward:1500, active:true},
            {id:3, title:"Start @AirdropBot", reward:800, active:true},
            {id:4, title:"Follow on Twitter", reward:600, active:true},
            {id:5, title:"Subscribe YouTube", reward:1000, active:true}
        ];
        
        let taskListHTML = '';
        tasks.forEach(task => {
            taskListHTML += `
                <div class="admin-user-item">
                    <div>
                        <strong>${task.title}</strong>
                        <br>
                        <small>Reward: ${task.reward} GRIP | ID: ${task.id}</small>
                    </div>
                    <div>
                        <button class="btn btn-warning" style="padding:5px; font-size:0.8em;" onclick="editTask(${task.id})">Edit</button>
                        <button class="btn btn-danger" style="padding:5px; font-size:0.8em;" onclick="deleteTask(${task.id})">Delete</button>
                    </div>
                </div>
            `;
        });
        
        document.getElementById("taskManagementList").innerHTML = taskListHTML;
    } catch (error) {
        console.error("Error loading tasks:", error);
    }
}

async function generateDemoUsers() {
    if (user.id != ADMIN_ID) return;
    
    showNotification("üîÑ Generating demo users...", "success");
    
    const demoUsers = [];
    
    // Generate 20+ demo users with random UIDs starting with 7267
    for (let i = 0; i < 25; i++) {
        const uid = 7267000000 + Math.floor(Math.random() * 1000000);
        const names = ["John", "Alice", "Bob", "Emma", "Mike", "Sarah", "David", "Lisa", "Tom", "Anna"];
        const usernames = ["john_doe", "alice_w", "bob_m", "emma_s", "mike_t", "sarah_j", "david_k", "lisa_m", "tom_b", "anna_r"];
        
        const demoUser = {
            id: uid,
            first_name: names[Math.floor(Math.random() * names.length)],
            username: usernames[Math.floor(Math.random() * usernames.length)] + Math.floor(Math.random() * 1000),
            balance: Math.floor(Math.random() * 50000) + 1000,
            total_earned: Math.floor(Math.random() * 100000) + 5000,
            streak: Math.floor(Math.random() * 30),
            referrals: Math.floor(Math.random() * 20),
            tasksCompleted: Math.floor(Math.random() * 50) + 10,
            dailyTasks: Math.floor(Math.random() * 5),
            joinedDate: Date.now() - Math.floor(Math.random() * 30 * 24 * 60 * 60 * 1000),
            completedTasks: [1,2,3,4,5].slice(0, Math.floor(Math.random() * 5) + 1),
            is_verified: Math.random() > 0.3
        };
        
        demoUsers.push(demoUser);
    }
    
    // Save demo users to Firebase
    try {
        for (const demoUser of demoUsers) {
            await database.ref('users/' + demoUser.id).set(demoUser);
        }
        showNotification("‚úÖ 25 demo users generated successfully!", "success");
        renderLeaderboard();
    } catch (error) {
        console.error("Error generating demo users:", error);
        showNotification("‚ùå Error generating demo users", "error");
    }
}

async function updateLeaderboard() {
    if (user.id != ADMIN_ID) return;
    
    showNotification("üîÑ Updating leaderboard...", "success");
    await renderLeaderboard();
    showNotification("‚úÖ Leaderboard updated!", "success");
}

function editUser(userId) {
    showNotification(`Editing user ${userId}`, "success");
    // Implementation for user editing
}

function banUser(userId) {
    if (confirm(`Are you sure you want to ban user ${userId}?`)) {
        showNotification(`User ${userId} banned`, "success");
        // Implementation for user banning
    }
}

function editTask(taskId) {
    showNotification(`Editing task ${taskId}`, "success");
    // Implementation for task editing
}

function deleteTask(taskId) {
    if (confirm(`Are you sure you want to delete task ${taskId}?`)) {
        showNotification(`Task ${taskId} deleted`, "success");
        // Implementation for task deletion
    }
}

function addNewTask() {
    showNotification("Add new task feature", "success");
    // Implementation for adding new tasks
}

function closeAdminUserModal() {
    document.getElementById("adminUserModal").style.display = "none";
}

function closeAdminTaskModal() {
    document.getElementById("adminTaskModal").style.display = "none";
}

function setupRealtimeListeners() {
    // Real-time user data updates
    database.ref('users/' + user.id).on('value', (snapshot) => {
        if (snapshot.exists()) {
            const updatedUser = snapshot.val();
            Object.assign(user, updatedUser);
            updateUI();
        }
    });
    
    // Real-time leaderboard updates
    database.ref('users').on('value', () => {
        renderLeaderboard();
    });
}

function saveToLocalStorage() {
    const db = {
        users: {},
        tasks: [],
        promotions: [],
        proofs: []
    };
    db.users[user.id] = user;
    localStorage.setItem("higrip_db", JSON.stringify(db));
}

function showNotification(message, type = '') {
    const notification = document.getElementById("notification");
    notification.textContent = message;
    notification.className = "notification";
    if (type) notification.classList.add(type);
    notification.classList.add("show");
    
    setTimeout(() => {
        notification.classList.remove("show");
    }, 3000);
}

function confettiBurst() {
    const canvas = document.getElementById("confettiCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const confetti = [];
    const confettiCount = 200;
    const gravity = 0.5;
    const terminalVelocity = 5;
    const drag = 0.075;
    const colors = [
        { front: '#9d4edd', back: '#7b2cbf' },
        { front: '#00f2ff', back: '#00b4c8' },
        { front: '#ff2a6d', back: '#d10047' },
        { front: '#00ff9d', back: '#00cc7e' },
        { front: '#ffcc00', back: '#e6b800' }
    ];

    // Initialize confetti particles
    for (let i = 0; i < confettiCount; i++) {
        confetti.push({
            color: colors[Math.floor(Math.random() * colors.length)],
            dimensions: {
                x: Math.random() * 10 + 10,
                y: Math.random() * 10 + 10
            },
            position: {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height
            },
            rotation: Math.random() * 2 * Math.PI,
            scale: {
                x: 1,
                y: 1
            },
            velocity: {
                x: Math.random() * 50 - 25,
                y: Math.random() * 50 + 50
            }
        });
    }

    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (let i = 0; i < confetti.length; i++) {
            const particle = confetti[i];
            
            // Apply forces
            particle.velocity.x -= particle.velocity.x * drag;
            particle.velocity.y = Math.min(particle.velocity.y + gravity, terminalVelocity);
            particle.velocity.x += Math.random() > 0.5 ? Math.random() : -Math.random();
            
            // Update position
            particle.position.x += particle.velocity.x;
            particle.position.y += particle.velocity.y;
            
            // Draw particle
            ctx.save();
            ctx.translate(particle.position.x, particle.position.y);
            ctx.rotate(particle.rotation);
            
            ctx.fillStyle = particle.dimensions.y > 10 ? particle.color.back : particle.color.front;
            ctx.fillRect(
                -particle.dimensions.x / 2,
                -particle.dimensions.y / 2,
                particle.dimensions.x,
                particle.dimensions.y
            );
            
            ctx.restore();
            
            // Remove particles that are out of view
            if (particle.position.y >= canvas.height) {
                confetti.splice(i, 1);
                i--;
            }
        }

        if (confetti.length > 0) {
            requestAnimationFrame(update);
        }
    }

    update();
}

// Auto init when page loads
load();
</script>
</body>
</html>
