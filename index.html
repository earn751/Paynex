<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiGrip - কয়েন উপার্জন</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f7f9fc; color: #1f2937; }
        .header { background: linear-gradient(135deg, #0f172a, #1e3a8a); }
        .card { box-shadow: 0 5px 15px -3px rgba(0,0,0,0.1); }
        .tier-gold { @apply bg-yellow-500 text-black; }
        .tier-silver { @apply bg-gray-400 text-white; }
        .tier-bronze { @apply bg-amber-800 text-white; }
    </style>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- LibTL SDK (তোমার Zone ID) -->
    <script src='//libtl.com/sdk.js' data-zone='10087307' data-sdk='show_10087307'></script>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="text-white text-center">
            <svg class="animate-spin h-10 w-10 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>লোড হচ্ছে...</p>
        </div>
    </div>

    <div id="app" class="flex flex-col flex-grow hidden">

        <!-- Header -->
        <header class="header text-white p-4 rounded-b-xl">
            <div class="flex items-center space-x-4">
                <img id="pic" class="w-12 h-12 rounded-full border-2 border-yellow-400" src="" alt="">
                <div class="flex-1">
                    <p class="font-bold" id="name">...</p>
                    <p class="text-xs text-gray-300">@<span id="username">...</span></p>
                </div>
            </div>
            <div class="mt-3 flex justify-between items-center">
                <div class="flex items-baseline space-x-1">
                    <span class="text-3xl font-extrabold text-yellow-300" id="coins">0</span>
                    <span class="text-sm">কয়েন</span>
                </div>
                <div id="tier" class="px-3 py-1 text-sm font-bold rounded-full tier-bronze">Bronze</div>
            </div>
        </header>

        <main class="p-4 flex-grow overflow-y-auto">

            <!-- Earn Tab -->
            <div id="tab-earn">
                <h2 class="text-xl font-bold mb-4">উপার্জন করুন</h2>

                <!-- Manual Ad -->
                <div class="bg-white p-5 rounded-xl card mb-6">
                    <div class="flex justify-between mb-3">
                        <p class="font-semibold">ভিডিও বিজ্ঞাপন দেখুন</p>
                        <span class="text-green-600 font-bold">+10 কয়েন</span>
                    </div>
                    <button id="adBtn" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg">দেখুন</button>
                    <div id="cooldown" class="mt-3 text-center text-sm text-gray-600 hidden">
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="bar" class="bg-red-600 h-2.5 rounded-full w-0"></div></div>
                        <span id="timer">৬০ সেকেন্ড</span>
                    </div>
                </div>

                <!-- Refer -->
                <div class="bg-white p-5 rounded-xl card">
                    <p class="font-semibold mb-2">রেফার করুন</p>
                    <p class="text-sm text-gray-600 mb-3">প্রতি রেফারে +৫০ কয়েন</p>
                    <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg mb-2">
                        <p class="text-sm truncate" id="refLink">t.me/...</p>
                        <button id="copyBtn" class="text-blue-600 font-bold text-sm">কপি</button>
                    </div>
                    <p class="text-sm">রেফার: <strong id="refCount">0</strong> জন</p>
                    <p id="refLock" class="text-xs text-red-600 mt-2 hidden">রিডিমের জন্য আরও <span id="needed">5</span> জন লাগবে</p>
                </div>
            </div>

            <!-- Redeem Tab -->
            <div id="tab-redeem" class="hidden">
                <h2 class="text-xl font-bold mb-4">রিডিম করুন</h2>
                <div class="space-y-4 mb-6">
                    <div class="bg-gradient-to-r from-pink-600 to-pink-700 p-4 rounded-xl text-white">
                        <p class="text-4xl font-bold text-center">৳100</p>
                        <p class="text-center">1,000 কয়েন</p>
                        <button data-type="bKash" data-amount="100" data-coins="1000" class="redeemBtn w-full mt-3 bg-white text-pink-700 font-bold py-2 rounded-lg">রিডিম</button>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-600 to-yellow-700 p-4 rounded-xl text-white">
                        <p class="text-4xl font-bold text-center">৳100</p>
                        <p class="text-center">1,000 কয়েন</p>
                        <button data-type="Nagad" data-amount="100" data-coins="1000" class="redeemBtn w-full mt-3 bg-white text-yellow-700 font-bold py-2 rounded-lg">রিডিম</button>
                    </div>
                </div>
                <h3 class="text-lg font-semibold mb-3">রিডিম ইতিহাস</h3>
                <div id="history" class="space-y-2">
                    <p class="text-gray-500 text-sm">কোনো রিডিম নেই</p>
                </div>
            </div>

            <!-- Feed Tab -->
            <div id="tab-feed" class="hidden">
                <h2 class="text-xl font-bold mb-4">লিডারবোর্ড</h2>
                <div id="leaderboard" class="space-y-3">
                    <p class="text-gray-500 text-sm">লোড হচ্ছে...</p>
                </div>
            </div>
        </main>

        <!-- Nav -->
        <nav class="bg-white border-t sticky bottom-0">
            <div class="flex justify-around py-2">
                <button data-tab="redeem" class="navBtn text-gray-600">
                    <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8c-2.485 0-4 .933-4 2.5v.5H7a2 2 0 00-2 2v3a2 2 0 002 2h10a2 2 0 002-2v-3a2 2 0 00-2-2h-1v-.5c0-1.567-1.515-2.5-4-2.5z"/></svg>
                    <span class="text-xs">রিডিম</span>
                </button>
                <button data-tab="earn" class="navBtn text-blue-600">
                    <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/><path d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/></svg>
                    <span class="text-xs">উপার্জন</span>
                </button>
                <button data-tab="feed" class="navBtn text-gray-600">
                    <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16m-7 6h7"/></svg>
                    <span class="text-xs">ফিড</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4" id="mTitle">রিডিম</h3>
            <p class="text-sm mb-4">৳<span id="mAmount">100</span> পেতে নাম্বার দিন</p>
            <input type="text" id="phone" placeholder="01XXXXXXXXX" class="w-full p-3 border rounded-lg mb-4" maxlength="11">
            <div class="flex space-x-3">
                <button id="cancel" class="flex-1 py-2 bg-gray-300 rounded-lg font-bold">বাতিল</button>
                <button id="submit" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-bold">পাঠান</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCho5RtEIoXnNlNNrpBg65BmTpJY23Se7Y",
            authDomain: "maillbeex.firebaseapp.com",
            databaseURL: "https://maillbeex-default-rtdb.firebaseio.com",
            projectId: "maillbeex",
            storageBucket: "maillbeex.firebasestorage.app",
            messagingSenderId: "5938669413",
            appId: "1:5938669413:web:34b6bbbbb0e81628a2a38c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let uid = null, userRef = null, userData = {};
        let telegramUser = null;

        async function init() {
            try {
                const cred = await auth.signInAnonymously();
                uid = cred.user.uid;

                telegramUser = tg.initDataUnsafe?.user;
                if (!telegramUser) throw new Error("Telegram User not found");

                userRef = db.ref('users/' + uid);
                userRef.update({
                    name: telegramUser.first_name,
                    username: telegramUser.username || 'নেই',
                    photo: telegramUser.photo_url || '',
                    lastSeen: Date.now()
                });

                userRef.on('value', s => {
                    userData = s.val() || { coins: 0, referrals: [], lastAd: 0 };
                    updateUI();
                });

                // Referral Check
                const refId = new URLSearchParams(location.search).get('start')?.replace('ref_', '');
                if (refId && refId !== uid && !userData.referrals?.includes(refId)) {
                    const refUser = db.ref('users/' + refId);
                    refUser.once('value').then(s => {
                        if (s.exists()) {
                            userRef.child('referrals').transaction(a => (a || []).concat(refId));
                            db.ref('users/' + refId + '/referred').transaction(a => (a || []).concat(uid));
                            userRef.child('coins').transaction(c => c + 50);
                            tg.showAlert('রেফার সফল! +50 কয়েন');
                        }
                    });
                }

                loadLeaderboard();
                loadHistory();

                // Auto Ad every 15 seconds
                setInterval(() => {
                    if (document.visibilityState === 'visible') {
                        showAd('pop').catch(() => {});
                    }
                }, 15000);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            } catch (e) {
                tg.showAlert("Error: " + e.message);
            }
        }

        function updateUI() {
            document.getElementById('name').textContent = userData.name || telegramUser.first_name;
            document.getElementById('username').textContent = userData.username || 'নেই';
            document.getElementById('pic').src = userData.photo || `https://ui-avatars.com/api/?name=${userData.name}`;
            document.getElementById('coins').textContent = userData.coins || 0;
            document.getElementById('refCount').textContent = (userData.referrals || []).length;

            // Real Referral Link with UID
            const botUsername = "HiGriP_bot"; // তোমার বটের @username
            document.getElementById('refLink').textContent = `t.me/${botUsername}?start=ref_${uid}`;

            const tier = userData.coins >= 5000 ? 'Gold' : userData.coins >= 1000 ? 'Silver' : 'Bronze';
            const t = document.getElementById('tier');
            t.textContent = tier + ' Tier';
            t.className = `px-3 py-1 text-sm font-bold rounded-full tier-${tier.toLowerCase()}`;

            const needed = Math.max(0, 5 - (userData.referrals || []).length);
            const lock = document.getElementById('refLock');
            if (needed > 0) {
                lock.classList.remove('hidden');
                document.getElementById('needed').textContent = needed;
            } else lock.classList.add('hidden');

            const now = Date.now();
            if (now - (userData.lastAd || 0) < 60000) startCooldown(userData.lastAd);

            document.querySelectorAll('.redeemBtn').forEach(b => {
                const req = +b.dataset.coins;
                b.disabled = needed > 0 || userData.coins < req;
                b.textContent = b.disabled ? (userData.coins < req ? 'কয়েন কম' : 'রেফার লক') : 'রিডিম';
            });
        }

        // LibTL Ad Function
        async function showAd(format = '') {
            return new Promise((resolve, reject) => {
                if (typeof show_10087307 === 'function') {
                    show_10087307(format).then(() => {
                        userRef.child('coins').transaction(c => c + 10);
                        userRef.child('lastAd').set(Date.now());
                        resolve();
                    }).catch(reject);
                } else {
                    reject('Ad not loaded');
                }
            });
        }

        // Manual Ad
        document.getElementById('adBtn').onclick = async () => {
            const btn = document.getElementById('adBtn');
            if (btn.disabled) return;
            btn.disabled = true; btn.textContent = 'লোড হচ্ছে...';
            try {
                await showAd();
                tg.showAlert('অ্যাড দেখা শেষ! +10 কয়েন');
            } catch {
                tg.showAlert('অ্যাড লোড হয়নি');
            } finally {
                btn.textContent = 'দেখুন';
                btn.disabled = false;
            }
        };

        function startCooldown(last) {
            const cd = document.getElementById('cooldown');
            cd.classList.remove('hidden');
            const i = setInterval(() => {
                const left = 60 - Math.floor((Date.now() - last) / 1000);
                if (left <= 0) { clearInterval(i); cd.classList.add('hidden'); return; }
                document.getElementById('timer').textContent = left + ' সেকেন্ড';
                document.getElementById('bar').style.width = (60 - left) * 1.666 + '%';
            }, 100);
        }

        // Leaderboard, History, Redeem, Copy, Tab (আগের মতোই)
        function loadLeaderboard() { /* ... same as before ... */ }
        function loadHistory() { /* ... same as before ... */ }
        // ... (বাকি কোড আগের মতোই — স্পেসের জন্য কাটা হয়েছে)

        // Copy
        document.getElementById('copyBtn').onclick = () => {
            navigator.clipboard.writeText(document.getElementById('refLink').textContent);
            tg.showAlert('কপি হয়েছে!');
        };

        // Tab Switch
        document.querySelectorAll('.navBtn').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('.navBtn').forEach(x => x.classList.remove('text-blue-600'));
                b.classList.add('text-blue-600');
                ['earn', 'redeem', 'feed'].forEach(t => {
                    document.getElementById('tab-' + t).classList.toggle('hidden', b.dataset.tab !== t);
                });
            };
        });

        init();
    </script>
</body>
</html>
