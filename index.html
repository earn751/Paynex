<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiGrip - কয়েন উপার্জন করুন</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* কাস্টম CSS এবং ফন্ট */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            color: #1f2937;
            touch-action: manipulation;
        }
        /* হেডার গ্রেডিয়েন্ট */
        .header-bg {
            background-image: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
        }
        /* ট্রানজিশন এবং শ্যাডো */
        .nav-link { transition: color 0.2s, transform 0.2s; }
        .card-shadow { box-shadow: 0 5px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* bKash/Nagad রং */
        .bKash-color { background-color: #e2136e; }
        .Nagad-color { background-color: #f6941d; }
        .bKash-color-btn { background-color: #e2136e; }
        .Nagad-color-btn { background-color: #f6941d; }

        /* রিডিম কার্ড স্টাইল */
        .redeem-offer-card {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="p" width="10" height="10" patternUnits="userSpaceOnUse"><circle cx="1" cy="1" r=".5" fill="rgba(255,255,255,0.2)"/></pattern></defs><rect width="100" height="100" fill="url(%23p)"/></svg>');
            background-size: 10px 10px;
        }

    </style>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Monetag SDK Simulation (Replace with actual script from your Monetag dashboard) -->
    <script>
        // Monetag SDK Simulation: আসল Monetag SDK লোড হওয়ার পর এই ফাংশনটি কাজ করবে
        function show_10087307() {
            return new Promise(resolve => {
                setTimeout(() => {
                    console.log("Monetag Ad Simulated: Success");
                    resolve();
                }, 5000); // 5 সেকেন্ড বিজ্ঞাপন প্রদর্শন সিমুলেশন
            });
        }
    </script>
</head>
<body class="min-h-screen flex flex-col">

    <div id="app" class="flex flex-col flex-grow">
        <!-- লোডিং স্ক্রিন -->
        <div id="loading" class="absolute inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
            <svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-white text-lg">ডাটা লোড হচ্ছে...</p>
        </div>

        <!-- হেডার -->
        <header id="header" class="header-bg text-white p-4 rounded-b-xl shadow-lg transition-all duration-300">
            <div class="flex items-center space-x-4">
                <img id="profile-pic" class="w-12 h-12 rounded-full border-2 border-yellow-400 object-cover" src="https://placehold.co/48x48/6b7280/ffffff?text=U" onerror="this.onerror=null; this.src='https://placehold.co/48x48/6b7280/ffffff?text=U';" alt="Profile">
                <div class="flex-grow">
                    <p class="text-lg font-bold truncate" id="user-name">ইউজার নাম</p>
                    <p class="text-xs text-gray-300 truncate" id="user-uid">UID: 123456789</p>
                </div>
            </div>
            <div class="mt-3 flex items-center justify-between">
                <div class="flex items-baseline space-x-1">
                    <span class="text-3xl font-extrabold text-yellow-300" id="user-coins">0</span>
                    <span class="text-sm font-medium">কয়েন</span>
                </div>
                <div id="tier-badge" class="px-3 py-1 text-sm font-semibold rounded-full bg-gray-500 text-white">Bronze Tier</div>
            </div>
        </header>

        <!-- মূল কন্টেন্ট (ট্যাব) -->
        <main class="p-4 flex-grow overflow-y-auto" id="main-content">

            <!-- 1. Redeem Tab -->
            <div id="tab-redeem" class="tab-content" style="display:none;">
                <h2 class="text-xl font-bold mb-4 text-gray-800">কয়েন রিডিম</h2>

                <!-- bKash Offers Section -->
                <h3 class="text-lg font-bold text-gray-800 mb-3">bKash অফার</h3>
                <div class="space-y-4 mb-8" id="bKash-offers">
                    <!-- Offer 1: 1000C = 100৳ -->
                    <div class="redeem-offer-card bKash-color p-0 rounded-xl card-shadow overflow-hidden">
                        <div class="text-center py-4 px-6">
                            <p class="text-5xl font-extrabold text-white">৳100</p>
                        </div>
                        <div class="bg-white p-4 flex justify-between items-center text-gray-800">
                            <div class="flex flex-col">
                                <span class="text-xs font-semibold uppercase text-red-600">bKash</span>
                                <span class="text-sm font-bold">1,000 কয়েনে রিডিম</span>
                            </div>
                            <button data-type="bKash" data-coins="1000" data-amount="100" class="redeem-btn bKash-color-btn text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                রিডিম
                            </button>
                        </div>
                    </div>

                    <!-- Offer 2: 10000C = 1500৳ -->
                    <div class="redeem-offer-card bKash-color p-0 rounded-xl card-shadow overflow-hidden">
                        <div class="text-center py-4 px-6">
                            <p class="text-5xl font-extrabold text-white">৳1500</p>
                        </div>
                        <div class="bg-white p-4 flex justify-between items-center text-gray-800">
                            <div class="flex flex-col">
                                <span class="text-xs font-semibold uppercase text-red-600">bKash</span>
                                <span class="text-sm font-bold">10,000 কয়েনে রিডিম</span>
                            </div>
                            <button data-type="bKash" data-coins="10000" data-amount="1500" class="redeem-btn bKash-color-btn text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                রিডিম
                            </button>
                        </div>
                    </div>

                    <!-- Offer 3: 20000C = 3000৳ -->
                    <div class="redeem-offer-card bKash-color p-0 rounded-xl card-shadow overflow-hidden">
                        <div class="text-center py-4 px-6">
                            <p class="text-5xl font-extrabold text-white">৳3000</p>
                        </div>
                        <div class="bg-white p-4 flex justify-between items-center text-gray-800">
                            <div class="flex flex-col">
                                <span class="text-xs font-semibold uppercase text-red-600">bKash</span>
                                <span class="text-sm font-bold">20,000 কয়েনে রিডিম</span>
                            </div>
                            <button data-type="bKash" data-coins="20000" data-amount="3000" class="redeem-btn bKash-color-btn text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                রিডিম
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Nagad Offers Section -->
                <h3 class="text-lg font-bold text-gray-800 mb-3 mt-6">Nagad অফার</h3>
                <div class="space-y-4" id="Nagad-offers">
                    <!-- Offer 1: 1000C = 100৳ -->
                    <div class="redeem-offer-card Nagad-color p-0 rounded-xl card-shadow overflow-hidden">
                        <div class="text-center py-4 px-6">
                            <p class="text-5xl font-extrabold text-white">৳100</p>
                        </div>
                        <div class="bg-white p-4 flex justify-between items-center text-gray-800">
                            <div class="flex flex-col">
                                <span class="text-xs font-semibold uppercase text-yellow-600">Nagad</span>
                                <span class="text-sm font-bold">1,000 কয়েনে রিডিম</span>
                            </div>
                            <button data-type="Nagad" data-coins="1000" data-amount="100" class="redeem-btn Nagad-color-btn text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                রিডিম
                            </button>
                        </div>
                    </div>

                    <!-- Offer 2: 10000C = 1500৳ -->
                    <div class="redeem-offer-card Nagad-color p-0 rounded-xl card-shadow overflow-hidden">
                        <div class="text-center py-4 px-6">
                            <p class="text-5xl font-extrabold text-white">৳1500</p>
                        </div>
                        <div class="bg-white p-4 flex justify-between items-center text-gray-800">
                            <div class="flex flex-col">
                                <span class="text-xs font-semibold uppercase text-yellow-600">Nagad</span>
                                <span class="text-sm font-bold">10,000 কয়েনে রিডিম</span>
                            </div>
                            <button data-type="Nagad" data-coins="10000" data-amount="1500" class="redeem-btn Nagad-color-btn text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                রিডিম
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Redeem History -->
                <h3 class="text-lg font-semibold mt-8 mb-3 text-gray-800 border-b pb-1">রিডিম ইতিহাস</h3>
                <div id="redeem-history" class="space-y-2">
                    <p class="text-gray-500 text-sm">কোনো রিডিম রিকোয়েস্ট নেই।</p>
                </div>
            </div>

            <!-- 2. Earn Tab -->
            <div id="tab-earn" class="tab-content" style="display:block;">
                <h2 class="text-xl font-bold mb-4 text-gray-800">কয়েন উপার্জন করুন</h2>

                <!-- Monetag Ad Card -->
                <div class="bg-white p-5 rounded-xl card-shadow mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <p class="text-lg font-semibold text-gray-800">ভিডিও বিজ্ঞাপন দেখুন</p>
                        <span class="text-green-600 font-bold">+10 কয়েন</span>
                    </div>
                    <button id="ad-button" class="w-full py-3 rounded-lg text-white font-bold transition duration-300 disabled:opacity-50" style="background-color:#3b82f6;">
                        বিজ্ঞাপন দেখুন
                    </button>
                    <div id="ad-cooldown" class="mt-3 text-center text-sm text-gray-500" style="display:none;">
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1">
                            <div id="cooldown-progress" class="bg-red-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <span id="cooldown-timer">১ মিনিট কুলডাউন...</span>
                    </div>
                </div>

                <!-- Referral Card -->
                <div class="bg-white p-5 rounded-xl card-shadow">
                    <p class="text-lg font-semibold text-gray-800 mb-3">বন্ধুদের রেফার করুন</p>
                    <p class="text-sm text-gray-600 mb-4">আপনার লিঙ্কে জয়েন করলে এবং প্রথম অ্যাড দেখলে, আপনি ও আপনার বন্ধু দুজনেই পাবেন <span class="text-green-600 font-bold">+50 কয়েন</span>।</p>

                    <div class="flex items-center justify-between bg-gray-100 p-3 rounded-lg mb-4">
                        <p class="text-sm font-medium truncate" id="referral-code">ref_...</p>
                        <button id="copy-referral-btn" class="text-blue-600 text-sm font-semibold ml-3 active:text-blue-800">কপি</button>
                    </div>

                    <p class="text-sm font-medium text-gray-800">আপনার রেফার সংখ্যা: <span id="referral-count" class="font-bold text-blue-600">0</span></p>
                    <p id="redeem-lock-status" class="text-xs mt-1 text-red-500 font-medium hidden">রিডিম করতে আরও <span id="ref-needed">5</span> জনকে রেফার করুন।</p>

                </div>
            </div>

            <!-- 3. Feed Tab -->
            <div id="tab-feed" class="tab-content" style="display:none;">
                <h2 class="text-xl font-bold mb-4 text-gray-800">লাইভ ফিড ও লিডারবোর্ড</h2>

                <!-- Leaderboard -->
                <div class="bg-white p-5 rounded-xl card-shadow mb-6">
                    <p class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">শীর্ষ উপার্জনকারী (টপ ৫)</p>
                    <div id="leaderboard-list" class="space-y-3">
                        <p class="text-gray-500 text-sm">লিডারবোর্ড লোড হচ্ছে...</p>
                    </div>
                </div>

                <!-- Admin Posts -->
                <div class="bg-white p-5 rounded-xl card-shadow">
                    <p class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">অ্যাডমিন আপডেট</p>
                    <p class="text-gray-500 text-sm">এখানে অ্যাডমিন থেকে আসা গুরুত্বপূর্ণ পোস্ট ও আপডেট দেখা যাবে।</p>
                </div>
            </div>

        </main>

        <!-- Redeem Modal -->
        <div id="redeem-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-40 transition-opacity duration-300">
            <div class="bg-white w-full max-w-md rounded-xl shadow-2xl transform scale-95 transition-transform duration-300">
                <div id="modal-header" class="p-4 rounded-t-xl text-white flex justify-between items-center bKash-color">
                    <h3 class="text-xl font-bold" id="modal-title">রিডিম ফর্ম</h3>
                    <button id="close-modal-btn" class="p-1 rounded-full hover:bg-white hover:bg-opacity-20 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="redeem-form" class="p-6">
                    <p class="text-sm font-medium mb-4 text-gray-600" id="redeem-type-info">আপনি bKash-এর মাধ্যমে <span class="font-bold text-lg text-green-600">৳100</span> রিডিম করছেন।</p>
                    
                    <input type="hidden" id="modal-coins" value="0">
                    <input type="hidden" id="modal-amount" value="0">
                    <input type="hidden" id="modal-type" value="">

                    <!-- Target Number -->
                    <label class="block text-sm font-medium text-gray-700 mb-2">আপনার মোবাইল নাম্বার</label>
                    <input type="text" id="target-number" required pattern="[0-9]{11}" placeholder="১১ ডিজিটের নাম্বার" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">

                    <button type="submit" id="final-redeem-btn" class="w-full py-3 rounded-lg text-white font-bold transition duration-300 disabled:opacity-50 bKash-color-btn">
                        রিডিম রিকোয়েস্ট পাঠান
                    </button>
                    <p id="redeem-error" class="text-sm text-red-500 mt-3 text-center hidden">ত্রুটি: আপনার পর্যাপ্ত কয়েন বা রেফার নেই।</p>
                </form>
            </div>
        </div>

        <!-- বটম নেভিগেশন -->
        <nav class="bg-white border-t border-gray-200 sticky bottom-0 z-10 shadow-lg">
            <div class="flex justify-around py-2">
                <button data-tab="redeem" class="nav-link flex flex-col items-center p-2 text-gray-500 active:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-2.485 0-4 .933-4 2.5v.5H7a2 2 0 00-2 2v3a2 2 0 002 2h10a2 2 0 002-2v-3a2 2 0 00-2-2h-1v-.5c0-1.567-1.515-2.5-4-2.5z" />
                    </svg>
                    <span class="text-xs mt-1">রিডিম</span>
                </button>
                <button data-tab="earn" class="nav-link flex flex-col items-center p-2 text-blue-600 active:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                    </svg>
                    <span class="text-xs mt-1">উপার্জন</span>
                </button>
                <button data-tab="feed" class="nav-link flex flex-col items-center p-2 text-gray-500 active:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                    <span class="text-xs mt-1">ফিড</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
        // #################################################
        // # টেলিগ্রাম মিনি অ্যাপ ফ্রন্টএন্ড লজিক (JavaScript) #
        // #################################################

        // গ্লোবাল স্টেট
        const STATE = {
            user: {},
            coins: 0,
            referral_count: 0,
            tier: 'Bronze',
            last_ad: 0,
            is_earning_cooldown: false,
            // এখানে আপনার ব্যাকএন্ড URL দিন
            API_URL: 'https://your-backend-url.onrender.com/api' // ডেপ্লয় করার সময় এটি পরিবর্তন করুন
        };

        const tg = window.Telegram.WebApp;

        // --- ইউটিলিটি ফাংশন ---

        /** টেলিগ্রাম অ্যালার্ট */
        const showAlert = (message) => {
            if (tg) {
                tg.showAlert(message);
            } else {
                console.warn("Telegram WebApp not available. Alert:", message);
                alert(message); // লোকাল টেস্টিং এর জন্য ফলব্যাক
            }
        }

        /** এপিআই ফেচ হেল্পার */
        const apiFetch = async (endpoint, method = 'GET', data = null) => {
            const url = `${STATE.API_URL}${endpoint}`;
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${tg.initData || 'local-test-token'}` // initData ব্যবহার করে অথেনটিকেশন
                },
            };
            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'API Error');
                }
                return await response.json();
            } catch (error) {
                console.error(`API Error on ${endpoint}:`, error.message);
                showAlert(`API ত্রুটি: ${error.message}`);
                throw error;
            }
        };

        /** ইউজার টিয়ার গণনা */
        const getTier = (coins) => {
            if (coins >= 5000) return 'Gold';
            if (coins >= 1000) return 'Silver';
            return 'Bronze';
        }

        /** ইউআই রেন্ডারিং */
        const renderUI = () => {
            const { user, coins, referral_count, tier } = STATE;

            // ১. হেডার ও প্রোফাইল
            document.getElementById('profile-pic').src = user.photo_url || 'https://placehold.co/48x48/6b7280/ffffff?text=U';
            document.getElementById('user-name').textContent = `${user.first_name || ''} ${user.last_name || ''}`;
            document.getElementById('user-uid').textContent = `UID: ${user.id}`;
            document.getElementById('user-coins').textContent = coins.toLocaleString('en-US');

            // ২. টিয়ার ব্যাজ
            const tierBadge = document.getElementById('tier-badge');
            tierBadge.textContent = `${tier} Tier`;
            tierBadge.className = 'px-3 py-1 text-sm font-semibold rounded-full transition-colors duration-300';
            if (tier === 'Gold') {
                tierBadge.classList.add('bg-yellow-500', 'text-gray-900');
            } else if (tier === 'Silver') {
                tierBadge.classList.add('bg-gray-400', 'text-white');
            } else {
                tierBadge.classList.add('bg-amber-800', 'text-white');
            }

            // ৩. আর্ন ট্যাব
            document.getElementById('referral-code').textContent = `t.me/HiGriP_bot?start=ref_${user.id}`;
            document.getElementById('referral-count').textContent = referral_count;

            // ৪. রিডিম লক স্ট্যাটাস (Hidden check)
            const refNeeded = 5 - referral_count;
            if (refNeeded > 0) {
                document.getElementById('redeem-lock-status').classList.remove('hidden');
                document.getElementById('ref-needed').textContent = refNeeded;
            } else {
                document.getElementById('redeem-lock-status').classList.add('hidden');
            }

            // রিডিম বাটনের অবস্থা আপডেট করুন
            document.querySelectorAll('.redeem-btn').forEach(btn => {
                const coinsRequired = parseInt(btn.getAttribute('data-coins'), 10);
                if (STATE.referral_count < 5) {
                    btn.disabled = false; // এখানে ফলস রাখছি কারণ লকের মেসেজটাshowAlert দিয়ে দেব
                    btn.classList.add('opacity-50', 'cursor-pointer');
                    btn.textContent = 'লকড';
                } else if (STATE.coins < coinsRequired) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50');
                    btn.textContent = 'কয়েন কম';
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                    btn.textContent = 'রিডিম';
                }
            });
        }

        /** অ্যাপ ইনিশিয়ালাইজেশন */
        const initApp = async () => {
            // ১. ফুল স্ক্রিন
            tg.ready();
            tg.expand();
            tg.MainButton.hide();

            // ২. ইউজার ডেটা
            const unsafeUser = tg.initDataUnsafe.user;
            if (!unsafeUser) {
                document.getElementById('loading').innerHTML = '<p class="text-white text-lg">Telegram ব্যবহারকারী ডেটা পাওয়া যায়নি।</p>';
                return;
            }
            STATE.user = unsafeUser;

            // ৩. রেফারেল কোড চেক
            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('start');
            let referred_by = null;
            if (startParam && startParam.startsWith('ref_')) {
                referred_by = startParam.substring(4);
            }

            // ৪. এপিআই কল টু ইনিশিয়ালাইজ
            try {
                const initData = await apiFetch('/init', 'POST', {
                    initData: tg.initData,
                    referred_by: referred_by,
                    user_info: {
                        uid: unsafeUser.id,
                        username: unsafeUser.username,
                        first_name: unsafeUser.first_name,
                        last_name: unsafeUser.last_name,
                        photo_url: unsafeUser.photo_url
                    }
                });

                STATE.coins = initData.coins || 0;
                STATE.referral_count = initData.referral_count || 0;
                STATE.last_ad = initData.last_ad || 0;
                STATE.tier = getTier(STATE.coins);

                renderUI();
                await fetchLeaderboard();
                await fetchRedeemHistory();
                checkAdCooldown();

            } catch (error) {
                console.error("Initialization Failed:", error);
            } finally {
                // ৫. লোডিং স্ক্রিন হাইড
                document.getElementById('loading').style.opacity = '0';
                setTimeout(() => document.getElementById('loading').style.display = 'none', 300);
            }
        }

        // --- বিজ্ঞাপন উপার্জনের লজিক ---

        const adButton = document.getElementById('ad-button');
        const adCooldownDiv = document.getElementById('ad-cooldown');
        const cooldownProgress = document.getElementById('cooldown-progress');
        const cooldownTimerText = document.getElementById('cooldown-timer');

        const AD_COOLDOWN_SECONDS = 60; // ১ মিনিট
        const AD_PROCESS_SECONDS = 30; // ৩০ সেকেন্ড প্রোগ্রেস বার

        let cooldownInterval;

        const checkAdCooldown = () => {
            const now = Date.now();
            const lastAdTime = STATE.last_ad;
            const elapsed = (now - lastAdTime) / 1000;
            const remaining = AD_COOLDOWN_SECONDS - elapsed;

            clearInterval(cooldownInterval);

            if (remaining > 0) {
                STATE.is_earning_cooldown = true;
                adButton.disabled = true;
                adButton.textContent = 'কুলডাউনে আছে...';
                adCooldownDiv.style.display = 'block';

                const updateTimer = () => {
                    const currentRemaining = Math.max(0, AD_COOLDOWN_SECONDS - ((Date.now() - lastAdTime) / 1000));
                    if (currentRemaining <= 0) {
                        clearInterval(cooldownInterval);
                        STATE.is_earning_cooldown = false;
                        adButton.disabled = false;
                        adButton.textContent = 'বিজ্ঞাপন দেখুন';
                        adCooldownDiv.style.display = 'none';
                        return;
                    }
                    cooldownTimerText.textContent = ` ${Math.ceil(currentRemaining)} সেকেন্ড বাকি`;
                    const percentage = (currentRemaining / AD_COOLDOWN_SECONDS) * 100;
                    cooldownProgress.style.width = `${100 - percentage}%`;
                };

                updateTimer();
                cooldownInterval = setInterval(updateTimer, 1000);

            } else {
                STATE.is_earning_cooldown = false;
                adButton.disabled = false;
                adButton.textContent = 'বিজ্ঞাপন দেখুন';
                adCooldownDiv.style.display = 'none';
            }
        }

        const handleAdWatch = async () => {
            if (STATE.is_earning_cooldown) return;

            adButton.disabled = true;
            adButton.textContent = 'বিজ্ঞাপন লোড হচ্ছে...';

            try {
                // ১. ৩০ সেকেন্ড প্রোগ্রেস বার
                adCooldownDiv.style.display = 'block';
                cooldownTimerText.textContent = 'বিজ্ঞাপন চলছে, ৩০ সেকেন্ড অপেক্ষা করুন...';

                const startTime = Date.now();
                const progressInterval = setInterval(() => {
                    const elapsed = (Date.now() - startTime) / 1000;
                    const progress = Math.min(100, (elapsed / AD_PROCESS_SECONDS) * 100);
                    cooldownProgress.style.width = `${progress}%`;
                }, 100);

                // ২. Monetag ফাংশন কল
                await show_10087307();
                clearInterval(progressInterval);
                cooldownProgress.style.width = '100%'; 

                // ৩. ব্যাকএন্ডে সফলতার নোটিফিকেশন পাঠান
                const result = await apiFetch('/earn', 'POST', {
                    uid: STATE.user.id,
                    reward: 10 
                });

                // ৪. স্টেট এবং ইউআই আপডেট
                STATE.coins = result.new_coins;
                STATE.referral_count = result.referral_count; 
                STATE.last_ad = Date.now();
                STATE.tier = getTier(STATE.coins);

                renderUI();
                checkAdCooldown();

                showAlert(`বিজ্ঞাপন দেখা সফল! আপনি ${result.earned_coins} কয়েন পেয়েছেন।`);

            } catch (error) {
                console.error("Ad earning failed:", error);
                adButton.textContent = 'বিজ্ঞাপন দেখুন';
                adButton.disabled = false;
                adCooldownDiv.style.display = 'none';
            }
        }

        // --- রিডিম লজিক ---

        const redeemModal = document.getElementById('redeem-modal');
        const modalHeader = document.getElementById('modal-header');
        const modalTitle = document.getElementById('modal-title');
        const redeemTypeInfo = document.getElementById('redeem-type-info');
        const finalRedeemBtn = document.getElementById('final-redeem-btn');
        const redeemError = document.getElementById('redeem-error');
        const redeemForm = document.getElementById('redeem-form');
        const modalCoinsInput = document.getElementById('modal-coins');
        const modalAmountInput = document.getElementById('modal-amount');
        const modalTypeInput = document.getElementById('modal-type');


        const openRedeemModal = (type, coins, amount) => {
            const coinsRequired = parseInt(coins, 10);

            // ১. রেফারেল লক চেক
            if (STATE.referral_count < 5) {
                showAlert("কমপক্ষে ৫ জনকে রেফার করুন!");
                return;
            }
            // ২. পর্যাপ্ত কয়েন চেক
            if (STATE.coins < coinsRequired) {
                showAlert(`আপনার পর্যাপ্ত কয়েন (${coinsRequired.toLocaleString()}) নেই!`);
                return;
            }

            // ৩. মোডাল সেটআপ
            modalCoinsInput.value = coins;
            modalAmountInput.value = amount;
            modalTypeInput.value = type;

            redeemError.classList.add('hidden');
            redeemModal.classList.remove('hidden');
            document.querySelector('#redeem-modal > div').classList.remove('scale-95');
            
            // ৪. রঙ ও টেক্সট সেটআপ
            let headerColorClass, btnColorClass;

            if (type === 'bKash') {
                headerColorClass = 'bKash-color';
                btnColorClass = 'bKash-color-btn';
                modalTitle.textContent = 'bKash রিডিম রিকোয়েস্ট';
            } else if (type === 'Nagad') {
                headerColorClass = 'Nagad-color';
                btnColorClass = 'Nagad-color-btn';
                modalTitle.textContent = 'Nagad রিডিম রিকোয়েস্ট';
            }

            modalHeader.className = `p-4 rounded-t-xl text-white flex justify-between items-center ${headerColorClass}`;
            finalRedeemBtn.className = `w-full py-3 rounded-lg text-white font-bold transition duration-300 disabled:opacity-50 ${btnColorClass}`;
            redeemTypeInfo.innerHTML = `আপনি ${type}-এর মাধ্যমে <span class="font-bold text-lg text-white p-1 rounded-md ${headerColorClass}">৳${amount.toLocaleString()}</span> রিডিম করছেন। এর জন্য আপনার ${coins.toLocaleString()} কয়েন কাটা হবে।`;

            finalRedeemBtn.disabled = false;
            finalRedeemBtn.textContent = 'রিডিম রিকোয়েস্ট পাঠান';
        }

        const closeRedeemModal = () => {
            document.querySelector('#redeem-modal > div').classList.add('scale-95');
            setTimeout(() => redeemModal.classList.add('hidden'), 300);
        }

        const handleRedeemRequest = async (e) => {
            e.preventDefault();
            
            const coins = parseInt(modalCoinsInput.value, 10);
            const amount = parseInt(modalAmountInput.value, 10);
            const redeemType = modalTypeInput.value;
            const targetNumber = document.getElementById('target-number').value.trim();

            if (STATE.referral_count < 5 || STATE.coins < coins) {
                showAlert("রিডিম শর্ত পূরণ হয়নি।");
                return;
            }
            
            finalRedeemBtn.disabled = true;
            finalRedeemBtn.textContent = 'প্রসেসিং...';
            redeemError.classList.add('hidden');

            try {
                const result = await apiFetch('/redeem', 'POST', {
                    uid: STATE.user.id,
                    type: redeemType,
                    coins: coins,
                    amount: amount,
                    number: targetNumber
                });

                STATE.coins = result.new_coins;
                STATE.tier = getTier(STATE.coins);
                renderUI();
                await fetchRedeemHistory();

                showAlert("আপনার রিডিম রিকোয়েস্ট সফলভাবে জমা হয়েছে।");
                closeRedeemModal();

            } catch (error) {
                redeemError.textContent = `ত্রুটি: ${error.message}`;
                redeemError.classList.remove('hidden');
            } finally {
                finalRedeemBtn.disabled = false;
                finalRedeemBtn.textContent = 'রিডিম রিকোয়েস্ট পাঠান';
            }
        }

        // --- লিডারবোর্ড ও ইতিহাস ---

        const fetchLeaderboard = async () => {
            try {
                const data = await apiFetch('/leaderboard');
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = '';
                
                if (data.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-sm">কোনো ডেটা পাওয়া যায়নি।</p>';
                    return;
                }

                data.forEach((user, index) => {
                    const tier = getTier(user.coins);
                    const tierClass = tier === 'Gold' ? 'bg-yellow-500' : tier === 'Silver' ? 'bg-gray-400' : 'bg-amber-800';
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg';
                    item.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span class="font-bold text-lg text-gray-600 w-6 text-center">${index + 1}.</span>
                            <span class="font-semibold truncate">${user.name}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-blue-600 font-bold">${user.coins.toLocaleString()}</span>
                            <span class="px-2 py-0.5 text-xs font-semibold rounded-full text-white ${tierClass}">${tier}</span>
                        </div>
                    `;
                    list.appendChild(item);
                });

            } catch (error) {
                document.getElementById('leaderboard-list').innerHTML = '<p class="text-red-500 text-sm">লিডারবোর্ড লোড করা যায়নি।</p>';
            }
        }
        
        const fetchRedeemHistory = async () => {
            try {
                const result = await apiFetch(`/redeem-history?uid=${STATE.user.id}`);
                const historyList = document.getElementById('redeem-history');
                historyList.innerHTML = '';

                if (!result.history || result.history.length === 0) {
                    historyList.innerHTML = '<p class="text-gray-500 text-sm">কোনো রিডিম রিকোয়েস্ট নেই।</p>';
                    return;
                }

                result.history.forEach(item => {
                    const statusColor = item.status === 'Pending' ? 'text-yellow-600' : 'text-green-600';
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
                    itemDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.type} - ৳${item.amount.toLocaleString()}</p>
                            <p class="text-xs text-gray-500">${new Date(item.date).toLocaleDateString('bn-BD')}</p>
                        </div>
                        <div class="text-sm font-medium ${statusColor}">${item.status}</div>
                    `;
                    historyList.appendChild(itemDiv);
                });

            } catch (error) {
                document.getElementById('redeem-history').innerHTML = '<p class="text-red-500 text-sm">ইতিহাস লোড করা যায়নি।</p>';
            }
        }


        // --- ইভেন্ট লিসেনার্স ---

        const switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('text-blue-600', 'active'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.add('text-gray-500'));

            document.getElementById(`tab-${tabName}`).style.display = 'block';
            const activeLink = document.querySelector(`.nav-link[data-tab="${tabName}"]`);
            activeLink.classList.remove('text-gray-500');
            activeLink.classList.add('text-blue-600', 'active');
            
            if (tabName === 'feed') {
                 fetchLeaderboard();
            }
            if (tabName === 'redeem') {
                 fetchRedeemHistory();
                 renderUI(); // রিডিম বাটন স্ট্যাটাস নিশ্চিত করার জন্য
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // নেভিগেশন
            document.querySelectorAll('.nav-link').forEach(button => {
                button.addEventListener('click', () => switchTab(button.getAttribute('data-tab')));
            });

            // Ad Button
            adButton.addEventListener('click', handleAdWatch);

            // রিডিম বাটন (নতুন কার্ডে)
            document.querySelectorAll('.redeem-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.getAttribute('data-type');
                    const coins = btn.getAttribute('data-coins');
                    const amount = btn.getAttribute('data-amount');
                    openRedeemModal(type, coins, amount);
                });
            });

            // রিডিম মোডাল বন্ধ
            document.getElementById('close-modal-btn').addEventListener('click', closeRedeemModal);
            
            // রিডিম ফর্ম সাবমিট
            redeemForm.addEventListener('submit', handleRedeemRequest);

            // রেফারেল লিঙ্ক কপি
            document.getElementById('copy-referral-btn').addEventListener('click', () => {
                const refCode = document.getElementById('referral-code').textContent;
                const tempInput = document.createElement('input');
                tempInput.value = refCode;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    showAlert("রেফার লিঙ্ক কপি হয়েছে!");
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    showAlert("কপি ব্যর্থ হয়েছে, ম্যানুয়ালি কপি করুন।");
                }
                document.body.removeChild(tempInput);
            });

            // অ্যাপ ইনিশিয়ালাইজেশন
            if (tg) {
                initApp();
            } else {
                // ফলব্যাক (লোকাল টেস্টিং)
                console.error("Telegram WebApp not found. Using dummy data.");
                STATE.user = { id: 123456789, first_name: 'টেস্ট', last_name: 'ইউজার', username: 'testuser', photo_url: 'https://placehold.co/48x48/6b7280/ffffff?text=T' };
                STATE.coins = 12000; // টেস্টের জন্য পর্যাপ্ত কয়েন
                STATE.referral_count = 6; // টেস্টের জন্য রেফার লক আনলক
                STATE.tier = getTier(STATE.coins);
                renderUI();
                document.getElementById('loading').style.display = 'none';
                STATE.API_URL = 'http://localhost:3000/api'; // লোকাল সার্ভার এড্রেস
            }
        });

    </script>
</body>
</html>
